<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard 5W1H - Impact 360</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/responsive-mobile-framework.css') }}">
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <style>
        /* Page Header with subtle gradient */
        .page-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%);
            color: white;
            padding: 1.25rem 0.75rem;
            margin: -1rem -15px 1rem -15px;
            border-radius: 0 0 12px 12px;
        }

        /* Search and Filter Section - Selaras dengan filter-section tabelkpictp.html */
        .search-filter-section {
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            margin-bottom: 2rem;
            border: none;
        }

        .search-input {
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 0.75rem 1rem;
            font-size: 0.95rem;
            transition: all 0.3s ease;
        }

        .search-input:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }

        .filter-select {
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 0.75rem 1rem;
            font-size: 0.95rem;
            transition: all 0.3s ease;
        }

        .filter-select:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }

        .filter-label {
            font-size: 0.75rem;
            font-weight: 600;
            color: #6c757d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.25rem;
            display: block;
        }

        /* Clean form controls (CTP style) */
        .form-control-clean {
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 0.6rem 0.75rem;
            transition: all 0.2s ease;
            background: #fff;
        }
        .form-control-clean:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.15rem rgba(102,126,234,0.12);
            outline: none;
        }

        /* Minimal clean table, tuned to CTP table look */
        .table-5w1h {
            border-collapse: collapse;
            background: #fff;
            font-size: 0.95rem;
        }

        /* Container like tabelkpictp: white card, rounded, shadow */
        .table-5w1h-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.06);
            overflow: hidden;
        }

        .table-5w1h thead th {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: none;
            font-weight: 600;
            color: #495057;
            padding: 0.85rem 0.75rem;
            vertical-align: middle;
        }

        .table-5w1h tbody td {
            vertical-align: middle;
            padding-top: 0.65rem;
            padding-bottom: 0.65rem;
            border-top: 1px solid #f3f4f6;
            color: #4b5563;
        }

        .status-pill {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 999px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: capitalize;
        }

        .status-pill.draft { background: #fff1f2; color: #b91c1c; }
        .status-pill.open { background: #e8f0ff; color: #1e3a8a; }
        .status-pill.closed { background: #ecfdf5; color: #166534; }

        /* Pagination styling (CTP style) */
        .pagination-5w1h {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 6px;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .pagination-5w1h .page-item .page-link {
            border: 2px solid #e9ecef;
            color: #6c757d;
            border-radius: 8px;
            padding: 0.5rem 0.75rem;
            transition: all 0.2s ease;
            background: white;
            font-weight: 500;
        }

        .pagination-5w1h .page-item .page-link:hover {
            border-color: #667eea;
            color: #667eea;
            background-color: rgba(102,126,234,0.08);
        }

        .pagination-5w1h .page-item.active .page-link {
            background: #667eea;
            border-color: #667eea;
            color: white;
        }

        .pagination-5w1h .page-item.disabled .page-link {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Pagination info text */
        .pagination-info {
            text-align: center;
            font-size: 0.85rem;
            color: #6c757d;
            margin-bottom: 1rem;
        }

        /* Responsive tweaks */
        @media (max-width: 768px) {
            .table-5w1h thead { display: none; }
            .table-5w1h tbody td { display: block; width: 100%; }
            .table-5w1h tbody tr { display: block; margin-bottom: 0.75rem; border: 1px solid #eef2ff; border-radius: 8px; padding: 0.5rem; }
            .table-5w1h tbody td .cell-label { display: inline-block; width: 30%; font-weight: 700; color: #111827; }
            .table-5w1h tbody td .cell-value { display: inline-block; width: 70%; }
        }
    </style>
</head>
<body>
<div id="wrapper">
    {% include '_top_header.html' %}
    <div class="d-flex" id="content-wrapper">
        {% include '_sidebar.html' %}
        <div id="page-content-wrapper">
            <div class="container-fluid pt-3">
                <!-- Page Header -->
                <div class="page-header">
                    <div class="container-fluid">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h2 class="mb-1 text-white">Dashboard 5W1H</h2>
                                <p class="mb-0 opacity-75">Daftar seluruh entri 5W1H</p>
                            </div>
                            <div class="text-end">
                                <a href="{{ url_for('tools_5w1h.input_5w1h') }}" class="btn btn-light" style="border-radius:25px; font-weight:600;">
                                    <i class="fas fa-plus-circle me-1"></i> Input 5W1H
                                </a>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Search and Filter Section -->
                <div class="search-filter-section">
                    <div class="row g-3">
                        <div class="col-lg-6 col-md-12">
                            <label class="filter-label"><i class="fas fa-search me-1"></i>Cari</label>
                            <div class="input-group">
                                <span class="input-group-text bg-white" style="border: 2px solid #e9ecef; border-right: none; border-radius: 10px 0 0 10px;">
                                    <i class="fas fa-search"></i>
                                </span>
                                <input id="searchInput" type="text" class="form-control search-input" placeholder="Search title, who..." style="border: 2px solid #e9ecef; border-left: none;">
                                <button class="btn btn-outline-secondary" type="button" id="clearSearch" style="border: 2px solid #e9ecef; border-left: none; border-radius: 0 10px 10px 0;">
                                    <i class="fas fa-times"></i> Clear
                                </button>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6">
                            <label for="statusFilter" class="filter-label"><i class="fas fa-flag me-1"></i>Status</label>
                            <select id="statusFilter" class="form-select filter-select">
                                <option value="all">Semua Status</option>
                                <option value="draft">Draft</option>
                                <option value="open">Open</option>
                                <option value="closed">Closed</option>
                            </select>
                        </div>
                        <div class="col-lg-3 col-md-6">
                            <label for="ownerFilter" class="filter-label"><i class="fas fa-user me-1"></i>Owner</label>
                            <select id="ownerFilter" class="form-select filter-select">
                                <option value="all">Semua Owner</option>
                            </select>
                        </div>
                    </div>
                </div>

                {% if entries %}
                <div class="table-responsive table-5w1h-container">
                    <table id="entriesTable" class="table table-5w1h table-hover adjustment-table table-sm align-middle">
                        <thead>
                            <tr>
                                <th style="width:6%">ID</th>
                                <th>Title</th>
                                <th style="width:18%">Who</th>
                                <th style="width:12%">When</th>
                                <th style="width:12%">Owner</th>
                                <th style="width:10%">Status</th>
                                <th style="width:12%">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody">
                            {% for entry in entries %}
                            <tr class="table-row" data-status="{{ entry.status.name }}">
                                <td class="text-muted">#{{ entry.id }}</td>
                                <td>{{ entry.title }}</td>
                                <td>{{ entry.who|truncate(80) }}</td>
                                <td>{{ entry.when_.strftime('%d %b %Y') }}</td>
                                <td>{{ entry.owner.name if entry.owner else '-' }}</td>
                                <td><span class="status-pill {{ entry.status.name }}">{{ entry.status.value }}</span></td>
                                <td>
                                    <a href="{{ url_for('tools_5w1h.detail_5w1h', entry_id=entry.id) }}" class="btn btn-sm btn-outline-primary me-1" title="Detail"><i class="fas fa-eye"></i></a>
                                    {% if entry.owner_id == current_user.id or current_user.role == 'admin' %}
                                    <a href="{{ url_for('tools_5w1h.edit_5w1h', entry_id=entry.id) }}" class="btn btn-sm btn-outline-success me-1" title="Edit"><i class="fas fa-edit"></i></a>
                                    <button type="button" class="btn btn-sm btn-outline-danger delete-button-5w1h" title="Delete" data-entry-id="{{ entry.id }}" data-entry-title="{{ entry.title }}" data-entry-owner="{{ entry.owner.name if entry.owner else '-' }}"><i class="fas fa-trash"></i></button>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <!-- Pagination Info & Controls -->
                <div class="pagination-info">
                    Menampilkan <span id="pageInfo">1-15</span> dari <span id="totalInfo">{{ entries|length }}</span> entri
                </div>
                <nav aria-label="Pagination">
                    <ul class="pagination pagination-5w1h" id="paginationNav">
                        <!-- Pagination buttons akan di-generate oleh JavaScript -->
                    </ul>
                </nav>
                {% else %}
                <div class="empty-state">
                    <svg width="120" height="120" viewBox="0 0 120 120" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin-bottom: 24px; opacity: 0.5;">
                        <circle cx="60" cy="60" r="50" stroke="#cbd5e1" stroke-width="2"/>
                        <path d="M60 35v50M35 60h50" stroke="#cbd5e1" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                    <h3>Belum Ada Entri 5W1H</h3>
                    <p>Mulai buat entri 5W1H baru dengan mengklik tombol "Input 5W1H" di atas.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Delete 5W1H Entry Modal -->
<div class="modal fade" id="delete5W1HModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Hapus 5W1H</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="delete5W1HId">
                <div class="alert alert-warning d-flex align-items-center" role="alert">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="me-2">
                        <path d="M12 9V13M12 17H12.01M21 12C21 16.9706 16.9706 21 12 21C7.02944 21 3 16.9706 3 12C3 7.02944 7.02944 3 12 3C16.9706 3 21 7.02944 21 12Z" stroke="#f59e0b" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    <div>
                        <strong>Warning:</strong> Tindakan ini tidak dapat dibatalkan. Form akan di hapus secara permanen.
                    </div>
                </div>
                <p>Apakah anda yakin ingin menghapus form 5W1H ini?</p>
                <div class="entry-details-preview" id="delete5W1HPreview">
                    <!-- Entry details will be shown here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                <button type="button" class="btn btn-danger" onclick="confirmDelete5W1H()">Hapus</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/js/all.min.js"></script>
<script src="{{ url_for('static', filename='js/sidebar_handler.js') }}"></script>
<script>
const ROWS_PER_PAGE = 10;
let currentPage = 1;
let allRows = [];
let filteredRows = [];

document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('searchInput');
    const statusFilter = document.getElementById('statusFilter');
    const ownerFilter = document.getElementById('ownerFilter');
    const clearSearchBtn = document.getElementById('clearSearch');
    const table = document.getElementById('entriesTable');
    const tableBody = document.getElementById('tableBody');
    
    if (tableBody) {
        allRows = Array.from(tableBody.querySelectorAll('.table-row'));
    }
    
    // Populate unique owners from table data
    function populateOwnerFilter() {
        const owners = new Set();
        allRows.forEach(row => {
            const ownerCell = row.querySelector('td:nth-child(5)')?.textContent.trim();
            if (ownerCell && ownerCell !== '-') {
                owners.add(ownerCell);
            }
        });
        
        // Sort owners alphabetically
        const sortedOwners = Array.from(owners).sort();
        
        // Add options to dropdown (keep existing "Semua Owner" option)
        sortedOwners.forEach(owner => {
            const option = document.createElement('option');
            option.value = owner;
            option.textContent = owner;
            ownerFilter.appendChild(option);
        });
    }
    
    // Populate on load
    populateOwnerFilter();

    function applyFilters() {
        const term = (searchInput?.value || '').trim().toLowerCase();
        const status = statusFilter?.value || 'all';
        const owner = ownerFilter?.value || 'all';
        
        // Filter rows
        filteredRows = allRows.filter(row => {
            const text = (row.textContent || '').toLowerCase();
            const rowStatus = (row.getAttribute('data-status') || '').toLowerCase();
            const ownerCell = row.querySelector('td:nth-child(5)')?.textContent.trim() || '';
            const matchesSearch = term === '' || text.indexOf(term) !== -1;
            const matchesStatus = status === 'all' || rowStatus === status;
            const matchesOwner = owner === 'all' || ownerCell === owner;
            return matchesSearch && matchesStatus && matchesOwner;
        });
        
        // Reset to page 1 and display
        currentPage = 1;
        displayPage(currentPage);
        updatePagination();
    }

    if (searchInput) searchInput.addEventListener('input', applyFilters);
    if (statusFilter) statusFilter.addEventListener('change', applyFilters);
    if (ownerFilter) ownerFilter.addEventListener('change', applyFilters);
    
    // Clear search button
    if (clearSearchBtn) {
        clearSearchBtn.addEventListener('click', function() {
            searchInput.value = '';
            searchInput.focus();
            applyFilters();
        });
    }
    
    applyFilters();
    
    function displayPage(page) {
        const tableBody = document.getElementById('tableBody');
        if (!tableBody) return;
        
        // Hide all rows
        allRows.forEach(row => row.style.display = 'none');
        
        // Show filtered rows for current page
        const start = (page - 1) * ROWS_PER_PAGE;
        const end = Math.min(start + ROWS_PER_PAGE, filteredRows.length);
        
        for (let i = start; i < end; i++) {
            filteredRows[i].style.display = '';
        }
        
        // Update info text
        const pageInfoEl = document.getElementById('pageInfo');
        const startNum = start + 1;
        const endNum = end;
        if (pageInfoEl) {
            pageInfoEl.textContent = filteredRows.length === 0 ? '0' : `${startNum}-${endNum}`;
        }
    }
    
    function updatePagination() {
        const totalPages = Math.ceil(filteredRows.length / ROWS_PER_PAGE);
        const paginationNav = document.getElementById('paginationNav');
        if (!paginationNav) return;
        
        paginationNav.innerHTML = '';
        
        if (totalPages <= 1) return;
        
        // Previous button
        const prevItem = document.createElement('li');
        prevItem.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
        prevItem.innerHTML = `<a class="page-link" href="#" onclick="goToPage(${currentPage - 1}); return false;"><i class="fas fa-chevron-left"></i></a>`;
        paginationNav.appendChild(prevItem);
        
        // Page numbers
        const maxVisible = 5;
        let startPage = Math.max(1, currentPage - Math.floor(maxVisible / 2));
        let endPage = Math.min(totalPages, startPage + maxVisible - 1);
        if (endPage - startPage < maxVisible - 1) {
            startPage = Math.max(1, endPage - maxVisible + 1);
        }
        
        if (startPage > 1) {
            const firstItem = document.createElement('li');
            firstItem.className = 'page-item';
            firstItem.innerHTML = `<a class="page-link" href="#" onclick="goToPage(1); return false;">1</a>`;
            paginationNav.appendChild(firstItem);
            
            if (startPage > 2) {
                const dots = document.createElement('li');
                dots.className = 'page-item disabled';
                dots.innerHTML = `<span class="page-link">...</span>`;
                paginationNav.appendChild(dots);
            }
        }
        
        for (let i = startPage; i <= endPage; i++) {
            const pageItem = document.createElement('li');
            pageItem.className = `page-item ${i === currentPage ? 'active' : ''}`;
            pageItem.innerHTML = `<a class="page-link" href="#" onclick="goToPage(${i}); return false;">${i}</a>`;
            paginationNav.appendChild(pageItem);
        }
        
        if (endPage < totalPages) {
            if (endPage < totalPages - 1) {
                const dots = document.createElement('li');
                dots.className = 'page-item disabled';
                dots.innerHTML = `<span class="page-link">...</span>`;
                paginationNav.appendChild(dots);
            }
            
            const lastItem = document.createElement('li');
            lastItem.className = 'page-item';
            lastItem.innerHTML = `<a class="page-link" href="#" onclick="goToPage(${totalPages}); return false;">${totalPages}</a>`;
            paginationNav.appendChild(lastItem);
        }
        
        // Next button
        const nextItem = document.createElement('li');
        nextItem.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
        nextItem.innerHTML = `<a class="page-link" href="#" onclick="goToPage(${currentPage + 1}); return false;"><i class="fas fa-chevron-right"></i></a>`;
        paginationNav.appendChild(nextItem);
    }

    function goToPage(page) {
        const totalPages = Math.ceil(filteredRows.length / ROWS_PER_PAGE);
        if (page < 1 || page > totalPages) return;
        currentPage = page;
        displayPage(currentPage);
        updatePagination();
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }
    
    window.goToPage = goToPage;

    // Keep delete delegation
    document.addEventListener('click', function(e) {
        const deleteBtn = e.target.closest('.delete-button-5w1h');
        if (deleteBtn) {
            e.preventDefault();
            e.stopPropagation();
            const entryId = deleteBtn.getAttribute('data-entry-id');
            const entryTitle = deleteBtn.getAttribute('data-entry-title');
            const entryOwner = deleteBtn.getAttribute('data-entry-owner');
            showDelete5W1HModal(entryId, entryTitle, entryOwner);
        }
    });
});

function showDelete5W1HModal(entryId, title, owner) {
    document.getElementById('delete5W1HId').value = entryId;
    const previewHTML = `
        <div class="p-3 border rounded bg-light">
            <div class="row mb-2"><div class="col-4 fw-bold">Title:</div><div class="col-8">${title}</div></div>
            <div class="row"><div class="col-4 fw-bold">Owner:</div><div class="col-8">${owner}</div></div>
        </div>
    `;
    document.getElementById('delete5W1HPreview').innerHTML = previewHTML;
    const modal = new bootstrap.Modal(document.getElementById('delete5W1HModal'));
    modal.show();
}

function confirmDelete5W1H() {
    const entryId = document.getElementById('delete5W1HId').value;
    fetch(`/impact/tools/5w1h/${entryId}`, {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || ''
        }
    }).then(response => {
        if (response.ok) {
            bootstrap.Modal.getInstance(document.getElementById('delete5W1HModal')).hide();
            location.reload();
        } else {
            alert('Gagal menghapus entri. Silakan coba lagi.');
        }
    }).catch(error => {
        console.error('Delete error:', error);
        alert('Terjadi kesalahan saat menghapus entri.');
    });
}
</script>
</body>
</html>
