<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Log {{ machine_name }} - Impact 360</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
    
    <style>
        .problems-table thead th {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: none;
            font-weight: 600;
            color: #495057;
            padding: 1rem 0.75rem;
            text-align: center;
            vertical-align: middle;
        }        
        .machine-header {
            background: linear-gradient(135deg, #ff9500 0%, #ff6b00 100%);
            color: white;
            padding: 2rem 0;
            margin: -1rem -15px 2rem -15px;
            border-radius: 0 0 20px 20px;
        }
        
        .status-badge {
            padding: 0.5rem 1rem;
            border-radius: 25px;
            font-weight: 600;
        }
        
        .status-active {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
        }
        
        .status-maintenance {
            background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);
            color: white;
        }
        
        .status-cleaning {
            background: linear-gradient(135deg, #17a2b8 0%, #20c997 100%);
            color: white;
        }
        
        .problem-card {
            border-left: 4px solid #ff9500;
            transition: all 0.3s ease;
        }
        
        .problem-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .photo-preview {
            max-width: 100px;
            max-height: 100px;
            object-fit: cover;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.2s ease;
        }
        
        .photo-preview:hover {
            transform: scale(1.05);
        }
        
        .downtime-calculator {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 1rem;
            border: 2px dashed #dee2e6;
        }
        
        .stat-card {
            border: none;
            border-radius: 15px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            background: white;
        }
        
        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        
        .table-responsive {
            border-radius: 10px;
            overflow: hidden;
        }
        
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }
        
        .card-header {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-bottom: none;
            border-radius: 15px 15px 0 0 !important;
        }
        
        .btn-action {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
            margin: 0 0.25rem;
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .loading-content {
            background: white;
            padding: 2rem;
            border-radius: 0.5rem;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        }
        
        /* Fix for photo modal z-index to appear above detail modal */
        #photoModal {
            z-index: 1060 !important;
        }
        
        #photoModal .modal-dialog {
            z-index: 1061 !important;
        }
        
        #photoModal .modal-content {
            z-index: 1062 !important;
        }
        
        /* Text wrapping for better readability */
        .text-wrap {
            word-wrap: break-word;
            white-space: normal;
            overflow-wrap: break-word;
            word-break: break-word;
            hyphens: auto;
        }
        
        .modal-body .text-wrap {
            max-width: 100%;
            overflow-wrap: break-word;
            word-break: break-word;
            hyphens: auto;
        }
        
        /* Enhanced text wrapping for long content */
        .problem-description-wrap {
            word-wrap: break-word;
            overflow-wrap: break-word;
            word-break: break-word;
            hyphens: auto;
            max-width: 100%;
            white-space: pre-line; /* Preserve line breaks but trim excessive whitespace */
            display: block; /* Help with whitespace handling */
            margin: 0;
            padding: 0;
            text-indent: 0;
            line-height: normal;
        }
        
        .solution-wrap {
            word-wrap: break-word;
            overflow-wrap: break-word;
            word-break: break-word;
            hyphens: auto;
            max-width: 100%;
            white-space: pre-line; /* Preserve line breaks but trim excessive whitespace */
            display: block; /* Help with whitespace handling */
            margin: 0;
            padding: 0;
            text-indent: 0;
            line-height: normal;
        }
        
        /* Styling untuk problem description link seperti wo_number */
        .problem-description-link {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            transition: all 0.2s ease;
            font-weight: 500;
            color: #0066cc !important;
            text-decoration: none;
        }

        .problem-description-link:hover {
            background-color: rgba(0, 102, 204, 0.1);
            color: #0052a3 !important;
            text-decoration: underline !important;
            transform: translateY(-1px);
        }
        
        /* Custom styles for status change modal */
        #statusChangeModal .modal-dialog {
            max-width: 450px;
        }
        
        #statusChangeModal .modal-header {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-bottom: 2px solid #dee2e6;
        }
        
        #statusChangeModal .modal-body {
            padding: 2rem;
        }
        
        #statusChangeModal .modal-footer {
            border-top: 2px solid #dee2e6;
            padding: 1rem 2rem;
        }
        
        .status-change-icon {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        .status-change-alert {
            border-radius: 10px;
            border-left: 4px solid;
        }
        
        .status-change-alert.info {
            background-color: #d1ecf1;
            border-left-color: #0c5460;
            color: #0c5460;
        }
        
        .status-change-alert.warning {
            background-color: #fff3cd;
            border-left-color: #856404;
            color: #856404;
        }
        
        .status-change-alert.success {
            background-color: #d4edda;
            border-left-color: #155724;
            color: #155724;
        }
        
        /* Filter section styling seperti tabelkpictp.html */
        .filter-section {
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            margin-bottom: 2rem;
        }
        
        /* Form controls clean styling */
        .form-control-clean {
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 0.75rem 1rem;
            transition: all 0.3s ease;
        }
        .form-control-clean:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }
        
        .form-select, .form-control {
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 0.75rem 1rem;
            transition: all 0.3s ease;
            font-size: 0.95rem;
        }
        
        .form-select:focus, .form-control:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }
        
        .form-label {
            font-size: 0.75rem;
            font-weight: 600;
            color: #6c757d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.25rem;
        }
        
        /* Button styling dengan tema CTP orange */
        .btn-clean {
            border: none;
            border-radius: 25px;
            padding: 0.5rem 1.5rem;
            font-weight: 600;
            font-size: 0.8rem;
            transition: all 0.3s ease;
            letter-spacing: 0.5px;
        }

        .btn-export-csv {
            background: linear-gradient(135deg, #06b406 0%, #008000 100%);
            color: white;
        }        
        
        .btn-primary-clean {
            background: linear-gradient(135deg, #ff9500 0%, #ff6b00 100%);
            color: white;
        }
        .btn-primary-clean:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 149, 0, 0.4);
            color: white;
        }
        
        /* Input group styling */
        .input-group .form-control {
            border-right: none;
        }
        
        .input-group .btn-outline-secondary {
            border-left: none;
            border-color: #e9ecef;
            background: #f8f9fa;
        }
        
        .input-group .btn-outline-secondary:hover {
            background: #e9ecef;
            border-color: #dee2e6;
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .filter-section {
                padding: 1rem;
            }
        }
    /* === PRINT / PDF OPTIMIZATION FOR CTP LOG DETAIL === */
    @page {
        /* A4 landscape: 297mm x 210mm */
        size: A4 landscape;
        margin: 10mm;
    }

    @media print {
        html, body {
            width: 297mm;
            height: 210mm;
            margin: 0;
            padding: 0;
            font-size: 10px; /* smaller font for better fit */
        }

        /* Hide navigation/sidebar and interactive-only UI in print */
        #wrapper > #sidebar-wrapper,
        #wrapper > .sidebar,
        #btnAddProblem,
        .btn-export,
        .filter-section,
        .machine-header .btn-group,
        .machine-header #btnSetActive,
        .machine-header #btnSetMaintenance,
        .machine-header #btnSetCleaning,
        .card-header .btn,
        .modal,
        #loadingOverlay {
            display: none !important;
        }

        /* Ensure the main content takes full width */
        #page-content-wrapper,
        .container-fluid {
            margin: 0;
            padding: 0;
            width: 100% !important;
            max-width: 100% !important;
        }

        /* Table layout tuning for PDF */
        .problems-table {
            width: 100% !important;
            table-layout: fixed !important; /* prevent overflow by distributing columns */
            font-size: 9px;                 /* slightly smaller for better fit */
        }

        .problems-table thead th,
        .problems-table tbody td {
            padding: 0.35rem 0.25rem !important;
            word-wrap: break-word;
            white-space: normal;
            overflow-wrap: break-word;
            hyphens: auto;
        }

        /* Narrow some columns to save space */
        .problems-table th:nth-child(1),
        .problems-table td:nth-child(1) {  /* Tanggal */
            width: 10%;
        }

        .problems-table th:nth-child(2),
        .problems-table td:nth-child(2) {  /* Problem */
            width: 26%;
            word-wrap: break-word;
            overflow-wrap: break-word;
            hyphens: auto;
            white-space: normal;
        }

        .problems-table th:nth-child(3),
        .problems-table td:nth-child(3) {  /* Solusi */
            width: 26%;
            word-wrap: break-word;
            overflow-wrap: break-word;
            hyphens: auto;
            white-space: normal;
        }

        .problems-table th:nth-child(4),
        .problems-table td:nth-child(4) {  /* Teknisi */
            width: 12%;
        }

        .problems-table th:nth-child(5),
        .problems-table td:nth-child(5) {  /* Status */
            width: 8%;
        }

        .problems-table th:nth-child(6),
        .problems-table td:nth-child(6) {  /* Downtime */
            width: 8%;
        }

        .problems-table th:nth-child(7),
        .problems-table td:nth-child(7) {  /* Aksi */
            width: 10%;
        }

        /* Remove horizontal scroll container in print, let table fill the page */
        .table-responsive {
            overflow: visible !important;
            box-shadow: none !important;
            border-radius: 0 !important;
        }

        /* Optional: scale the entire main content slightly to ensure fit */
        body {
            transform-origin: top left;
            transform: scale(0.9); /* adjust between 0.85â€“0.95 as needed */
        }
    }
    </style>
</head>
<body>
    {% include '_top_header.html' %}
    <div class="d-flex" id="content-wrapper">
        {% include '_sidebar.html' %}
        <div id="page-content-wrapper">
            <div class="container-fluid pt-3">
                <!-- Machine Header -->
                <div class="machine-header">
                    <div class="container-fluid">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h2 class="mb-1 text-white">{{ machine_name }}</h2>
                                <p class="mb-0 opacity-75">{{ machine_description or 'Mesin CTP untuk produksi plate' }}</p>
                            </div>
                            <div class="text-end">
                                <!-- Machine Status Buttons -->
                                <div class="btn-group" role="group" aria-label="Machine Status">
                                    <button type="button" class="btn btn-success" id="btnSetActive" onclick="changeMachineStatus('active')">
                                        <i class="fas fa-play me-1"></i>Aktif
                                    </button>
                                    <button type="button" class="btn btn-warning" id="btnSetMaintenance" onclick="changeMachineStatus('maintenance')">
                                        <i class="fas fa-tools me-1"></i>Perbaikan
                                    </button>
                                    <button type="button" class="btn btn-info" id="btnSetCleaning" onclick="changeMachineStatus('cleaning')">
                                        <i class="fas fa-broom me-1"></i>Pembersihan
                                    </button>
                                </div>
                                <!-- Status Badge -->
                                <span class="status-badge status-{{ machine_status or 'active' }} ms-3" id="machineStatusBadge">
                                    {% if machine_status == 'active' %}AKTIF
                                    {% elif machine_status == 'maintenance' %}PERBAIKAN
                                    {% elif machine_status == 'cleaning' %}PEMBERSIHAN
                                    {% else %}{{ (machine_status or 'active').upper() }}{% endif %}
                                </span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="row mb-4">
                    <div class="col-12">
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addProblemModal" id="btnAddProblem">
                            <i class="fas fa-plus-circle me-2"></i>Tambah Problem
                        </button>
                        <button class="btn btn-success ms-2" onclick="showExportModal()">
                            <i class="fas fa-download me-2"></i>Export Data
                        </button>
                    </div>
                </div>

                <!-- Statistics Cards -->
                <div class="row mb-4" id="statisticsCards" style="display: none;">
                    <div class="col-md-3 mb-3">
                        <div class="stat-card text-center h-100">
                            <div class="card-body d-flex flex-column justify-content-center align-items-center" style="min-height: 140px;">
                                <div class="mb-2">
                                    <i class="fas fa-exclamation-triangle fa-lg text-primary"></i>
                                </div>
                                <h6 class="card-title text-primary mb-2">Total Problem</h6>
                                <div class="text-primary mb-0" style="font-size: 1.5rem; font-weight: 600;" id="totalProblems">0</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="stat-card text-center h-100">
                            <div class="card-body d-flex flex-column justify-content-center align-items-center" style="min-height: 140px;">
                                <div class="mb-2">
                                    <i class="fas fa-clock fa-lg text-warning"></i>
                                </div>
                                <h6 class="card-title text-warning mb-2">Problem Aktif</h6>
                                <div class="text-warning mb-0" style="font-size: 1.5rem; font-weight: 600;" id="activeProblems">0</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="stat-card text-center h-100">
                            <div class="card-body d-flex flex-column justify-content-center align-items-center" style="min-height: 140px;">
                                <div class="mb-2">
                                    <i class="fas fa-hourglass-half fa-lg text-info"></i>
                                </div>
                                <h6 class="card-title text-info mb-2">Total Downtime</h6>
                                <div class="text-info mb-0" style="font-size: 1.5rem; font-weight: 600;" id="totalDowntime">0 jam</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="stat-card text-center h-100">
                            <div class="card-body d-flex flex-column justify-content-center align-items-center" style="min-height: 140px;">
                                <div class="mb-2">
                                    <i class="fas fa-chart-line fa-lg text-success"></i>
                                </div>
                                <h6 class="card-title text-success mb-2">Rata-rata Downtime</h6>
                                <div class="text-success mb-0" style="font-size: 1.5rem; font-weight: 600;" id="avgDowntime">0 jam</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Filter Section -->
                <div class="filter-section">
                    <div class="row align-items-end">
                        <div class="col-md-2">
                            <label for="filterYear" class="form-label">Filter Tahun</label>
                            <select class="form-select form-control-clean" id="filterYear">
                                <option value="">Semua Tahun</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label for="filterMonth" class="form-label">Filter Bulan</label>
                            <select class="form-select form-control-clean" id="filterMonth">
                                <option value="">Semua Bulan</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label for="filterVendor" class="form-label">Filter Vendor</label>
                            <select class="form-select form-control-clean" id="filterVendor">
                                <option value="">Semua Vendor</option>
                                <option value="lokal">Lokal</option>
                                <option value="vendor">Vendor</option>
                                <option value="none">Tidak memanggil teknisi</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label for="filterStatus" class="form-label">Filter Status</label>
                            <select class="form-select form-control-clean" id="filterStatus">
                                <option value="">Semua Status</option>
                                <option value="ongoing">Sedang Berjalan</option>
                                <option value="completed">Selesai</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="searchInput" class="form-label">Pencarian</label>
                            <div class="input-group">
                                <input type="text" class="form-control form-control-clean" id="searchInput" placeholder="Cari problem, teknisi, atau solusi...">
                                <button class="btn btn-outline-secondary" type="button" id="clearSearch">Clear</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Problems List -->
                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h5 class="card-title mb-0">
                                        <i class="fas fa-list me-2"></i>Riwayat Problem
                                    </h5>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-hover problems-table" id="problemsTable">
                                        <thead>
                                            <tr>
                                                <th style="max-width: 120px; word-wrap: break-word;">Tanggal</th>
                                                <th style="max-width: 150px; word-wrap: break-word;">Error Code</th>
                                                <th style="max-width: 200px; word-wrap: break-word;">Problem</th>
                                                <th style="max-width: 200px; word-wrap: break-word;">Solusi</th>
                                                <th>Teknisi</th>
                                                <th>PIC</th>
                                                <th>Status</th>
                                                <th>Downtime</th>
                                                <th style="max-width: 150px; word-wrap: break-word;">Aksi</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td colspan="7" class="text-center text-muted">
                                                    <div class="spinner-border spinner-border-sm text-primary me-2" role="status">
                                                        <span class="visually-hidden">Loading...</span>
                                                    </div>
                                                    Memuat data problem...
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Problem Modal -->
    <div class="modal fade" id="addProblemModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-exclamation-triangle me-2"></i>Tambah Problem Baru
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addProblemForm">
                        <div class="mb-3">
                            <label class="form-label">Tanggal Problem <span class="text-danger">*</span></label>
                            <input type="datetime-local" class="form-control" id="problemDate" required>
                            <small class="text-muted">Format: Tanggal dan waktu saat problem terjadi</small>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Error Code</label>
                            <input type="text" class="form-control" id="problemErrorCode" placeholder="Masukkan error code (jika ada)">
                            <small class="text-muted">Error code opsional, jika ada error spesifik yang terjadi</small>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Deskripsi Problem <span class="text-danger">*</span></label>
                            <textarea class="form-control" id="problemDescription" rows="3" required placeholder="Jelaskan problem yang terjadi..."></textarea>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Foto Lampiran Problem (Maks 20 foto)</label>
                            <input type="file" class="form-control" id="problemPhotos" accept="image/*" multiple>
                            <div class="mt-2" id="photosPreview"></div>
                            <small class="text-muted">Format: JPG, PNG, GIF. Maksimal 20 foto.</small>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Lampiran Dokumen (PDF/DOCX/ZIP)</label>
                            <input type="file" class="form-control" id="problemDocuments" accept=".pdf,.docx,.zip,application/zip,application/x-zip-compressed" multiple>
                            <div class="mt-2" id="documentsPreview"></div>
                            <small class="text-muted">Format: PDF, DOCX, ZIP. Maksimal 5 dokumen. ZIP maksimal 50MB.</small>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Jenis Teknisi <span class="text-danger">*</span></label>
                                    <select class="form-select" id="technicianType" required>
                                        <option value="">Pilih Jenis</option>
                                        <option value="lokal">Lokal</option>
                                        <option value="vendor">Vendor</option>
                                        <option value="none">Tidak memanggil teknisi</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Nama Teknisi</label>
                                    <input type="text" class="form-control" id="technicianName" placeholder="Nama teknisi...">
                                </div>
                            </div>
                        </div>
                        
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                    <button type="button" class="btn btn-primary" id="btnSaveProblem">
                        <i class="fas fa-save me-1"></i>Simpan
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Problem Modal -->
    <div class="modal fade" id="editProblemModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-edit me-2"></i>Edit Problem
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editProblemForm">
                        <input type="hidden" id="editProblemId">
                        <div class="mb-3">
                            <label class="form-label">Tanggal Problem <span class="text-danger">*</span></label>
                            <input type="datetime-local" class="form-control" id="editProblemDate" required>
                            <small class="text-muted">Format: Tanggal dan waktu saat problem terjadi</small>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Error Code</label>
                            <input type="text" class="form-control" id="editErrorCode" placeholder="Masukkan error code (jika ada)">
                            <small class="text-muted">Error code opsional, jika ada error spesifik yang terjadi</small>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Deskripsi Problem <span class="text-danger">*</span></label>
                            <textarea class="form-control" id="editProblemDescription" rows="3" required placeholder="Jelaskan problem yang terjadi..."></textarea>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Foto Lampiran Problem (Maks 20 foto)</label>
                            <input type="file" class="form-control" id="editProblemPhotos" accept="image/*" multiple>
                            <div class="mt-2" id="editPhotosPreview"></div>
                            <div class="mt-2" id="currentPhotosPreview"></div>
                            <small class="text-muted">Format: JPG, PNG, GIF. Maksimal 20 foto. Klik tombol X untuk menghapus foto.</small>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Lampiran Dokumen (PDF/DOCX/ZIP)</label>
                            <input type="file" class="form-control" id="editProblemDocuments" accept=".pdf,.docx,.zip" multiple>
                            <div class="mt-2" id="editDocumentsPreview"></div>
                            <div class="mt-2" id="currentDocumentsPreview"></div>
                            <small class="text-muted">Format: PDF, DOCX, ZIP. Maksimal 5 dokumen. ZIP maksimal 50MB. Klik tombol X untuk menghapus dokumen.</small>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Jenis Teknisi <span class="text-danger">*</span></label>
                                    <select class="form-select" id="editTechnicianType" required>
                                        <option value="">Pilih Jenis</option>
                                        <option value="lokal">Lokal</option>
                                        <option value="vendor">Vendor</option>
                                        <option value="none">Tidak memanggil teknisi</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Nama Teknisi</label>
                                    <input type="text" class="form-control" id="editTechnicianName" placeholder="Nama teknisi...">
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Solusi</label>
                            <textarea class="form-control" id="editSolution" rows="3" placeholder="Jelaskan solusi yang dilakukan..."></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                    <button type="button" class="btn btn-primary" id="btnUpdateProblem">
                        <i class="fas fa-save me-1"></i>Update
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Photo Modal -->
    <div class="modal fade" id="photoModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Foto Problem</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    <img id="modalPhoto" src="" alt="Foto Problem" class="img-fluid">
                </div>
            </div>
        </div>
    </div>

    <!-- Status Change Confirmation Modal -->
    <div class="modal fade" id="statusChangeModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Konfirmasi Perubahan Status
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <i class="fas fa-question-circle fa-3x text-warning text-center d-block mb-3 status-change-icon"></i>
                        <p class="text-center mb-0 fs-5" id="statusChangeMessage">
                            Apakah Anda yakin ingin mengubah status mesin?
                        </p>
                    </div>
                    <div class="alert status-change-alert info" id="statusChangeInfo">
                        <i class="fas fa-info-circle me-2"></i>
                        <span id="statusChangeInfoText">Status mesin akan segera diubah</span>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>Batal
                    </button>
                    <button type="button" class="btn btn-primary" id="confirmStatusChangeBtn">
                        <i class="fas fa-check me-1"></i>Ya, Ubah Status
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteConfirmModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Konfirmasi Hapus
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <i class="fas fa-question-circle fa-3x text-danger text-center d-block mb-3"></i>
                        <p class="text-center mb-0 fs-5">
                            Apakah Anda yakin ingin menghapus problem ini?
                        </p>
                    </div>
                    <div class="alert alert-danger" role="alert">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Perhatian:</strong> Tindakan ini tidak dapat dibatalkan. Semua data terkait problem akan dihapus secara permanen.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>Batal
                    </button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
                        <i class="fas fa-trash me-1"></i>Hapus
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Export Modal -->
    <div class="modal fade" id="exportModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Export Data CTP Log</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="exportForm">
                        <div class="mb-3">
                            <label class="form-label">Format Export</label>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="format" id="formatExcel" value="excel" checked>
                                <label class="form-check-label" for="formatExcel">
                                    <i class="fas fa-file-excel me-2 text-success"></i>Excel (.xlsx)
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="format" id="formatPdf" value="pdf">
                                <label class="form-check-label" for="formatPdf">
                                    <i class="fas fa-file-pdf me-2 text-danger"></i>PDF (.pdf)
                                </label>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Tanggal Dari</label>
                            <input type="date" class="form-control" id="exportDateFrom">
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Tanggal Sampai</label>
                            <input type="date" class="form-control" id="exportDateTo">
                        </div>

                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                    <button type="button" class="btn btn-success" id="confirmExport">
                        <i class="fas fa-download me-2"></i>Export
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay d-none" id="loadingOverlay">
        <div class="loading-content">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <div class="mt-2">Memproses...</div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='js/sidebar_handler.js') }}"></script>
    <script src="{{ url_for('static', filename='js/notification_system.js') }}"></script>
    <script>
        let currentMachineId = null;
        let currentMachineNickname = null;
        let currentUserRole = null;
        let photosToDelete = [];  // Track photo IDs to delete on update
        let documentsToDelete = [];  // Track document IDs to delete on update

        document.addEventListener('DOMContentLoaded', async function() {
            console.log('=== DOM CONTENT LOADED ===');
            
            try {
                // Get machine info from page
                currentMachineNickname = '{{ machine_nickname }}';
                console.log('Machine nickname set to:', currentMachineNickname);
                
                // Set current Jakarta datetime for problem date
                function getJakartaDateTimeString() {
                    const now = new Date();
                    const year = now.getFullYear();
                    const month = String(now.getMonth() + 1).padStart(2, '0');
                    const day = String(now.getDate()).padStart(2, '0');
                    const hours = String(now.getHours()).padStart(2, '0');
                    const minutes = String(now.getMinutes()).padStart(2, '0');
                    return `${year}-${month}-${day}T${hours}:${minutes}`;
                }
                
                const jakartaDateTime = getJakartaDateTimeString();
                const problemDateField = document.getElementById('problemDate');
                if (problemDateField) {
                    problemDateField.value = jakartaDateTime;
                    console.log('Problem date set to:', jakartaDateTime);
                }
                
                // Initialize in proper order using async/await:
                // 1. Load user role first
                await loadUserRole();
                
                // 2. Load machine data first
                await loadMachineDataAsync();
                
                // 3. Load problems and populate filters
                console.log('Loading problems...');
                await loadProblemsAsync();
                
                console.log('Populating year filters...');
                await populateYearOptions();
                
                console.log('Setting up event listeners...');
                // 4. Setup event listeners after filters are populated
                setupEventListeners();
                
                console.log('Initialization completed successfully');
            } catch (error) {
                console.error('Error during initialization:', error);
                // Fallback: setup event listeners anyway
                setupEventListeners();
                // Show error to user
                showToast('Terjadi kesalahan saat memuat data. Silakan refresh halaman.', 'danger');
            }
        });

        function setupEventListeners() {
            console.log('=== SETTING UP EVENT LISTENERS ===');
            
            // Check if elements exist before adding listeners
            const yearFilter = document.getElementById('filterYear');
            const monthFilter = document.getElementById('filterMonth');
            const vendorFilter = document.getElementById('filterVendor');
            const statusFilter = document.getElementById('filterStatus');
            const searchInput = document.getElementById('searchInput');
            const clearSearch = document.getElementById('clearSearch');
            const btnSaveProblem = document.getElementById('btnSaveProblem');
            const btnUpdateProblem = document.getElementById('btnUpdateProblem');
            const problemPhotos = document.getElementById('problemPhotos');
            const editProblemPhotos = document.getElementById('editProblemPhotos');
            const problemDocuments = document.getElementById('problemDocuments');
            const editProblemDocuments = document.getElementById('editProblemDocuments');
            const technicianType = document.getElementById('technicianType');
            const editTechnicianType = document.getElementById('editTechnicianType');
            
            console.log('Element checks:', {
                yearFilter: !!yearFilter,
                monthFilter: !!monthFilter,
                vendorFilter: !!vendorFilter,
                statusFilter: !!statusFilter,
                searchInput: !!searchInput,
                clearSearch: !!clearSearch,
                btnSaveProblem: !!btnSaveProblem,
                btnUpdateProblem: !!btnUpdateProblem,
                problemPhotos: !!problemPhotos,
                editProblemPhotos: !!editProblemPhotos,
                problemDocuments: !!problemDocuments,
                editProblemDocuments: !!editProblemDocuments,
                technicianType: !!technicianType,
                editTechnicianType: !!editTechnicianType
            });
            
            if (!yearFilter || !monthFilter || !vendorFilter || !statusFilter || !searchInput || !clearSearch || !btnSaveProblem || !btnUpdateProblem || !problemPhotos || !editProblemPhotos || !problemDocuments || !editProblemDocuments || !technicianType || !editTechnicianType) {
                console.error('Some DOM elements are missing, cannot setup event listeners');
                return;
            }
            
            // Form submission
            btnSaveProblem.addEventListener('click', saveProblem);
            
            // Update problem date when add modal is opened
            document.getElementById('btnAddProblem').addEventListener('click', function() {
                // Update to current Jakarta time when modal opens
                function getJakartaDateTimeString() {
                    const now = new Date();
                    const year = now.getFullYear();
                    const month = String(now.getMonth() + 1).padStart(2, '0');
                    const day = String(now.getDate()).padStart(2, '0');
                    const hours = String(now.getHours()).padStart(2, '0');
                    const minutes = String(now.getMinutes()).padStart(2, '0');
                    return `${year}-${month}-${day}T${hours}:${minutes}`;
                }
                
                const jakartaDateTime = getJakartaDateTimeString();
                const problemDateField = document.getElementById('problemDate');
                if (problemDateField) {
                    problemDateField.value = jakartaDateTime;
                    console.log('Problem date updated to:', jakartaDateTime);
                }
            });
            
            // Edit form submission
            btnUpdateProblem.addEventListener('click', updateProblem);
            
            // Photo preview
            problemPhotos.addEventListener('change', function(e) { previewMultiplePhotos(e, 'photosPreview'); });
            editProblemPhotos.addEventListener('change', function(e) { previewMultiplePhotos(e, 'editPhotosPreview'); });
            
            // Document preview
            problemDocuments.addEventListener('change', function(e) { previewDocuments(e, 'documentsPreview'); });
            editProblemDocuments.addEventListener('change', function(e) { previewDocuments(e, 'editDocumentsPreview'); });
            
            // Technician type change handler
            technicianType.addEventListener('change', handleTechnicianTypeChange);
            editTechnicianType.addEventListener('change', handleEditTechnicianTypeChange);
            
            // Filters
            yearFilter.addEventListener('change', async function() {
                const selectedYear = this.value;
                console.log('Year filter changed to:', selectedYear);
                try {
                    await populateMonthOptions(selectedYear);
                    await loadProblemsAsync();
                } catch (error) {
                    console.error('Error handling year filter change:', error);
                    showToast('Gagal memperbarui filter', 'danger');
                }
            });
            monthFilter.addEventListener('change', function() {
                loadProblemsAsync().catch(error => {
                    console.error('Error handling month filter change:', error);
                });
            });
            vendorFilter.addEventListener('change', function() {
                loadProblemsAsync().catch(error => {
                    console.error('Error handling vendor filter change:', error);
                });
            });
            statusFilter.addEventListener('change', function() {
                loadProblemsAsync().catch(error => {
                    console.error('Error handling status filter change:', error);
                });
            });
            
            // Search with debouncing to prevent excessive loading spinner
            let searchTimeout;
            searchInput.addEventListener('input', function() {
                // Clear previous timeout
                if (searchTimeout) {
                    clearTimeout(searchTimeout);
                }
                
                // Set new timeout with 500ms delay
                searchTimeout = setTimeout(() => {
                    loadProblemsAsync().catch(error => {
                        console.error('Error handling search:', error);
                    });
                }, 500);
            });
            
            // Clear search
            clearSearch.addEventListener('click', async function() {
                document.getElementById('searchInput').value = '';
                try {
                    await loadProblemsAsync();
                } catch (error) {
                    console.error('Error clearing search:', error);
                }
            });
            
            console.log('All event listeners setup completed');
        }

        function loadMachineData() {
            // Legacy function for backward compatibility
            loadMachineDataAsync().catch(error => {
                console.error('Error loading machine data:', error);
            });
        }

        async function loadUserRole() {
            try {
                const response = await fetch('/impact/api/current-user-role');
                const data = await response.json();
                
                if (data.success) {
                    currentUserRole = data.role;
                    console.log('Current user role:', currentUserRole);
                } else {
                    console.error('Failed to load user role:', data.error);
                    currentUserRole = 'user'; // Default fallback
                }
            } catch (error) {
                console.error('Error loading user role:', error);
                currentUserRole = 'user'; // Default fallback
            }
        }

        async function loadMachineDataAsync() {
            try {
                const response = await fetch(`/impact/api/ctp-machines`);
                const data = await response.json();
                
                if (data.success) {
                    const machine = data.data.find(m => m.nickname === currentMachineNickname);
                    if (machine) {
                        currentMachineId = machine.id;
                        updateStatistics(machine.id);
                        return machine;
                    } else {
                        throw new Error(`Machine with nickname '${currentMachineNickname}' not found`);
                    }
                } else {
                    throw new Error(data.error || 'Failed to load machine data');
                }
            } catch (error) {
                console.error('Error in loadMachineDataAsync:', error);
                throw error;
            }
        }

        function updateStatistics(machineId) {
            fetch(`/impact/api/ctp-problem-logs?machine_id=${machineId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const logs = data.data;
                        
                        // Calculate statistics
                        const totalProblems = logs.length;
                        const activeProblems = logs.filter(log => log.status === 'ongoing').length;
                        const totalDowntime = logs.reduce((sum, log) => sum + (log.downtime_hours || 0), 0);
                        const avgDowntime = totalProblems > 0 ? totalDowntime / totalProblems : 0;
                        
                        // Update UI directly - show actual values immediately
                        document.getElementById('totalProblems').textContent = totalProblems;
                        document.getElementById('activeProblems').textContent = activeProblems;
                        document.getElementById('totalDowntime').textContent = formatDowntime(totalDowntime);
                        document.getElementById('avgDowntime').textContent = formatDowntime(avgDowntime);
                        
                        // Show statistics cards with actual values
                        document.getElementById('statisticsCards').style.display = 'flex';
                    }
                })
                .catch(error => {
                    console.error('Error loading statistics:', error);
                    // Show error state in statistics cards
                    document.getElementById('totalProblems').innerHTML = '<span class="text-danger">Error</span>';
                    document.getElementById('activeProblems').innerHTML = '<span class="text-danger">Error</span>';
                    document.getElementById('totalDowntime').innerHTML = '<span class="text-danger">Error</span>';
                    document.getElementById('avgDowntime').innerHTML = '<span class="text-danger">Error</span>';
                    // Show statistics cards even on error
                    document.getElementById('statisticsCards').style.display = 'flex';
                });
        }

        function animateValue(id, start, end, duration) {
            const element = document.getElementById(id);
            const range = end - start;
            const increment = range / (duration / 16);
            let current = start;
            
            const timer = setInterval(() => {
                current += increment;
                if ((increment > 0 && current >= end) || (increment < 0 && current <= end)) {
                    element.textContent = end;
                    clearInterval(timer);
                } else {
                    element.textContent = Math.round(current);
                }
            }, 16);
        }

        async function populateYearOptions() {
            try {
                // Directly extract years from existing data since dedicated endpoint doesn't exist
                // This avoids 404 errors and provides more reliable data extraction
                return await extractYearsFromExistingData();
            } catch (error) {
                console.error('Error loading years:', error);
                throw error;
            }
        }

        async function extractYearsFromExistingData() {
            try {
                
                // Fetch all problems and extract unique years
                const apiUrl = `/impact/api/ctp-problem-logs?machine_nickname=${currentMachineNickname}`;
                
                const response = await fetch(apiUrl);
                console.log('API response status:', response.status);
                const data = await response.json();
                
                
                if (data.success && data.data && Array.isArray(data.data)) {
                    const years = new Set();
                    
                    data.data.forEach((log, index) => {
                        // Use created_at field as primary date source
                        const dateField = log.created_at || log.problem_date || log.start_time || log.date;
                        
                        if (dateField) {
                            try {
                                const date = new Date(dateField);
                                const year = date.getFullYear();
                                if (!isNaN(year)) {
                                    years.add(year);
                                }
                            } catch (e) {
                                console.error('Error parsing date:', e);
                            }
                        } else {
                            console.log('No date field found for log:', index);
                        }
                    });
                    
                    const yearSelect = document.getElementById('filterYear');
                    
                    if (yearSelect) {
                        yearSelect.innerHTML = '<option value="">Semua Tahun</option>';
                        
                        // Sort years in descending order (most recent first)
                        const sortedYears = Array.from(years).sort((a, b) => b - a);
                        console.log('Sorted years:', sortedYears);
                        
                        sortedYears.forEach((year, index) => {
                            yearSelect.innerHTML += `<option value="${year}">${year}</option>`;
                        });
                        return {success: true, years: Array.from(years)};
                    } else {
                        throw new Error('Year select element not found');
                    }
                } else {
                    throw new Error('No data found or API failed');
                }
            } catch (error) {
                console.error('Error extracting years from data:', error);
                console.error('Fetch error details:', error.message, error.stack);
                throw error;
            }
        }

        async function populateMonthOptions(selectedYear = '') {
            try {
                // First try to fetch from dedicated API endpoint
                if (selectedYear) {
                    const response = await fetch(`/impact/api/ctp-problem-logs/months?machine_nickname=${currentMachineNickname}&year=${selectedYear}`);
                    
                    // Check if response is OK before parsing JSON
                    if (!response.ok) {
                        console.log('API endpoint not found (404), using fallback for months');
                        return await extractMonthsFromExistingData(selectedYear);
                    }
                    
                    const data = await response.json();
                    
                    if (data.success && data.months && data.months.length > 0) {
                        const monthSelect = document.getElementById('filterMonth');
                        if (monthSelect) {
                            monthSelect.innerHTML = '<option value="">Semua Bulan</option>';
                            
                            const monthNames = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
                            
                            data.months.forEach(month => {
                                const monthName = monthNames[month - 1] || `Bulan ${month}`;
                                monthSelect.innerHTML += `<option value="${month}">${monthName}</option>`;
                            });
                        }
                        return {success: true, months: data.months};
                    } else {
                        console.log('API failed or no data, using fallback for months');
                        // Fallback: extract months from existing data
                        return await extractMonthsFromExistingData(selectedYear);
                    }
                } else {
                    // If no year selected, clear month options
                    const monthSelect = document.getElementById('filterMonth');
                    if (monthSelect) {
                        monthSelect.innerHTML = '<option value="">Semua Bulan</option>';
                    }
                    return {success: true, months: []};
                }
            } catch (error) {
                console.error('Error loading months:', error);
                console.log('Using fallback due to error for months');
                // Fallback: extract months from existing data
                return await extractMonthsFromExistingData(selectedYear);
            }
        }

        async function extractMonthsFromExistingData(selectedYear) {
            try {
                // Fetch all problems and extract unique months for selected year
                const response = await fetch(`/impact/api/ctp-problem-logs?machine_nickname=${currentMachineNickname}`);
                const data = await response.json();
                
                if (data.success && data.data) {
                    const months = new Set();
                    data.data.forEach(log => {
                        // Use created_at field as primary date source
                        const dateField = log.created_at || log.problem_date || log.start_time || log.date;
                        if (dateField) {
                            const date = new Date(dateField);
                            const year = date.getFullYear();
                            if (year == selectedYear) {
                                months.add(date.getMonth() + 1); // getMonth() returns 0-11, we need 1-12
                            }
                        }
                    });
                    
                    const monthSelect = document.getElementById('filterMonth');
                    if (monthSelect) {
                        monthSelect.innerHTML = '<option value="">Semua Bulan</option>';
                        
                        const monthNames = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
                        
                        // Sort months numerically
                        Array.from(months).sort((a, b) => a - b).forEach(month => {
                            const monthName = monthNames[month - 1] || `Bulan ${month}`;
                            monthSelect.innerHTML += `<option value="${month}">${monthName}</option>`;
                        });
                    }
                    return {success: true, months: Array.from(months)};
                } else {
                    throw new Error('No data found or API failed');
                }
            } catch (error) {
                console.error('Error extracting months from data:', error);
                throw error;
            }
        }

        function loadProblems() {
            // Legacy function for backward compatibility
            loadProblemsAsync().catch(error => {
                console.error('Error loading problems:', error);
                showToast('Gagal memuat data problem', 'danger');
            });
        }

        async function loadProblemsAsync() {
            try {
                showLoading();
                
                const year = document.getElementById('filterYear').value;
                const month = document.getElementById('filterMonth').value;
                const vendor = document.getElementById('filterVendor').value;
                const status = document.getElementById('filterStatus').value;
                const searchTerm = document.getElementById('searchInput').value.trim();
                
                let url = `/impact/api/ctp-problem-logs?machine_nickname=${currentMachineNickname}`;
                if (year) url += `&year=${year}`;
                if (month) url += `&month=${month}`;
                if (vendor) url += `&technician_type=${vendor}`;
                if (status) url += `&status=${status}`;
                if (searchTerm) url += `&search=${encodeURIComponent(searchTerm)}`;
                
                const response = await fetch(url);
                const data = await response.json();
                
                hideLoading();
                
                if (data.success) {
                    const tbody = document.querySelector('#problemsTable tbody');
                    tbody.innerHTML = '';
                    
                    if (data.data.length === 0) {
                        tbody.innerHTML = `
                            <tr>
                                <td colspan="7" class="text-center text-muted">
                                    <i class="fas fa-info-circle me-2"></i>
                                    Tidak ada data problem untuk filter yang dipilih
                                </td>
                            </tr>
                        `;
                        return {success: true, data: []};
                    }
                    
                    data.data.forEach(log => {
                        const row = createProblemDetailRow(log);
                        tbody.innerHTML += row;
                    });
                    
                    return {success: true, data: data.data};
                } else {
                    throw new Error(data.error || 'Unknown error');
                }
            } catch (error) {
                hideLoading();
                console.error('Error in loadProblemsAsync:', error);
                showToast('Gagal memuat data problem: ' + error.message, 'danger');
                throw error;
            }
        }

        function createProblemDetailRow(log) {
            const statusBadge = log.status === 'completed'
                ? '<span class="badge bg-success">Selesai</span>'
                : '<span class="badge bg-warning">Berjalan</span>';
            
            const downtime = formatDowntime(log.downtime_hours);
            
            // Create photo indicator if photos exist
            let photoIndicator = '';
            const hasPhotos = (log.photos && log.photos.length > 0) || log.problem_photo;
            if (hasPhotos) {
                const photoCount = log.photos ? log.photos.length : (log.problem_photo ? 1 : 0);
                photoIndicator = `<br><small class="text-muted"><i class="fas fa-camera me-1"></i>${photoCount} foto</small>`;
            }
            
            let actions = '';
            
            if (log.status === 'ongoing') {
                actions = `<button class="btn btn-sm btn-success btn-action" onclick="completeProblem(${log.id})">
                     <i class="fas fa-check"></i> Selesai
                   </button>
                   <button class="btn btn-sm btn-warning btn-action" onclick="editProblem(${log.id})">
                     <i class="fas fa-edit"></i> Edit
                   </button>
                   <button class="btn btn-sm btn-danger btn-action" onclick="deleteProblem(${log.id})">
                     <i class="fas fa-trash"></i> Hapus
                   </button>`;
            } else if (log.status === 'completed' && currentUserRole === 'admin') {
                // For completed problems, only show edit/delete buttons for admin users
                actions = `<button class="btn btn-sm btn-warning btn-action" onclick="editProblem(${log.id})">
                     <i class="fas fa-edit"></i> Edit
                   </button>
                   <button class="btn btn-sm btn-danger btn-action" onclick="deleteProblem(${log.id})">
                     <i class="fas fa-trash"></i> Hapus
                   </button>`;
            }
            // For completed problems with non-admin users, show no action buttons
            
            return `
                <tr>
                    <td>${formatDate(log.problem_date)}</td>
                    <td class="text-wrap">${log.error_code || '-'}</td>
                    <td class="text-wrap">
                        <a href="#" onclick="viewProblemDetail(${log.id}); return false;" class="problem-description-link">${log.problem_description}</a>
                        ${photoIndicator}
                    </td>
                    <td class="text-wrap">${log.solution || '-'}</td>
                    <td>${log.technician_name || '-'}</td>
                    <td>${log.created_by_name || '-'}</td>
                    <td>${statusBadge}</td>
                    <td>${downtime}</td>
                    <td>${actions}</td>
                </tr>
            `;
        }

        function saveProblem() {
            const form = document.getElementById('addProblemForm');
            
            // Validate required fields
            const problemDescription = document.getElementById('problemDescription').value.trim();
            const technicianType = document.getElementById('technicianType').value;
            const problemDate = document.getElementById('problemDate').value;
            const errorCode = document.getElementById('problemErrorCode').value.trim();
            
            if (!problemDescription || !technicianType || !problemDate) {
                showToast('Mohon lengkapi field yang wajib diisi', 'warning');
                return;
            }
            
            showLoading();
            
            // Create FormData for file upload
            const formData = new FormData();
            formData.append('machine_id', currentMachineId);
            formData.append('problem_description', problemDescription);
            formData.append('error_code', errorCode);
            formData.append('technician_type', technicianType);
            formData.append('technician_name', document.getElementById('technicianName').value);
            formData.append('start_time', problemDate); // Use problemDate as start_time
            
            // Add multiple photos if exists
            const photoFiles = document.getElementById('problemPhotos').files;
            for (let i = 0; i < photoFiles.length; i++) {
                formData.append('problem_photos', photoFiles[i]);
            }
            
            // Add multiple documents if exists
            const documentFiles = document.getElementById('problemDocuments').files;
            for (let i = 0; i < documentFiles.length; i++) {
                formData.append('problem_documents', documentFiles[i]);
            }
            
            fetch('/impact/api/ctp-problem-logs', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                hideLoading();
                if (data.success) {
                    showToast('Problem berhasil ditambahkan', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('addProblemModal')).hide();
                    form.reset();
                    // Reset technician name field visibility
                    handleTechnicianTypeChange();
                    loadProblems();
                    updateStatistics(currentMachineId);
                } else {
                    showToast('Gagal menambahkan problem: ' + (data.error || 'Unknown error'), 'danger');
                }
            })
            .catch(error => {
                hideLoading();
                console.error('Error saving problem:', error);
                showToast('Gagal menambahkan problem', 'danger');
            });
        }

        function editProblem(logId) {
            // Reset deletion arrays when opening modal
            photosToDelete = [];
            documentsToDelete = [];
            
            // First check if this is a completed problem and user is not admin
            fetch(`/impact/api/ctp-problem-logs/${logId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const problemData = data.data;
                        
                        // Check if problem is completed and user is not admin
                        if (problemData.status === 'completed' && currentUserRole !== 'admin') {
                            showToast('Hanya admin yang dapat mengedit problem yang sudah selesai', 'warning');
                            return;
                        }
                        
                        // Continue with edit functionality
                        const log = problemData;
                        
                        // Populate the edit form
                        document.getElementById('editProblemId').value = log.id;
                        document.getElementById('editProblemDate').value = log.problem_date.slice(0, 16);
                        document.getElementById('editErrorCode').value = log.error_code || '';
                        document.getElementById('editProblemDescription').value = log.problem_description;
                        document.getElementById('editTechnicianType').value = log.technician_type || '';
                        document.getElementById('editTechnicianName').value = log.technician_name || '';
                        document.getElementById('editSolution').value = log.solution || '';
                        
                        // Show current photos if exists
                        if (log.photos && log.photos.length > 0) {
                            const photosHtml = log.photos.map(photo => `
                                <div class="col-md-3 mb-2 position-relative">
                                    <img src="/impact/${photo.file_path}" class="photo-preview" alt="Current Photo" style="height: 80px; width: 100%;">
                                    <button type="button" class="btn btn-sm btn-danger position-absolute top-0 end-0 rounded-circle p-0" 
                                            style="width: 24px; height: 24px; line-height: 1;"
                                            onclick="deletePhotoFromEdit(${photo.id}, this)" title="Hapus foto">
                                        <i class="fas fa-times"></i>
                                    </button>
                                    <div class="small text-muted text-truncate">${photo.filename}</div>
                                </div>
                            `).join('');
                            
                            document.getElementById('currentPhotosPreview').innerHTML = `
                                <div class="mt-2">
                                    <label class="form-label">Foto Saat Ini (${log.photos.length}):</label><br>
                                    <div class="row">
                                        ${photosHtml}
                                    </div>
                                </div>
                            `;
                        } else {
                            document.getElementById('currentPhotosPreview').innerHTML = '';
                        }
                        
                        // Show current documents if exists
                        if (log.documents && log.documents.length > 0) {
                            const documentsHtml = log.documents.map(doc => `
                                <div class="col-md-6 mb-2 position-relative">
                                    <div class="btn-group w-100" role="group">
                                        <a href="/impact/${doc.file_path}" target="_blank" class="btn btn-sm btn-outline-${doc.file_type === 'pdf' ? 'danger' : doc.file_type === 'zip' ? 'warning' : 'primary'} flex-grow-1">
                                            <i class="fas fa-${doc.file_type === 'pdf' ? 'file-pdf' : doc.file_type === 'zip' ? 'file-archive' : 'file-word'}"></i>
                                            ${doc.filename}
                                        </a>
                                        <button type="button" class="btn btn-sm btn-danger" 
                                                onclick="deleteDocumentFromEdit(${doc.id}, this)" title="Hapus dokumen">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                </div>
                            `).join('');
                            
                            document.getElementById('currentDocumentsPreview').innerHTML = `
                                <div class="mt-2">
                                    <label class="form-label">Dokumen Saat Ini (${log.documents.length}):</label><br>
                                    <div class="row">
                                        ${documentsHtml}
                                    </div>
                                </div>
                            `;
                        } else {
                            document.getElementById('currentDocumentsPreview').innerHTML = '';
                        }
                        
                        // Show legacy single photo if exists
                        if (log.problem_photo) {
                            const photoPath = log.problem_photo.startsWith('uploads/') ? log.problem_photo : 'uploads/' + log.problem_photo;
                            const legacyPhotoHtml = `
                                <div class="mt-2">
                                    <label class="form-label">Foto Lama (Single):</label><br>
                                    <img src="/impact/${photoPath}" class="photo-preview" alt="Current Photo" style="height: 80px;">
                                </div>
                            `;
                            
                            // Append to current photos preview
                            const currentPhotosContainer = document.getElementById('currentPhotosPreview');
                            if (currentPhotosContainer.innerHTML) {
                                currentPhotosContainer.innerHTML += legacyPhotoHtml;
                            } else {
                                currentPhotosContainer.innerHTML = legacyPhotoHtml;
                            }
                        }
                        
                        // Handle technician type change
                        handleEditTechnicianTypeChange();
                        
                        // Show the edit modal
                        const editModal = new bootstrap.Modal(document.getElementById('editProblemModal'));
                        editModal.show();
                    } else {
                        showToast('Gagal memuat data problem', 'danger');
                    }
                })
                .catch(error => {
                    console.error('Error loading problem data:', error);
                    showToast('Gagal memuat data problem', 'danger');
                });
        }

        function updateProblem() {
            const form = document.getElementById('editProblemForm');
            
            // Validate required fields
            const problemDescription = document.getElementById('editProblemDescription').value.trim();
            const technicianType = document.getElementById('editTechnicianType').value;
            const problemDate = document.getElementById('editProblemDate').value;
            const problemId = document.getElementById('editProblemId').value;
            const errorCode = document.getElementById('editErrorCode').value.trim();
            
            if (!problemDescription || !technicianType || !problemDate) {
                showToast('Mohon lengkapi field yang wajib diisi', 'warning');
                return;
            }
            
            showLoading();
            
            // First, delete marked photos and documents
            const deletePromises = [];
            
            // Delete photos that are marked for deletion
            for (let photoId of photosToDelete) {
                deletePromises.push(
                    fetch(`/impact/api/ctp-problem-photos/${photoId}`, {
                        method: 'DELETE'
                    }).then(response => response.json())
                );
            }
            
            // Delete documents that are marked for deletion
            for (let docId of documentsToDelete) {
                deletePromises.push(
                    fetch(`/impact/api/ctp-problem-documents/${docId}`, {
                        method: 'DELETE'
                    }).then(response => response.json())
                );
            }
            
            // After all deletions complete, proceed with update
            Promise.all(deletePromises)
                .then(responses => {
                    // Check if any deletions failed
                    const deletionErrors = responses.filter(r => !r.success);
                    if (deletionErrors.length > 0) {
                        hideLoading();
                        showToast('Beberapa file gagal dihapus, tapi data tetap diupdate', 'warning');
                        return;
                    }
                    
                    // Clear deletion arrays after successful delete
                    photosToDelete = [];
                    documentsToDelete = [];
                    
                    // Now proceed with update
                    proceedWithUpdate();
                })
                .catch(error => {
                    hideLoading();
                    console.error('Error deleting files:', error);
                    showToast('Gagal menghapus file', 'danger');
                });
            
            function proceedWithUpdate() {
                // Check if photos or documents are being added
                const photoFiles = document.getElementById('editProblemPhotos').files;
                const documentFiles = document.getElementById('editProblemDocuments').files;
                
                if (photoFiles.length > 0 || documentFiles.length > 0) {
                    // If files are being updated, use FormData
                    const formData = new FormData();
                    formData.append('problem_description', problemDescription);
                    formData.append('error_code', errorCode);
                    formData.append('technician_type', technicianType);
                    formData.append('technician_name', document.getElementById('editTechnicianName').value);
                    formData.append('solution', document.getElementById('editSolution').value);
                    formData.append('start_time', problemDate);
                    
                    // Add multiple photos
                    for (let i = 0; i < photoFiles.length; i++) {
                        formData.append('problem_photos', photoFiles[i]);
                    }
                    
                    // Add multiple documents
                    for (let i = 0; i < documentFiles.length; i++) {
                        formData.append('problem_documents', documentFiles[i]);
                    }
                    
                    fetch(`/impact/api/ctp-problem-logs/${problemId}`, {
                        method: 'PUT',
                        body: formData
                    })
                    .then(response => response.json())
                    .then(data => {
                        hideLoading();
                        if (data.success) {
                            showToast('Problem berhasil diupdate', 'success');
                            bootstrap.Modal.getInstance(document.getElementById('editProblemModal')).hide();
                            form.reset();
                            document.getElementById('currentPhotosPreview').innerHTML = '';
                            document.getElementById('currentDocumentsPreview').innerHTML = '';
                            photosToDelete = [];
                            documentsToDelete = [];
                            loadProblems();
                            updateStatistics(currentMachineId);
                        } else {
                            showToast('Gagal mengupdate problem: ' + (data.error || 'Unknown error'), 'danger');
                        }
                    })
                    .catch(error => {
                        hideLoading();
                        console.error('Error updating problem:', error);
                        showToast('Gagal mengupdate problem', 'danger');
                    });
                } else {
                    // If no file update, use JSON
                    fetch(`/impact/api/ctp-problem-logs/${problemId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            problem_description: problemDescription,
                            error_code: errorCode,
                            technician_type: technicianType,
                            technician_name: document.getElementById('editTechnicianName').value,
                            solution: document.getElementById('editSolution').value,
                            start_time: problemDate
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        hideLoading();
                        if (data.success) {
                            showToast('Problem berhasil diupdate', 'success');
                            bootstrap.Modal.getInstance(document.getElementById('editProblemModal')).hide();
                            form.reset();
                            document.getElementById('currentPhotosPreview').innerHTML = '';
                            document.getElementById('currentDocumentsPreview').innerHTML = '';
                            photosToDelete = [];
                            documentsToDelete = [];
                            loadProblems();
                            updateStatistics(currentMachineId);
                        } else {
                            showToast('Gagal mengupdate problem: ' + (data.error || 'Unknown error'), 'danger');
                        }
                    })
                    .catch(error => {
                        hideLoading();
                        console.error('Error updating problem:', error);
                        showToast('Gagal mengupdate problem', 'danger');
                    });
                }
            }
        }

        function previewEditPhoto(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('editPhotoPreview').innerHTML =
                        `<img src="${e.target.result}" class="photo-preview" alt="Preview">`;
                };
                reader.readAsDataURL(file);
            }
        }

        function handleEditTechnicianTypeChange() {
            const technicianType = document.getElementById('editTechnicianType').value;
            const technicianNameField = document.getElementById('editTechnicianName');
            
            if (technicianType === 'none') {
                // If "Tidak memanggil teknisi" is selected, clear and disable the name field
                technicianNameField.value = '';
                technicianNameField.disabled = true;
                technicianNameField.placeholder = 'Tidak berlaku';
            } else {
                // Enable the name field for other options
                technicianNameField.disabled = false;
                if (technicianType === 'lokal') {
                    technicianNameField.placeholder = 'Nama teknisi lokal...';
                } else if (technicianType === 'vendor') {
                    technicianNameField.placeholder = 'Nama teknisi vendor...';
                } else {
                    technicianNameField.placeholder = 'Nama teknisi...';
                }
            }
        }

        function handleTechnicianTypeChange() {
            const technicianType = document.getElementById('technicianType').value;
            const technicianNameField = document.getElementById('technicianName');
            
            if (technicianType === 'none') {
                // If "Tidak memanggil teknisi" is selected, clear and disable the name field
                technicianNameField.value = '';
                technicianNameField.disabled = true;
                technicianNameField.placeholder = 'Tidak berlaku';
            } else {
                // Enable the name field for other options
                technicianNameField.disabled = false;
                if (technicianType === 'lokal') {
                    technicianNameField.placeholder = 'Nama teknisi lokal...';
                } else if (technicianType === 'vendor') {
                    technicianNameField.placeholder = 'Nama teknisi vendor...';
                } else {
                    technicianNameField.placeholder = 'Nama teknisi...';
                }
            }
        }

        function previewPhoto(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('photoPreview').innerHTML = 
                        `<img src="${e.target.result}" class="photo-preview" alt="Preview">`;
                };
                reader.readAsDataURL(file);
            }
        }

        function previewMultiplePhotos(event, previewContainerId) {
            const files = event.target.files;
            const previewContainer = document.getElementById(previewContainerId);
            previewContainer.innerHTML = '';
            
            // Validasi jumlah maksimal
            if (files.length > 20) {
                showToast('Maksimal 20 foto yang diizinkan', 'warning');
                event.target.value = '';
                return;
            }
            
            // Validasi tipe file
            const validTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
            for (let file of files) {
                if (!validTypes.includes(file.type)) {
                    showToast('Hanya file JPG, PNG, GIF, dan WebP yang diizinkan', 'warning');
                    event.target.value = '';
                    return;
                }
            }
            
            // Tampilkan preview dalam grid
            const previewRow = document.createElement('div');
            previewRow.className = 'row';
            
            Array.from(files).forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const photoCol = document.createElement('div');
                    photoCol.className = 'col-md-3 mb-2';
                    photoCol.innerHTML = `
                        <div class="position-relative">
                            <img src="${e.target.result}" class="photo-preview w-100" alt="Preview ${index + 1}" style="height: 100px; object-fit: cover;">
                            <button type="button" class="btn btn-sm btn-danger position-absolute top-0 end-0 m-1" onclick="removePhotoFromPreview(this)">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    `;
                    previewRow.appendChild(photoCol);
                };
                reader.readAsDataURL(file);
            });
            
            previewContainer.appendChild(previewRow);
        }

        function previewDocuments(event, previewContainerId) {
            const files = event.target.files;
            const previewContainer = document.getElementById(previewContainerId);
            previewContainer.innerHTML = '';
            
            // Validasi jumlah maksimal
            if (files.length > 5) {
                showToast('Maksimal 5 dokumen yang diizinkan', 'warning');
                event.target.value = '';
                return;
            }
            
            // Validasi tipe file
            const validTypes = ['application/pdf', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document', 'application/zip', 'application/x-zip-compressed'];
            for (let file of files) {
                if (!validTypes.includes(file.type)) {
                    showToast('Hanya file PDF, DOCX, dan ZIP yang diizinkan', 'warning');
                    event.target.value = '';
                    return;
                }
                
                // Validasi ukuran file ZIP maksimal 50MB
                if (file.type === 'application/zip' || file.type === 'application/x-zip-compressed') {
                    if (file.size > 50 * 1024 * 1024) { // 50MB
                        showToast('File ZIP maksimal 50MB', 'warning');
                        event.target.value = '';
                        return;
                    }
                }
            }
            
            // Tampilkan preview
            Array.from(files).forEach((file, index) => {
                const docDiv = document.createElement('div');
                docDiv.className = 'col-md-12 mb-2';
                
                // Tentukan icon berdasarkan tipe file
                let iconClass = '';
                let iconColor = '';
                if (file.type === 'application/pdf') {
                    iconClass = 'file-pdf';
                    iconColor = 'text-danger';
                } else if (file.type === 'application/zip' || file.type === 'application/x-zip-compressed') {
                    iconClass = 'file-archive';
                    iconColor = 'text-warning';
                } else {
                    iconClass = 'file-word';
                    iconColor = 'text-primary';
                }
                
                docDiv.innerHTML = `
                    <div class="d-flex align-items-center p-2 border rounded">
                        <i class="fas fa-${iconClass} ${iconColor} me-2"></i>
                        <span class="flex-grow-1">${file.name}</span>
                        <span class="text-muted me-2">${(file.size / 1024 / 1024).toFixed(2)} MB</span>
                        <button type="button" class="btn btn-sm btn-danger" onclick="removeDocumentFromPreview(this)">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `;
                previewContainer.appendChild(docDiv);
            });
        }

        function removePhotoFromPreview(button) {
            const photoDiv = button.closest('.col-md-3');
            if (photoDiv) {
                photoDiv.remove();
            }
        }

        function removeDocumentFromPreview(button) {
            const docDiv = button.closest('.col-md-12');
            if (docDiv) {
                docDiv.remove();
            }
        }

        function deletePhotoFromEdit(photoId, button) {
            // Add photo ID to deletion list
            if (!photosToDelete.includes(photoId)) {
                photosToDelete.push(photoId);
            }

            // Remove the photo element from UI
            const photoDiv = button.closest('.col-md-3');
            if (photoDiv) {
                photoDiv.remove();
            }
        }

        function deleteDocumentFromEdit(documentId, button) {
            // Add document ID to deletion list
            if (!documentsToDelete.includes(documentId)) {
                documentsToDelete.push(documentId);
            }

            // Remove the document element from UI
            const docDiv = button.closest('.col-md-6');
            if (docDiv) {
                docDiv.remove();
            }
            showToast('Dokumen akan dihapus saat Anda klik Update', 'info');
        }

        function showPhoto(filename) {
            // Check if the path already includes 'uploads/' to avoid duplication
            const imagePath = filename.startsWith('uploads/') ? filename : `uploads/${filename}`;
            document.getElementById('modalPhoto').src = `/impact/${imagePath}`;
            
            // Create photo modal with higher z-index
            const photoModal = new bootstrap.Modal(document.getElementById('photoModal'), {
                backdrop: true,
                keyboard: true
            });
            
            // Ensure proper z-index handling
            photoModal.show();
            
            // Force z-index update after modal is shown
            setTimeout(() => {
                const modalBackdrop = document.querySelector('.modal-backdrop:last-child');
                const photoModalElement = document.getElementById('photoModal');
                
                if (modalBackdrop) {
                    modalBackdrop.style.zIndex = '1059';
                }
                if (photoModalElement) {
                    photoModalElement.style.zIndex = '1060';
                }
            }, 100);
        }

        function viewProblemDetail(logId) {
            // Fetch the complete problem details including photo
            fetch(`/impact/api/ctp-problem-logs/${logId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const log = data.data;
                        
                        // Create modal content with complete details
                        const modalHtml = `
                            <div class="modal fade" id="problemDetailModal" tabindex="-1">
                                <div class="modal-dialog modal-lg">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h5 class="modal-title">
                                                <i class="fas fa-info-circle me-2"></i>
                                                Detail Problem
                                            </h5>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                        </div>
                                        <div class="modal-body">
                                            <div class="mb-3">
                                                <div class="mb-2">
                                                    <strong>Status</strong>
                                                </div>
                                                <div>
                                                    ${log.status === 'completed'
                                                        ? '<span class="badge bg-success">Selesai</span>'
                                                        : '<span class="badge bg-warning">Berjalan</span>'}
                                                </div>
                                            </div>
                                            
                                            <div class="mb-3 row">
                                                <div class="col-6"> 
                                                    <div class="mb-2">
                                                        <strong>Tanggal & Jam Mulai</strong>
                                                    </div>
                                                    <div>
                                                        ${formatDate(log.problem_date)}
                                                    </div>
                                                </div>
                                                
                                                ${log.end_time ? `
                                                <div class="col-6"> 
                                                    <div class="mb-2">
                                                        <strong>Tanggal & Jam Selesai</strong>
                                                    </div>
                                                    <div>
                                                        ${formatDate(log.end_time)}
                                                    </div>
                                                </div>
                                                ` : ''}
                                            </div>

                                            <div class="mb-3 row">
                                                <div class="col-6">
                                                    <div class="mb-2">
                                                        <strong>Error Code</strong>
                                                    </div>
                                                    <div>${log.error_code || '-'}</div>
                                                </div>
                                                
                                                <div class="col-6">
                                                    <div class="mb-2">
                                                        <strong>PIC</strong>
                                                    </div>
                                                    <div>${log.created_by_name || '-'}</div>
                                                </div>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <div class="mb-2">
                                                    <strong>Deskripsi Problem</strong>
                                                </div>
                                                <div class="problem-description-wrap">${log.problem_description ? log.problem_description.trim() : ''}</div>
                                            </div>
                                            
                                            <div class="mb-3 row">
                                                <div class="col-6"> 
                                                    <div class="mb-2">
                                                        <strong>Teknisi</strong>
                                                    </div>
                                                    <div>
                                                        ${log.technician_name || '-'}
                                                    </div>
                                                </div>
                                                
                                                <div class="col-6">
                                                    <div class="mb-2">
                                                        <strong>Jenis Teknisi</strong>
                                                    </div>
                                                    <div>
                                                        ${log.technician_type === 'lokal'
                                                        ? '<span class="badge bg-info">Lokal</span>'
                                                        : log.technician_type === 'vendor'
                                                        ? '<span class="badge bg-info">Vendor</span>'
                                                        : '<span class="badge bg-info">Tidak memanggil teknisi</span>'}
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <div class="mb-2">
                                                    <strong>Solusi</strong>
                                                </div>
                                                <div class="solution-wrap">${log.solution ? log.solution.trim() : '-'}</div>
                                            </div>
                                            
                                            ${log.downtime_hours ? `
                                            <div class="mb-3">
                                                <div class="mb-2">
                                                    <strong>Downtime</strong>
                                                </div>
                                                <div>
                                                    ${formatDowntime(log.downtime_hours)}
                                                </div>
                                            </div>
                                            ` : ''}
                                            ${log.photos && log.photos.length > 0 ? `
                                            <div class="mb-3">
                                                <strong>Foto Problem (${log.photos.length}):</strong><br>
                                                <div class="row">
                                                    ${log.photos.map(photo => `
                                                        <div class="col-md-3 mb-2">
                                                            <img src="/impact/${photo.file_path}" class="img-fluid rounded" alt="Problem Photo" style="max-height: 150px; cursor: pointer;" onclick="showPhoto('${photo.file_path}')">
                                                        </div>
                                                    `).join('')}
                                                </div>
                                            </div>
                                            ` : ''}
                                            
                                            ${log.documents && log.documents.length > 0 ? `
                                            <div class="mb-3">
                                                <strong>Dokumen Lampiran:</strong><br>
                                                ${log.documents.map(doc => `
                                                    <div class="mb-2">
                                                        <a href="/impact/${doc.file_path}" target="_blank" class="btn btn-sm btn-outline-${doc.file_type === 'pdf' ? 'danger' : doc.file_type === 'zip' ? 'warning' : 'primary'}">
                                                            <i class="fas fa-${doc.file_type === 'pdf' ? 'file-pdf' : doc.file_type === 'zip' ? 'file-archive' : 'file-word'}"></i>
                                                            ${doc.filename}
                                                        </a>
                                                    </div>
                                                `).join('')}
                                            </div>
                                            ` : ''}
                                            
                                            ${log.problem_photo ? `
                                            <div class="mb-3">
                                                <strong>Foto Lama (Single):</strong><br>
                                                <img src="/impact/${log.problem_photo.startsWith('uploads/') ? log.problem_photo : 'uploads/' + log.problem_photo}" class="img-fluid rounded" alt="Problem Photo" style="max-height: 300px; cursor: pointer;" onclick="showPhoto('${log.problem_photo}')">
                                            </div>
                                            ` : ''}
                                        </div>
                                        <div class="modal-footer">
                                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                        
                        // Add modal to page
                        document.body.insertAdjacentHTML('beforeend', modalHtml);
                        
                        // Show modal
                        const modal = new bootstrap.Modal(document.getElementById('problemDetailModal'));
                        modal.show();
                        
                        // Remove modal from DOM when hidden
                        document.getElementById('problemDetailModal').addEventListener('hidden.bs.modal', function() {
                            document.getElementById('problemDetailModal').remove();
                        });
                    } else {
                        showToast('Gagal memuat detail problem', 'danger');
                    }
                })
                .catch(error => {
                    console.error('Error loading problem detail:', error);
                    showToast('Gagal memuat detail problem', 'danger');
                });
        }

        function completeProblem(logId) {
            // Get current Jakarta time for default
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const defaultEndTime = `${year}-${month}-${day}T${hours}:${minutes}`;
            
            // Create modal content
            const modalHtml = `
                <div class="modal fade" id="completeProblemModal" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">
                                    <i class="fas fa-check-circle me-2"></i>
                                    Selesaikan Problem
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="mb-3">
                                    <label for="endTimeInput" class="form-label">Waktu Selesai</label>
                                    <input type="datetime-local" class="form-control" id="endTimeInput" value="${defaultEndTime}">
                                    <small class="text-muted">Format: DD-MM-YYYY HH:MM (Waktu Jakarta)</small>
                                    <div class="mt-2 p-2 bg-light rounded">
                                        <small class="text-muted">
                                            <strong>Waktu saat ini:</strong> ${formatJakartaTimeForDisplay(defaultEndTime)}
                                        </small>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="solutionInput" class="form-label">Solusi <span class="text-danger">*</span></label>
                                    <textarea class="form-control" id="solutionInput" rows="3" placeholder="Jelaskan solusi yang dilakukan untuk menyelesaikan problem..." required></textarea>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                                <button type="button" class="btn btn-primary" id="confirmCompleteBtn">Selesaikan</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Add modal to page
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('completeProblemModal'));
            modal.show();
            
            // Handle confirm button click
            document.getElementById('confirmCompleteBtn').addEventListener('click', function() {
                const endTime = document.getElementById('endTimeInput').value;
                const solution = document.getElementById('solutionInput').value.trim();
                
                if (!solution) {
                    showToast('Mohon isi solusi untuk menyelesaikan problem', 'warning');
                    return;
                }
                
                if (endTime) {
                    modal.hide();
                    showLoading();
                    fetch(`/impact/api/ctp-problem-logs/${logId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            end_time: endTime,
                            solution: solution
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        hideLoading();
                        if (data.success) {
                            showToast('Problem berhasil diselesaikan', 'success');
                            loadProblems();
                            updateStatistics(currentMachineId);
                        } else {
                            showToast('Gagal menyelesaikan problem', 'danger');
                        }
                    })
                    .catch(error => {
                        hideLoading();
                        console.error('Error completing problem:', error);
                        showToast('Gagal menyelesaikan problem', 'danger');
                    });
                } else {
                    showToast('Mohon masukkan waktu selesai', 'warning');
                }
            });
            
            // Remove modal from DOM when hidden
            document.getElementById('completeProblemModal').addEventListener('hidden.bs.modal', function() {
                document.getElementById('completeProblemModal').remove();
            });
        }

        function deleteProblem(logId) {
            // Check if user is admin and problem is completed
            if (currentUserRole !== 'admin') {
                showToast('Hanya admin yang dapat menghapus problem yang sudah selesai', 'warning');
                return;
            }
            
            // Show confirmation modal instead of browser confirm
            const modal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
            modal.show();
            
            // Handle confirm button click
            document.getElementById('confirmDeleteBtn').onclick = function() {
                modal.hide();
                showLoading();
                fetch(`/impact/api/ctp-problem-logs/${logId}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    hideLoading();
                    if (data.success) {
                        showToast('Problem berhasil dihapus', 'success');
                        loadProblems();
                        updateStatistics(currentMachineId);
                    } else {
                        showToast('Gagal menghapus problem', 'danger');
                    }
                })
                .catch(error => {
                    hideLoading();
                    console.error('Error deleting problem:', error);
                    showToast('Gagal menghapus problem', 'danger');
                });
            };
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            const day = date.getDate();
            const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const month = monthNames[date.getMonth()];
            const year = date.getFullYear().toString().slice(-2); // Get last 2 digits
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            
            return `${day} ${month} ${year} ${hours}:${minutes}`;
        }

        function formatDowntime(hours) {
            if (!hours || hours === 0) return '-';
            
            const wholeHours = Math.floor(hours);
            const minutes = Math.round((hours - wholeHours) * 60);
            
            if (minutes === 0) {
                return `${wholeHours} jam`;
            } else if (wholeHours === 0) {
                return `${minutes} menit`;
            } else {
                return `${wholeHours} jam ${minutes} menit`;
            }
        }

        let loadingCount = 0;
        
        function showLoading() {
            loadingCount++;
            document.getElementById('loadingOverlay').classList.remove('d-none');
        }

        function hideLoading() {
            loadingCount--;
            if (loadingCount <= 0) {
                loadingCount = 0; // Reset to prevent negative values
                document.getElementById('loadingOverlay').classList.add('d-none');
            }
        }

        function showToast(message, type = 'success') {
            const toastContainer = document.createElement('div');
            toastContainer.style.position = 'fixed';
            toastContainer.style.top = '1rem';
            toastContainer.style.right = '1rem';
            toastContainer.style.zIndex = '1050';
            
            toastContainer.innerHTML = `
                <div class="toast align-items-center text-white bg-${type} border-0" role="alert">
                    <div class="d-flex">
                        <div class="toast-body">${message}</div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(toastContainer);
            const toast = new bootstrap.Toast(toastContainer.querySelector('.toast'));
            toast.show();
            
            toastContainer.querySelector('.toast').addEventListener('hidden.bs.toast', () => {
                toastContainer.remove();
            });
        }
        
        function formatJakartaTimeForDisplay(isoString) {
            const date = new Date(isoString);
            const day = date.getDate();
            const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const month = monthNames[date.getMonth()];
            const year = date.getFullYear().toString().slice(-2); // Get last 2 digits
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            
            return `${day} ${month} ${year} ${hours}:${minutes}`;
        }
        
        function changeMachineStatus(newStatus) {
            if (!currentMachineId) {
                showToast('Machine ID tidak ditemukan', 'danger');
                return;
            }
            
            // Get status labels in Indonesian
            const statusLabels = {
                'active': 'Aktif',
                'maintenance': 'Perbaikan',
                'cleaning': 'Pembersihan'
            };
            
            // Get status descriptions and colors
            const statusInfo = {
                'active': {
                    description: 'Mesin akan siap untuk operasi produksi normal',
                    color: 'success'
                },
                'maintenance': {
                    description: 'Mesin akan dalam status perbaikan dan tidak dapat digunakan',
                    color: 'warning'
                },
                'cleaning': {
                    description: 'Mesin akan dalam status pembersihan dan maintenance rutin',
                    color: 'info'
                }
            };
            
            // Update modal content
            document.getElementById('statusChangeMessage').textContent =
                `Apakah Anda yakin ingin mengubah status mesin menjadi "${statusLabels[newStatus]}"?`;
            
            document.getElementById('statusChangeInfoText').textContent = statusInfo[newStatus].description;
            
            // Update modal button color based on status
            const confirmBtn = document.getElementById('confirmStatusChangeBtn');
            confirmBtn.className = `btn btn-${statusInfo[newStatus].color}`;
            confirmBtn.innerHTML = `<i class="fas fa-check me-1"></i>Ya, Ubah Status`;
            
            // Update alert color based on status
            const alertDiv = document.getElementById('statusChangeInfo');
            alertDiv.className = `alert status-change-alert ${statusInfo[newStatus].color}`;
            
            // Update icon color based on status
            const iconElement = document.querySelector('#statusChangeModal .status-change-icon');
            iconElement.className = `fas fa-question-circle fa-3x text-${statusInfo[newStatus].color} text-center d-block mb-3 status-change-icon`;
            
            // Show modal
            const statusModal = new bootstrap.Modal(document.getElementById('statusChangeModal'));
            statusModal.show();
            
            // Handle confirm button click
            document.getElementById('confirmStatusChangeBtn').onclick = function() {
                statusModal.hide();
                showLoading();
                
                fetch(`/impact/api/ctp-machines/${currentMachineId}/status`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        status: newStatus
                    })
                })
                .then(response => response.json())
                .then(data => {
                    hideLoading();
                    if (data.success) {
                        showToast(`Status mesin berhasil diubah menjadi "${statusLabels[newStatus]}"`, 'success');
                        
                        // Update the status badge in the UI
                        const statusBadge = document.getElementById('machineStatusBadge');
                        statusBadge.textContent = statusLabels[newStatus].toUpperCase();
                        statusBadge.className = `status-badge status-${newStatus}`;
                        
                        // Update machine status in the global variable
                        machineStatus = newStatus;
                    } else {
                        showToast('Gagal mengubah status mesin: ' + (data.error || 'Unknown error'), 'danger');
                    }
                })
                .catch(error => {
                    hideLoading();
                    console.error('Error changing machine status:', error);
                    showToast('Gagal mengubah status mesin', 'danger');
                });
            };
        }

        // Export functionality
        function showExportModal() {
            // Set default date range: from first day of current month to today
            const today = new Date();
            const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);

            const dateFromInput = document.getElementById('exportDateFrom');
            const dateToInput = document.getElementById('exportDateTo');

            if (dateFromInput && dateToInput) {
                dateFromInput.value = firstDayOfMonth.toISOString().split('T')[0];
                dateToInput.value = today.toISOString().split('T')[0];
            }

            const modal = new bootstrap.Modal(document.getElementById('exportModal'));
            modal.show();
        }
        
        document.getElementById('confirmExport').addEventListener('click', function() {
            const format = document.querySelector('input[name="format"]:checked').value;
            const date_from = document.getElementById('exportDateFrom').value;
            const date_to = document.getElementById('exportDateTo').value;
            
            // Validasi wajib: rentang tanggal harus diisi
            if (!date_from || !date_to) {
                showToast('Harap isi rentang tanggal', 'warning');
                return;
            }

            let queryParams = [];
            queryParams.push(`machine_nickname=${encodeURIComponent(currentMachineNickname)}`);
            queryParams.push(`format=${encodeURIComponent(format)}`);
            queryParams.push(`date_from=${encodeURIComponent(date_from)}`);
            queryParams.push(`date_to=${encodeURIComponent(date_to)}`);
            
            const queryString = '?' + queryParams.join('&');
            
            // Show loading state
            showLoading();
            
            // Fetch export data to check for errors first
            fetch(`/impact/export-ctp-logs${queryString}`)
                .then(response => {
                    hideLoading();
                    
                    // Check if response is JSON error (not file download)
                    if (response.headers.get('content-type')?.includes('application/json')) {
                        return response.json().then(data => {
                            if (data.success === false) {
                                showToast(data.error || 'Export gagal', 'danger');
                                return;
                            }
                        });
                    }
                    
                    // If it's a file download, proceed with download
                    window.open(`/impact/export-ctp-logs${queryString}`, '_blank');
                    bootstrap.Modal.getInstance(document.getElementById('exportModal')).hide();
                    showToast('Export berhasil dimulai, file akan segera didownload', 'success');
                })
                .catch(error => {
                    hideLoading();
                    console.error('Export error:', error);
                    showToast('Terjadi kesalahan saat melakukan export', 'danger');
                });
        });

    </script>
</body>
</html>