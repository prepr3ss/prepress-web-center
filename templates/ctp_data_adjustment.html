<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Impact 360</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <style>
        /* Clean and Professional Styling for CTP */
        .page-header {
            background: linear-gradient(135deg, #ff9500 0%, #ff6b00 100%);
            color: white;
            padding: 2rem 0;
            margin: -1rem -15px 2rem -15px;
            border-radius: 0 0 20px 20px;
        }
        
        .summary-card {
            border: none;
            border-radius: 15px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            background: white;
        }
        
        .summary-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        
        .summary-card .card-body {
            padding: 1.5rem;
        }
        
        .summary-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1rem auto;
            font-size: 1.5rem;
        }
        
        /* CTP Color Scheme - Menggunakan hijau seperti mounting */
        .icon-warning { background: linear-gradient(135deg, #ff9a56 0%, #ff6b35 100%); }
        .icon-success { background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%); }
        .icon-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .icon-info { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
        .icon-secondary { background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); }
        .icon-dark { background: linear-gradient(135deg, #8360c3 0%, #2ebf91 100%); }
        
        .data-card {
            border: none;
            border-radius: 15px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            background: white;
            overflow: hidden;
        }
        
        .data-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        
        .card-header-clean {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: none;
            padding: 1.25rem;
            border-radius: 15px 15px 0 0;
        }
        
        .status-badge-clean {
            padding: 0.4rem 1rem;
            border-radius: 50px;
            font-size: 0.75rem;
            font-weight: 600;
            letter-spacing: 0.5px;
        }
        
        /* Status badges sesuai mounting */
        .badge-waiting { 
            background: linear-gradient(135deg, #ff9a56 0%, #ff6b35 50%, #ff416c 100%);
            color: white;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
            box-shadow: 0 2px 8px rgba(255, 107, 53, 0.3);
        }
        .badge-process { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #8b5cf6 100%);
            color: white;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }
        .badge-ctp {
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 50%, #0ea5e9 100%);
            color: white;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
            box-shadow: 0 2px 8px rgba(37, 99, 235, 0.3);
        }
        .badge-antar {
            background: linear-gradient(135deg, #8b5cf6 0%, #a855f7 50%, #c084fc 100%);
            color: white;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
            box-shadow: 0 2px 8px rgba(139, 92, 246, 0.3);
        }
        .badge-selesai {
            background: linear-gradient(135deg, #059669 0%, #10b981 50%, #34d399 100%);
            color: white;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
            box-shadow: 0 2px 8px rgba(5, 150, 105, 0.3);
        }
        .badge-warning {
            background: linear-gradient(135deg, #f59e0b 0%, #f97316 50%, #fb923c 100%);
            color: white;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
            box-shadow: 0 2px 8px rgba(245, 158, 11, 0.3);
        }
        
        /* Remarks badges sesuai mounting */
        .remarks-badge-clean {
            padding: 0.3rem 0.8rem;
            border-radius: 50px;
            font-size: 0.65rem;
            font-weight: 600;
            letter-spacing: 0.3px;
            margin-top: 0.5rem;
            display: inline-block;
        }
        
        .badge-fa-proof {
            background: linear-gradient(135deg, #8b5cf6 0%, #a855f7 50%, #c084fc 100%);
            color: white;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
            box-shadow: 0 2px 6px rgba(139, 92, 246, 0.3);
        }
        
        .badge-fa-produksi {
            background: linear-gradient(135deg, #f59e0b 0%, #f97316 50%, #fb923c 100%);
            color: white;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
            box-shadow: 0 2px 6px rgba(245, 158, 11, 0.3);
        }
        
        .badge-curve-proof {
            background: linear-gradient(135deg, #06b6d4 0%, #0891b2 50%, #0e7490 100%);
            color: white;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
            box-shadow: 0 2px 6px rgba(6, 182, 212, 0.3);
        }
        
        .badge-curve-produksi {
            background: linear-gradient(135deg, #84cc16 0%, #65a30d 50%, #4d7c0f 100%);
            color: white;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
            box-shadow: 0 2px 6px rgba(132, 204, 22, 0.3);
        }
        
        .badge-remarks-default {
            background: linear-gradient(135deg, #64748b 0%, #475569 50%, #334155 100%);
            color: white;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
            box-shadow: 0 2px 6px rgba(100, 116, 139, 0.3);
        }
        
        .info-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #ff9500;
        }
        
        /* Info section untuk modal finish dengan border hijau */
        #finishCtpModal .info-section {
            border-left: 4px solid #56ab2f;
        }
        
        .info-label {
            font-size: 0.75rem;
            font-weight: 600;
            color: #6c757d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.25rem;
        }
        
        .info-value {
            font-weight: 600;
            color: #2d3436;
        }
        
        .btn-clean {
            border: none;
            border-radius: 25px;
            padding: 0.5rem 1.5rem;
            font-weight: 600;
            font-size: 0.8rem;
            transition: all 0.3s ease;
            letter-spacing: 0.5px;
        }
        
        /* CTP Button Colors */
        .btn-ctp-clean {
            background: linear-gradient(135deg, #ff9500 0%, #ff6b00 100%);
            color: white;
        }
        .btn-ctp-clean:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 149, 0, 0.4);
            color: white;
        }
        
        .btn-success-clean {
            background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%);
            color: white;
        }
        .btn-success-clean:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(86, 171, 47, 0.4);
            color: white;
        }
        
        .btn-outline-clean {
            border: 2px solid #ff9500;
            color: #ff9500;
            background: transparent;
        }
        .btn-outline-clean:hover {
            background: #ff9500;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 149, 0, 0.3);
        }
        
        .filter-section {
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            margin-bottom: 2rem;
        }
        
        .form-control-clean {
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 0.75rem 1rem;
            transition: all 0.3s ease;
        }
        .form-control-clean:focus {
            border-color: #ff9500;
            box-shadow: 0 0 0 0.2rem rgba(255, 149, 0, 0.25);
        }
        
        .no-data-clean {
            background: white;
            border-radius: 15px;
            padding: 3rem;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }
        
        .loading-clean {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }
        
        /* Toast notifications */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
        }
        
        .toast {
            min-width: 300px;
            border: none;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .toast-success {
            background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%);
            color: white;
        }
        
        .toast-error {
            background: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%);
            color: white;
        }
        
        .toast-info {
            background: linear-gradient(135deg, #ff9500 0%, #ff6b00 100%);
            color: white;
        }
        
        .toast-warning {
            background: linear-gradient(135deg, #f59e0b 0%, #f97316 100%);
            color: white;
        }
    </style>
</head>
<body>
    <div id="wrapper">
        {% include '_top_header.html' %}
        <div class="d-flex" id="content-wrapper">
            {% include '_sidebar.html' %}
            <div id="page-content-wrapper">
                <div class="container-fluid pt-3">
                <!-- Page Header -->
                <div class="page-header">
                    <div class="container-fluid">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h2 class="mb-1 text-white">CTP Data Adjustment</h2>
                                <p class="mb-0 opacity-75">Kelola proses adjustment CTP dengan mudah dan efisien</p>
                            </div>
                            <div class="text-end">
                                <div class="small opacity-75">Sistem Monitoring Prepress</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Filter Section -->
                <div class="filter-section">
                    <div class="row align-items-center">
                        <div class="col-md-7">
                            <div class="row g-3">
                                <div class="col-md-3">
                                    <label class="form-label info-label">Filter Status</label>
                                    <select class="form-control form-control-clean" id="statusFilter">
                                        <option value="">Pilih Status</option>
                                        <option value="proses_ctp">Tunggu Plate</option>
                                        <option value="proses_plate">Proses Plate</option>
                                        <option value="antar_plate">Antar Plate</option>
                                        <option value="selesai">Selesai</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label info-label">Filter Mesin</label>
                                    <select class="form-control form-control-clean" id="mesinFilter">
                                        <option value="">Semua Mesin</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label info-label">Filter Remarks</label>
                                    <select class="form-control form-control-clean" id="remarksFilter">
                                        <option value="">Pilih Remarks</option>
                                        <option value="ADJUSTMENT FA PROOF">FA PROOF</option>
                                        <option value="ADJUSTMENT FA PRODUKSI">FA PRODUKSI</option>
                                        <option value="ADJUSTMENT CURVE PROOF">CURVE PROOF</option>
                                        <option value="ADJUSTMENT CURVE PRODUKSI">CURVE PRODUKSI</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label info-label">Pencarian</label>
                                    <input type="text" class="form-control form-control-clean" id="searchInput" placeholder="Cari Job ID, WO, Item...">
                                </div>
                            </div>
                        </div>
                        <div class="col-md-5 text-end">
                            <div class="d-flex gap-2 justify-content-end align-items-end">
                                <!-- Auto-refresh toggle -->
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="autoRefresh" checked>
                                    <label class="form-check-label small text-muted" for="autoRefresh">
                                        <i class="fas fa-sync-alt me-1"></i>Auto (30s)
                                    </label>
                                </div>
                                <!-- Export button -->
                                <button class="btn btn-success-clean btn-clean" id="exportData">
                                    <i class="fas fa-download me-2"></i>Export Data
                                </button>
                                <!-- Refresh button -->
                                <button class="btn btn-outline-clean btn-clean" id="refreshData">
                                    <i class="fas fa-refresh me-2"></i>Refresh
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Summary Cards -->
                <div class="row g-4 mb-4">
                    <div class="col-lg-3 col-md-6">
                        <div class="card summary-card">
                            <div class="card-body text-center">
                                <div class="summary-icon icon-warning">
                                    <i class="fas fa-clock text-white"></i>
                                </div>
                                <h3 class="mb-1" id="waitingPlateCount">-</h3>
                                <div class="info-label">Tunggu Plate</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <div class="card summary-card">
                            <div class="card-body text-center">
                                <div class="summary-icon icon-success">
                                    <i class="fas fa-check-circle text-white"></i>
                                </div>
                                <h3 class="mb-1" id="completedTodayCount">-</h3>
                                <div class="info-label">Selesai Hari Ini</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <div class="card summary-card">
                            <div class="card-body text-center">
                                <div class="summary-icon icon-primary">
                                    <i class="fas fa-bezier-curve text-white"></i>
                                </div>
                                <h3 class="mb-1" id="totalAdjustmentFACount">-</h3>
                                <div class="info-label">Total Adjustment FA</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <div class="card summary-card">
                            <div class="card-body text-center">
                                <div class="summary-icon icon-info">
                                    <i class="fas fa-bezier-curve text-white"></i>
                                </div>
                                <h3 class="mb-1" id="totalAdjustmentCurveCount">-</h3>
                                <div class="info-label">Total Adjustment Curve</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Data Cards -->
                <div class="row" id="adjustmentCards">
                    <!-- Cards will be loaded here -->
                </div>

                <!-- Loading indicator -->
                <div class="loading-clean" id="loadingIndicator">
                    <div class="spinner-border text-primary mb-3" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <h5 class="text-muted">Memuat data CTP adjustment...</h5>
                    <p class="text-muted mb-0">Mohon tunggu sebentar</p>
                </div>

                <!-- No data message -->
                <div class="no-data-clean d-none" id="noDataMessage">
                    <i class="fas fa-inbox text-muted mb-3" style="font-size: 4rem; opacity: 0.5;"></i>
                    <h4 class="text-muted mb-2">Tidak ada data CTP adjustment</h4>
                    <p class="text-muted mb-0">Belum ada request CTP adjustment yang perlu ditangani saat ini</p>
                </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Start CTP -->
    <div class="modal fade" id="startCtpModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content" style="border: none; border-radius: 15px; overflow: hidden;">
                <div class="modal-header" style="background: linear-gradient(135deg, #ff9500 0%, #ff6b00 100%); color: white; border: none;">
                    <h5 class="modal-title"><i class="fas fa-play me-2"></i>Mulai Proses Plate</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <div class="alert" style="background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%); border: none; border-radius: 10px;">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-info-circle me-2 text-warning"></i>
                            <div>
                                <strong>Konfirmasi Mulai Plate</strong>
                                <div class="small text-muted">Pastikan semua persiapan sudah siap sebelum memulai proses plate</div>
                            </div>
                        </div>
                    </div>
                    <div id="startCtpInfo" class="info-section mb-3"></div>
                    <div class="mb-3">
                        <div class="row g-2 align-items-center mb-2">
                            <div class="col-auto">
                                <label for="ctpGrup" class="form-label info-label mb-0">GRUP</label>
                                <input type="text" name="ctp_grup" id="ctpGrup" class="form-control form-control-clean text-muted" value="{{ current_user.grup }}" readonly tabindex="-1" style="background-color: #f8f9fa; opacity: 1; cursor: not-allowed; min-width: 80px; max-width: 120px; display: inline-block;">
                            </div>
                            <div class="col">
                                <label for="ctpBy" class="form-label info-label mb-0">PIC CTP</label>
                                <input type="text" name="ctp_by" id="ctpBy" class="form-control form-control-clean text-muted" value="{{ current_user.name }}" readonly tabindex="-1" style="background-color: #f8f9fa; opacity: 1; cursor: not-allowed;">
                            </div>
                        </div>
                        <div class="form-text">
                            <i class="fas fa-user me-1 text-muted"></i>
                            Nama ini akan tercatat sebagai PIC yang bertanggung jawab
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-0 p-4">
                    <button type="button" class="btn btn-outline-clean btn-clean" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>Batal
                    </button>
                    <button type="button" class="btn btn-ctp-clean btn-clean" id="confirmStartCtp">
                        <i class="fas fa-play me-1"></i>Mulai Plate
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Finish CTP -->
    <div class="modal fade" id="finishCtpModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content" style="border: none; border-radius: 15px; overflow: hidden;">
                <div class="modal-header" style="background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%); color: white; border: none;">
                    <h5 class="modal-title"><i class="fas fa-check me-2"></i>Selesai Proses Plate</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <div class="alert" style="background: linear-gradient(135deg, #e8f5e8 0%, #f0f8f0 100%); border: none; border-radius: 10px;">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-check-circle me-2 text-success"></i>
                            <div>
                                <strong>Konfirmasi Selesai Plate</strong>
                                <div class="small text-muted">Pastikan semua proses plate sudah selesai dengan baik</div>
                            </div>
                        </div>
                    </div>
                    <div id="finishCtpInfo" class="info-section"></div>
                </div>
                <div class="modal-footer border-0 p-4">
                    <button type="button" class="btn btn-outline-clean btn-clean" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>Batal
                    </button>
                    <button type="button" class="btn btn-success-clean btn-clean" id="confirmFinishCtp">
                        <i class="fas fa-check me-1"></i>Selesai Plate
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Modal Export Data -->
    <div class="modal fade" id="exportModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content" style="border: none; border-radius: 15px; overflow: hidden;">
                <div class="modal-header" style="background: linear-gradient(135deg, #ff9500 0%, #ff6b00 100%); color: white; border: none;">
                    <h5 class="modal-title"><i class="fas fa-download me-2"></i>Export Data CSV</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <div class="alert" style="background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%); border: none; border-radius: 10px;">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-info-circle me-2 text-warning"></i>
                            <div>
                                <strong>Export Data CSV</strong>
                                <div class="small text-muted">File CSV yang dapat dibuka langsung di Excel dengan kolom terpisah</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label info-label">Filter Status</label>
                            <select class="form-control form-control-clean" id="exportStatusFilter">
                                <option value="">Semua Status</option>
                                <option value="menunggu">Menunggu</option>
                                <option value="proses_adjustment">Proses Adjustment</option>
                                <option value="proses_ctp">Proses CTP</option>
                                <option value="selesai">Selesai</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label info-label">Filter Remarks</label>
                            <select class="form-control form-control-clean" id="exportRemarksFilter">
                                <option value="">Semua Remarks</option>
                                <option value="PRODUKSI">PRODUKSI</option>
                                <option value="PROOF">PROOF</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label info-label">Tanggal Dari</label>
                            <input type="date" class="form-control form-control-clean" id="exportDateFrom">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label info-label">Tanggal Sampai</label>
                            <input type="date" class="form-control form-control-clean" id="exportDateTo">
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <div class="small text-muted">
                            <i class="fas fa-lightbulb me-1"></i>
                            <strong>Info Export:</strong>
                            <ul class="mb-0 mt-1">
                                <li>File CSV dengan semicolon delimiter untuk Excel Indonesia</li>
                                <li>17 kolom sesuai database (A, B, C, D, dll)</li>
                                <li>Compatible dengan Excel Indonesia (semicolon separator)</li>
                                <li>Format tanggal: YYYY-MM-DD HH:MM:SS</li>
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-0 p-4">
                    <button type="button" class="btn btn-outline-clean btn-clean" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>Batal
                    </button>
                    <button type="button" class="btn btn-ctp-clean btn-clean" id="confirmExport">
                        <i class="fas fa-download me-1"></i>Download CSV
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Decline Adjustment -->
    <div class="modal fade" id="declineAdjustmentModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content" style="border: none; border-radius: 15px; overflow: hidden;">
                <div class="modal-header" style="background: linear-gradient(135deg, #dc3545 0%, #ff4b2b 100%); color: white; border: none;">
                    <h5 class="modal-title"><i class="fas fa-times-circle me-2"></i>Tolak Adjustment</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <div class="alert" style="background: linear-gradient(135deg, #fff5f5 0%, #ffe5e5 100%); border: none; border-radius: 10px;">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-exclamation-circle me-2 text-danger"></i>
                            <div>
                                <strong>Konfirmasi Tolak Adjustment</strong>
                                <div class="small text-muted">Harap berikan alasan penolakan adjustment ini</div>
                            </div>
                        </div>
                    </div>
                    <div id="declineAdjustmentInfo" class="info-section mb-3"></div>
                    <div class="mb-3">
                        <label for="declineReason" class="form-label info-label">Alasan Penolakan <span class="text-danger">*</span></label>
                        <textarea id="declineReason" class="form-control form-control-clean" rows="3" placeholder="Tuliskan alasan penolakan..."></textarea>
                    </div>
                </div>
                <div class="modal-footer border-0 p-4">
                    <button type="button" class="btn btn-outline-clean btn-clean" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>Batal
                    </button>
                    <button type="button" class="btn btn-danger btn-clean" id="confirmDecline">
                        <i class="fas fa-times-circle me-1"></i>Tolak Adjustment
                    </button>
                </div>
            </div>
        </div>
    </div>    

    <!-- Modal Plate Delivered -->
    <div class="modal fade" id="plateDeliveredModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content" style="border: none; border-radius: 15px; overflow: hidden;">
                <div class="modal-header" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; border: none;">
                    <h5 class="modal-title"><i class="fas fa-truck me-2"></i>Plate Sampai</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <div class="alert" style="background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%); border: none; border-radius: 10px;">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-check-circle me-2 text-success"></i>
                            <div>
                                <strong>Konfirmasi Plate Sampai</strong>
                                <div class="small text-muted">Pastikan plate sudah sampai di mesin cetak dengan baik</div>
                            </div>
                        </div>
                    </div>
                    <div id="plateDeliveredInfo" class="info-section"></div>
                </div>
                <div class="modal-footer border-0 p-4">
                    <button type="button" class="btn btn-outline-clean btn-clean" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>Batal
                    </button>
                    <button type="button" class="btn btn-success-clean btn-clean" id="confirmPlateDelivered">
                        <i class="fas fa-truck me-1"></i>Konfirmasi Plate Sampai
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/js/all.min.js"></script>
    <script src="{{ url_for('static', filename='js/sidebar_handler.js') }}"></script>
    <script src="{{ url_for('static', filename='js/badge_system.js') }}"></script>
    <script src="{{ url_for('static', filename='js/notification_system.js') }}"></script>
    <script>
        let adjustmentData = [];
        let currentAdjustmentId = null;
        
        // Format tanggal Indonesia
        function formatTanggalIndonesia(dateString) {
            if (!dateString || dateString === '-') return dateString;
            
            const bulanIndonesia = [
                'Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni',
                'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'
            ];
            
            let date;
            if (dateString.includes('-')) {
                const parts = dateString.split('-');
                if (parts[0].length === 4) {
                    date = new Date(parts[0], parts[1] - 1, parts[2]);
                } else {
                    date = new Date(parts[2], parts[1] - 1, parts[0]);
                }
            } else {
                date = new Date(dateString);
            }
            
            if (isNaN(date.getTime())) return dateString;
            
            const day = date.getDate();
            const month = bulanIndonesia[date.getMonth()];
            const year = date.getFullYear();
            
            return `${day} ${month} ${year}`;
        }

        // Format datetime Indonesia
        function formatDateTimeIndonesia(datetimeString) {
            if (!datetimeString || datetimeString === '-') return '-';
            
            const bulanIndonesia = [
                'Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni',
                'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'
            ];
            
            let date;
            
            if (datetimeString.includes('T')) {
                const [datePart, timePart] = datetimeString.split('T');
                const [year, month, day] = datePart.split('-');
                const [hour, minute] = timePart.split(':');
                
                date = new Date(year, month - 1, day, hour, minute);
                
                if (!isNaN(date.getTime())) {
                    const dayNum = date.getDate();
                    const monthName = bulanIndonesia[date.getMonth()];
                    const yearNum = date.getFullYear();
                    const hourFormatted = hour.padStart(2, '0');
                    const minuteFormatted = minute.padStart(2, '0');
                    
                    return `${dayNum} ${monthName} ${yearNum} - ${hourFormatted}:${minuteFormatted}`;
                }
            }
            else if (datetimeString.includes(' ')) {
                const [datePart, timePart] = datetimeString.split(' ');
                const [year, month, day] = datePart.split('-');
                const [hour, minute] = timePart.split(':');
                
                date = new Date(year, month - 1, day, hour, minute);
                
                if (!isNaN(date.getTime())) {
                    const dayNum = date.getDate();
                    const monthName = bulanIndonesia[date.getMonth()];
                    const yearNum = date.getFullYear();
                    const hourFormatted = hour.padStart(2, '0');
                    const minuteFormatted = minute.padStart(2, '0');
                    
                    return `${dayNum} ${monthName} ${yearNum} - ${hourFormatted}:${minuteFormatted}`;
                }
            }
            
            return datetimeString;
        }

        // Load data
        async function loadData() {
            // Request notification permission when loading data
            await requestNotificationPermission();
            try {
                document.getElementById('loadingIndicator').style.display = 'block';
                document.getElementById('noDataMessage').classList.add('d-none');
                
                const response = await fetch('/impact/get-ctp-adjustment-data');
                if (!response.ok) throw new Error('Failed to fetch data');
                
                const result = await response.json();
                console.log('API Response:', result); // Debug log
                
                adjustmentData = result.data || [];
                const allData = result.all_data || result.data || [];

                // Check untuk adjustment baru yang menunggu
                const waitingAdjustments = allData.filter(item => item.status === 'proses_ctp');
                if (waitingAdjustments.length > 0) {
                    showBrowserNotification('Adjustment Menunggu', {
                        body: `Terdapat ${waitingAdjustments.length} adjustment yang menunggu untuk diproses`,
                        requireInteraction: false
                    });
                }                
                
                // Use allData instead of adjustmentData for filtering to include completed items
                adjustmentData = allData;
                
                // Filter out menunggu_adjustment and proses_adjustment status from the main data
                adjustmentData = adjustmentData.filter(item => 
                    item.status !== 'menunggu_adjustment' && item.status !== 'proses_adjustment'
                );
                
                console.log('Processed adjustmentData (after filtering adjustment statuses):', adjustmentData); // Debug log
                
                // Sort data: antar_plate first, then proses_plate, then proses_ctp (FIFO by id), then others
                adjustmentData.sort((a, b) => {
                    // Priority sorting: antar_plate (1), proses_plate (2), proses_ctp (3), others (4+)
                    const getPriority = (status) => {
                        switch(status) {
                            case 'antar_plate': return 1;
                            case 'proses_plate': return 2;
                            case 'proses_ctp': return 3;
                            default: return 4;
                        }
                    };
                    
                    const priorityA = getPriority(a.status);
                    const priorityB = getPriority(b.status);
                    
                    if (priorityA !== priorityB) {
                        return priorityA - priorityB;
                    }
                    
                    // Special handling for completed items: sort by machine off time in reverse order
                    if (a.status === 'selesai' && b.status === 'selesai') {
                        const dateA = new Date(a.machine_off_at || 0);
                        const dateB = new Date(b.machine_off_at || 0);
                        return dateB - dateA; // Newest first
                    }
                    
                    // Within same priority, sort by ID FIFO (oldest first for queue)
                    return a.id - b.id;
                });
                
                // Show only active CTP processes on initial load (exclude selesai status)
                const initialData = adjustmentData.filter(item => 
                    item.status === 'proses_ctp' || item.status === 'proses_plate' || item.status === 'antar_plate'
                );
                displayData(initialData);
                updateSummary(allData);
                populateMesinFilter(allData);
                
                // Debug: log data untuk melihat struktur
                console.log('CTP Data loaded:', adjustmentData);
                console.log('All Data loaded:', allData);
                
                // Simple success feedback without details
                // Simple success feedback without details
                showToast('Data berhasil dimuat', 'success', 2000);
                
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('loadingIndicator').style.display = 'none';
                document.getElementById('noDataMessage').classList.remove('d-none');
                
                // Show error details in console
                console.error('Detailed error:', {
                    message: error.message,
                    stack: error.stack
                });
                
                showToast('Gagal memuat data', 'error');
            }
        }

        // Populate mesin filter
        function populateMesinFilter(data) {
            const mesinSet = new Set();
            data.forEach(item => {
                if (item.mesin_cetak) {
                    mesinSet.add(item.mesin_cetak);
                }
            });
            
            const mesinFilter = document.getElementById('mesinFilter');
            mesinFilter.innerHTML = '<option value="">Semua Mesin</option>';
            
            Array.from(mesinSet).sort().forEach(mesin => {
                mesinFilter.innerHTML += `<option value="${mesin}">${mesin}</option>`;
            });
        }

        // Display data cards
        function displayData(data) {
            document.getElementById('loadingIndicator').style.display = 'none';
            const container = document.getElementById('adjustmentCards');
            
            console.log('Displaying data:', data); // Debug log
            
            if (!data || data.length === 0) {
                document.getElementById('noDataMessage').classList.remove('d-none');
                container.innerHTML = '';
                return;
            }
            
            document.getElementById('noDataMessage').classList.add('d-none');
            
            const html = data.map(item => {
                const statusBadge = getStatusBadge(item.status);
                const remarksBadge = getRemarksBadge(item.remarks);
                const actionButtons = getActionButtons(item);
                
                return `
                <div class="col-lg-6 col-xl-4 mb-4">
                    <div class="card data-card h-100">
                        <div class="card-header card-header-clean">
                            <div class="row align-items-center">
                                <div class="col-8">
                                    <h6 class="mb-1 fw-bold text-dark">
                                        <i class="fas fa-box me-2 text-primary"></i>${item.item_name}
                                    </h6>
                                    <small class="text-muted">
                                        <i class="fas fa-industry me-1"></i>${item.mesin_cetak}
                                    </small>
                                </div>
                                <div class="col-4 text-end">
                                    <div class="d-flex flex-column align-items-end">
                                        ${statusBadge}
                                        ${remarksBadge}
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="card-body p-0">
                            <!-- Main Info Section -->
                            <div class="p-3">
                                <div class="row g-3">
                                    <div class="col-6">
                                        <div class="info-label">WO Number</div>
                                        <div class="info-value">${item.wo_number}</div>
                                    </div>
                                    <div class="col-6">
                                        <div class="info-label">MC Number</div>
                                        <div class="info-value">${item.mc_number}</div>
                                    </div>
                                    <div class="col-6">
                                        <div class="info-label">Jumlah Plate</div>
                                        <div class="info-value">
                                            <i class="fas fa-layer-group me-1 text-primary"></i>
                                            ${item.jumlah_plate} plate
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="info-label">Run Length</div>
                                        <div class="info-value">
                                            <i class="fas fa-boxes me-1 text-success"></i>
                                            ${item.run_length}
                                        </div>
                                    </div>
                                    <div class="col-12">
                                        <div class="info-label">Jenis Kertas</div>
                                        <div class="info-value">
                                            <i class="fas fa-file-alt me-1 text-info"></i>
                                            ${item.paper_type || '-'}
                                        </div>
                                    </div>                                      
                                </div>
                                
                                ${item.note ? `
                                <div class="mt-3">
                                    <div class="info-label">Catatan</div>
                                    <div class="small text-muted bg-light p-2 rounded">
                                        <i class="fas fa-sticky-note me-1"></i>
                                        ${item.note}
                                    </div>
                                </div>
                                ` : ''}
                            </div>
                            
                            <!-- Timeline Section -->
                            <div class="info-section mx-3">
                                <div class="info-label mb-2">
                                    <i class="fas fa-clock me-1"></i>Timeline Proses
                                </div>
                                <div class="row g-2">
                                    ${item.machine_off_at ? `
                                    <div class="col-12">
                                        <div class="d-flex align-items-center">
                                            <div class="bg-danger rounded-circle me-2" style="width: 8px; height: 8px;"></div>
                                            <small class="text-muted">Mesin Off:</small>
                                            <small class="ms-auto fw-bold">${formatDateTimeIndonesia(item.machine_off_at)}</small>
                                        </div>
                                    </div>
                                    ` : ''}
                                    
                                    ${!item.is_epson ? `
                                        ${item.pdnd_start_at ? `
                                        <div class="col-12">
                                            <div class="d-flex align-items-center">
                                                <div class="bg-info rounded-circle me-2" style="width: 8px; height: 8px;"></div>
                                                <small class="text-muted">Mulai Adjustment PDND:</small>
                                                <small class="ms-auto fw-bold">${formatDateTimeIndonesia(item.pdnd_start_at)}</small>
                                            </div>
                                        </div>
                                        ` : ''}
                                        ${item.pdnd_finish_at ? `
                                        <div class="col-12">
                                            <div class="d-flex align-items-center">
                                                <div class="bg-success rounded-circle me-2" style="width: 8px; height: 8px;"></div>
                                                <small class="text-muted">Selesai Adjustment PDND:</small>
                                                <small class="ms-auto fw-bold">${formatDateTimeIndonesia(item.pdnd_finish_at)}</small>
                                            </div>
                                        </div>
                                        ` : ''}
                                    ` : ''}
                                    
                                    ${item.is_epson ? `
                                        ${item.design_start_at ? `
                                        <div class="col-12">
                                            <div class="d-flex align-items-center">
                                                <div class="bg-info rounded-circle me-2" style="width: 8px; height: 8px;"></div>
                                                <small class="text-muted">Mulai Adjustment Design:</small>
                                                <small class="ms-auto fw-bold">${formatDateTimeIndonesia(item.design_start_at)}</small>
                                            </div>
                                        </div>
                                        ` : ''}
                                        ${item.design_finish_at ? `
                                        <div class="col-12">
                                            <div class="d-flex align-items-center">
                                                <div class="bg-success rounded-circle me-2" style="width: 8px; height: 8px;"></div>
                                                <small class="text-muted">Selesai Adjustment Design:</small>
                                                <small class="ms-auto fw-bold">${formatDateTimeIndonesia(item.design_finish_at)}</small>
                                            </div>
                                        </div> 
                                        ` : ''}
                                    ` : ''}
                                    
                                    ${item.curve_start_at ? `
                                    <div class="col-12">
                                        <div class="d-flex align-items-center">
                                            <div class="bg-info rounded-circle me-2" style="width: 8px; height: 8px;"></div>
                                            <small class="text-muted">Mulai Adjustment Curve:</small>
                                            <small class="ms-auto fw-bold">${formatDateTimeIndonesia(item.curve_start_at)}</small>
                                        </div>
                                    </div>
                                    ` : ''}
                                    ${item.curve_finish_at ? `
                                    <div class="col-12">
                                        <div class="d-flex align-items-center">
                                            <div class="bg-success rounded-circle me-2" style="width: 8px; height: 8px;"></div>
                                            <small class="text-muted">Selesai Adjustment Curve:</small>
                                            <small class="ms-auto fw-bold">${formatDateTimeIndonesia(item.curve_finish_at)}</small>
                                        </div>
                                    </div>
                                    ` : ''}                                
                                    ${item.adjustment_start_at ? `
                                    <div class="col-12">
                                        <div class="d-flex align-items-center">
                                            <div class="bg-info rounded-circle me-2" style="width: 8px; height: 8px;"></div>
                                            <small class="text-muted">Mulai Mounting:</small>
                                            <small class="ms-auto fw-bold">${formatDateTimeIndonesia(item.adjustment_start_at)}</small>
                                        </div>
                                    </div>
                                    ` : ''}
                                    ${item.adjustment_finish_at ? `
                                    <div class="col-12">
                                        <div class="d-flex align-items-center">
                                            <div class="bg-success rounded-circle me-2" style="width: 8px; height: 8px;"></div>
                                            <small class="text-muted">Selesai Mounting:</small>
                                            <small class="ms-auto fw-bold">${formatDateTimeIndonesia(item.adjustment_finish_at)}</small>
                                        </div>
                                    </div>
                                    ` : ''}
                                    ${item.plate_start_at ? `
                                    <div class="col-12">
                                        <div class="d-flex align-items-center">
                                            <div class="bg-primary rounded-circle me-2" style="width: 8px; height: 8px;"></div>
                                            <small class="text-muted">Mulai Plate:</small>
                                            <small class="ms-auto fw-bold">${formatDateTimeIndonesia(item.plate_start_at)}</small>
                                        </div>
                                    </div>
                                    ` : ''}
                                    ${item.plate_finish_at ? `
                                    <div class="col-12">
                                        <div class="d-flex align-items-center">
                                            <div class="bg-secondary rounded-circle me-2" style="width: 8px; height: 8px;"></div>
                                            <small class="text-muted">Selesai Plate:</small>
                                            <small class="ms-auto fw-bold">${formatDateTimeIndonesia(item.plate_finish_at)}</small>
                                        </div>
                                    </div>
                                    ` : ''}
                                    ${item.plate_delivered_at ? `
                                    <div class="col-12">
                                        <div class="d-flex align-items-center">
                                            <div class="bg-danger rounded-circle me-2" style="width: 8px; height: 8px;"></div>
                                            <small class="text-muted">Plate Sampai:</small>
                                            <small class="ms-auto fw-bold">${formatDateTimeIndonesia(item.plate_delivered_at)}</small>
                                        </div>
                                    </div>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                        <div class="card-footer bg-light border-0 p-3">
                            <div class="d-flex gap-2 justify-content-between">
                                <div class="flex-grow-1">
                                    ${actionButtons}
                                </div>
                                <a href="/impact/detail-adjustment/${item.id}" class="btn btn-outline-clean btn-clean">
                                    <i class="fas fa-eye me-1"></i>Detail
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
                `;
            }).join('');
            
            container.innerHTML = html;
        }

        // Inject current user name for JS logic
        window.currentUserName = "{{ current_user.name }}";
        
        // Get status badge - Using Unified Badge System (Simplified Workflow)
        function getStatusBadge(status) {
            if (window.BadgeSystem) {
                const statusInfo = window.BadgeSystem.getStatusInfo(status, 'ctp');
                if (statusInfo) {
                    return `<span class="badge status-badge ${statusInfo.class}" data-status="${status}">${statusInfo.label}</span>`;
                }
            }
            
            // Fallback untuk CTP division
            const ctpBadges = {
                'proses_ctp': '<span class="badge status-badge badge-menunggu-plate" data-status="proses_ctp">Menunggu Plate</span>',
                'proses_plate': '<span class="badge status-badge badge-proses-plate" data-status="proses_plate">Proses Plate</span>',
                'antar_plate': '<span class="badge status-badge badge-antar" data-status="antar_plate">Plate Sedang Diantar</span>',
                'selesai': '<span class="badge status-badge badge-selesai" data-status="selesai">Selesai</span>'
            };
            return ctpBadges[status] || '<span class="badge status-badge badge-menunggu-plate">Unknown</span>';
        }

        // Get remarks badge
        function getRemarksBadge(remarks) {
            if (!remarks) return '';
            
            const remarksLower = remarks.toLowerCase();
            
            if (remarksLower.includes('adjustment fa proof')) {
                return '<span class="badge remarks-badge-clean badge-fa-proof">FA Proof</span>';
            } else if (remarksLower.includes('adjustment fa produksi')) {
                return '<span class="badge remarks-badge-clean badge-fa-produksi">FA Produksi</span>';
            } else if (remarksLower.includes('adjustment curve proof')) {
                return '<span class="badge remarks-badge-clean badge-curve-proof">Curve Proof</span>';
            } else if (remarksLower.includes('adjustment curve produksi')) {
                return '<span class="badge remarks-badge-clean badge-curve-produksi">Curve Produksi</span>';
            } else {
                // For other remarks, show truncated version
                const shortRemarks = remarks.length > 15 ? remarks.substring(0, 15) + '...' : remarks;
                return `<span class="badge remarks-badge-clean badge-remarks-default">${shortRemarks}</span>`;
            }
        }

        // Fungsi untuk menampilkan modal decline
        function declineAdjustment(id) {
            const item = adjustmentData.find(item => item.id === id);
            if (!item) return;
            
            currentAdjustmentId = id;
            document.getElementById('declineReason').value = '';
            
            document.getElementById('declineAdjustmentInfo').innerHTML = `
                <div class="row g-3">
                    <div class="col-12">
                        <div class="info-label">Item Name</div>
                        <div class="info-value">
                            <i class="fas fa-box me-1 text-danger"></i>
                            ${item.item_name}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="info-label">WO Number</div>
                        <div class="info-value">${item.wo_number}</div>
                    </div>
                    <div class="col-md-6">
                        <div class="info-label">MC Number</div>
                        <div class="info-value">${item.mc_number}</div>
                    </div>
                    <div class="col-12">
                        <div class="info-label">Remarks</div>
                        <div class="info-value">${item.remarks || '-'}</div>
                    </div>
                </div>
            `;
            
            new bootstrap.Modal(document.getElementById('declineAdjustmentModal')).show();
        }

        // Event listener untuk konfirmasi decline
        document.getElementById('confirmDecline').addEventListener('click', async function() {
            const reason = document.getElementById('declineReason').value.trim();
            
            if (!reason) {
                showToast('Harap isi alasan penolakan', 'error');
                return;
            }
            
            try {
                const response = await fetch('/impact/decline-ctp', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        id: currentAdjustmentId,
                        reason: reason,
                        declined_by: window.currentUserName
                    })
                });
                
                if (response.ok) {
                    bootstrap.Modal.getInstance(document.getElementById('declineAdjustmentModal')).hide();
                    showToast('Adjustment berhasil ditolak', 'success');
                    loadData();
                } else {
                    throw new Error('Failed to decline adjustment');
                }
            } catch (error) {
                console.error('Error:', error);
                showToast('Terjadi kesalahan saat menolak adjustment', 'error');
            }
        });

        // Get action buttons
        function getActionButtons(item) {
            if (item.status === 'proses_ctp') {
                return `
                    <div class="d-flex gap-2 w-100">
                        <button class="btn btn-ctp-clean btn-clean flex-grow-1" onclick="startCtp(${item.id})">
                            <i class="fas fa-play me-1"></i>Mulai Plate
                        </button>
                        <button class="btn btn-danger btn-clean" onclick="declineAdjustment(${item.id})">
                            <i class="fas fa-times me-1"></i>Tolak
                        </button>
                    </div>`;
            } else if (item.status === 'proses_plate') {
                if (window.currentUserName && item.ctp_by && window.currentUserName === item.ctp_by) {
                    return `<button class="btn btn-success-clean btn-clean flex-grow-1" onclick="finishCtp(${item.id})">
                        <i class="fas fa-check me-1"></i>Selesai Plate
                    </button>`;
                } else {
                    return `<button class="btn btn-success-clean btn-clean flex-grow-1" hidden title="Hanya operator yang memulai yang bisa menyelesaikan">
                        <i class="fas fa-check me-1"></i>Selesai Plate
                    </button>`;
                }
            } else if (item.status === 'antar_plate') {
                if (window.currentUserName && item.ctp_by && window.currentUserName === item.ctp_by) {
                    return `<button class="btn btn-success-clean btn-clean flex-grow-1" onclick="deliverPlate(${item.id})">
                        <i class="fas fa-truck me-1"></i>Plate Sampai
                    </button>`;
                } else {
                    return `<button class="btn btn-success-clean btn-clean flex-grow-1" hidden title="Hanya operator yang memulai yang bisa menyelesaikan">
                        <i class="fas fa-truck me-1"></i>Plate Sampai
                    </button>`;
                }
            }
            return ''; // Empty string untuk status selesai
        }

        // Update summary
        function updateSummary(data) {
            const today = new Date().toISOString().split('T')[0];
            
            const summary = {
                waitingPlate: data.filter(item => item.status === 'proses_ctp').length,
                completedToday: data.filter(item => 
                    item.status === 'selesai' && 
                    item.plate_finish_at && item.plate_finish_at.startsWith(today)
                ).length,
                totalAdjustmentFA: data.filter(item => 
                     (item.status === 'proses_ctp' ||
                     item.status === 'proses_plate' ||
                     item.status === 'antar_plate' ||
                     item.status === 'selesai') &&
                    (item.remarks.toLowerCase().includes('adjustment fa proof') ||
                     item.remarks.toLowerCase().includes('adjustment fa produksi'))
                ).length,
                totalAdjustmentCurve: data.filter(item => 
                    (item.status === 'proses_ctp' ||
                     item.status === 'proses_plate' ||
                     item.status === 'antar_plate' ||
                     item.status === 'selesai') &&
                    (item.remarks.toLowerCase().includes('adjustment curve proof') ||
                     item.remarks.toLowerCase().includes('adjustment curve produksi'))
                ).length
            };

            document.getElementById('waitingPlateCount').textContent = summary.waitingPlate;
            document.getElementById('completedTodayCount').textContent = summary.completedToday;
            document.getElementById('totalAdjustmentFACount').textContent = summary.totalAdjustmentFA;
            document.getElementById('totalAdjustmentCurveCount').textContent = summary.totalAdjustmentCurve;
        }

        // Filter data
        function filterData() {
            const statusFilter = document.getElementById('statusFilter').value;
            const mesinFilter = document.getElementById('mesinFilter').value;
            const remarksFilter = document.getElementById('remarksFilter').value;
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            
            let filteredData = adjustmentData;
            
            // Default behavior: exclude adjustment statuses and selesai, only show active CTP statuses  
            if (!statusFilter) {
                filteredData = filteredData.filter(item => 
                    item.status === 'proses_ctp' || item.status === 'proses_plate' || item.status === 'antar_plate'
                );
            } else {
                // Filter by specific status when selected (allows selesai when explicitly chosen)
                filteredData = filteredData.filter(item => item.status === statusFilter);
            }
            
            // Remove menunggu_adjustment and proses_adjustment from all views (safety filter)
            filteredData = filteredData.filter(item => 
                item.status !== 'menunggu_adjustment' && item.status !== 'proses_adjustment'
            );
            
            // Filter by mesin
            if (mesinFilter) {
                filteredData = filteredData.filter(item => item.mesin_cetak === mesinFilter);
            }
            
            // Filter by remarks
            if (remarksFilter) {
                filteredData = filteredData.filter(item => 
                    item.remarks && item.remarks.includes(remarksFilter)
                );
            }
            
            // Filter by search term
            if (searchTerm) {
                filteredData = filteredData.filter(item => 
                    (item.job_id && item.job_id.toLowerCase().includes(searchTerm)) ||
                    (item.wo_number && item.wo_number.toLowerCase().includes(searchTerm)) ||
                    (item.item_name && item.item_name.toLowerCase().includes(searchTerm)) ||
                    (item.pic && item.pic.toLowerCase().includes(searchTerm))
                );
            }
            
            displayData(filteredData);
        }

        // Format date
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            return new Date(dateString).toLocaleDateString('id-ID');
        }

        // Start CTP
        function startCtp(id) {
            const item = adjustmentData.find(item => item.id === id);
            if (!item) return;
            
            currentAdjustmentId = id;
            
            document.getElementById('startCtpInfo').innerHTML = `
                <div class="row g-3">
                    <div class="col-12">
                        <div class="info-label">Item Name</div>
                        <div class="info-value">
                            <i class="fas fa-box me-1 text-success"></i>
                            ${item.item_name}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="info-label">WO Number</div>
                        <div class="info-value">
                            <i class="fas fa-file-alt me-1 text-info"></i>
                            ${item.wo_number}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="info-label">MC Number</div>
                        <div class="info-value">
                            <i class="fas fa-barcode me-1 text-warning"></i>
                            ${item.mc_number}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="info-label">Mesin Cetak</div>
                        <div class="info-value">
                            <i class="fas fa-industry me-1 text-primary"></i>
                            ${item.mesin_cetak}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="info-label">Jumlah Plate</div>
                        <div class="info-value">
                            <i class="fas fa-layer-group me-1 text-secondary"></i>
                            ${item.jumlah_plate} plate
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="info-label">Jenis Kertas</div>
                        <div class="info-value">
                            <i class="fas fa-file-alt me-1 text-info"></i>
                            ${item.paper_type}
                        </div>
                    </div>                     
                    ${item.remarks ? `
                    <div class="col-12">
                        <div class="info-label">Remarks</div>
                        <div class="info-value">
                            <i class="fas fa-comment-alt me-1 text-primary"></i>
                            ${item.remarks}
                        </div>
                    </div>
                    ` : ''}
                    ${item.note ? `
                    <div class="col-12 mt-3">
                        <div class="info-label">Catatan Request</div>
                        <div class="alert alert-light border border-warning" style="background: linear-gradient(135deg, #fff8e1 0%, #fffde7 100%); border-radius: 8px;">
                            <i class="fas fa-sticky-note me-1 text-warning"></i>
                            ${item.note}
                        </div>
                    </div>
                    ` : ''}
                </div>
            `;
            
            // Jangan kosongkan ctpBy, biarkan value dari Jinja2 agar otomatis terisi nama user login
            new bootstrap.Modal(document.getElementById('startCtpModal')).show();
        }

        // Finish CTP
        function finishCtp(id) {
            const item = adjustmentData.find(item => item.id === id);
            if (!item) return;
            
            currentAdjustmentId = id;
            
            document.getElementById('finishCtpInfo').innerHTML = `
                <div class="row g-3">
                    <div class="col-12">
                        <div class="info-label">Item Name</div>
                        <div class="info-value">
                            <i class="fas fa-box me-1 text-success"></i>
                            ${item.item_name}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="info-label">WO Number</div>
                        <div class="info-value">
                            <i class="fas fa-file-alt me-1 text-info"></i>
                            ${item.wo_number}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="info-label">MC Number</div>
                        <div class="info-value">
                            <i class="fas fa-barcode me-1 text-warning"></i>
                            ${item.mc_number}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="info-label">Mesin Cetak</div>
                        <div class="info-value">
                            <i class="fas fa-industry me-1 text-primary"></i>
                            ${item.mesin_cetak}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="info-label">Jumlah Plate</div>
                        <div class="info-value">
                            <i class="fas fa-layer-group me-1 text-secondary"></i>
                            ${item.jumlah_plate} plate
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="info-label">Jenis Kertas</div>
                        <div class="info-value">
                            <i class="fas fa-file-alt me-1 text-info"></i>
                            ${item.paper_type}
                        </div>
                    </div>                     
                    ${item.remarks ? `
                    <div class="col-12">
                        <div class="info-label">Remarks</div>
                        <div class="info-value">
                            <i class="fas fa-comment-alt me-1 text-primary"></i>
                            ${item.remarks}
                        </div>
                    </div>
                    ` : ''}
                    ${item.note ? `
                    <div class="col-12 mt-3">
                        <div class="info-label">Catatan Request</div>
                        <div class="alert alert-light border border-warning" style="background: linear-gradient(135deg, #fff8e1 0%, #fffde7 100%); border-radius: 8px;">
                            <div class="d-flex align-items-start">
                                <i class="fas fa-sticky-note me-2 text-warning mt-1"></i>
                                <div class="info-value text-dark">${item.note}</div>
                            </div>
                        </div>
                    </div>
                    ` : ''}
                    <div class="col-12 mt-3">
                        <div class="info-label">Waktu Dimulai Plate</div>
                        <div class="info-value">
                            <i class="fas fa-clock me-1 text-info"></i>
                            ${formatDateTimeIndonesia(item.plate_start_at || '-')}
                            ${item.ctp_by ? '<span class="text-muted ms-2">[PIC: ' + item.ctp_by + ']</span>' : ''}
                        </div>
                    </div>
                </div>
            `;
            
            new bootstrap.Modal(document.getElementById('finishCtpModal')).show();
        }

        // Deliver Plate
        function deliverPlate(id) {
            const item = adjustmentData.find(item => item.id === id);
            if (!item) return;
            
            currentAdjustmentId = id;
            
            // Populate modal info
            document.getElementById('plateDeliveredInfo').innerHTML = `
                <div class="row g-3">
                    <div class="col-12">
                        <div class="info-label">Item Name</div>
                        <div class="info-value">
                            <i class="fas fa-box me-1 text-success"></i>
                            ${item.item_name}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="info-label">WO Number</div>
                        <div class="info-value">
                            <i class="fas fa-file-alt me-1 text-info"></i>
                            ${item.wo_number}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="info-label">MC Number</div>
                        <div class="info-value">
                            <i class="fas fa-barcode me-1 text-warning"></i>
                            ${item.mc_number}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="info-label">Mesin Cetak</div>
                        <div class="info-value">
                            <i class="fas fa-industry me-1 text-primary"></i>
                            ${item.mesin_cetak}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="info-label">Jumlah Plate</div>
                        <div class="info-value">
                            <i class="fas fa-layer-group me-1 text-secondary"></i>
                            ${item.jumlah_plate} plate
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="info-label">Jenis Kertas</div>
                        <div class="info-value">
                            <i class="fas fa-file-alt me-1 text-info"></i>
                            ${item.paper_type}
                        </div>
                    </div>                     
                    ${item.remarks ? `
                    <div class="col-12">
                        <div class="info-label">Remarks</div>
                        <div class="info-value">
                            <i class="fas fa-comment-alt me-1 text-primary"></i>
                            ${item.remarks}
                        </div>
                    </div>
                    ` : ''}
                    ${item.note ? `
                    <div class="col-12 mt-3">
                        <div class="info-label">Catatan Request</div>
                        <div class="alert alert-light border border-warning" style="background: linear-gradient(135deg, #fff8e1 0%, #fffde7 100%); border-radius: 8px;">
                            <i class="fas fa-sticky-note me-1 text-warning"></i>
                            ${item.note}
                        </div>
                    </div>
                    ` : ''}
                </div>
            `;
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('plateDeliveredModal'));
            modal.show();
        }

        // Handle confirm plate delivered
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('confirmPlateDelivered').addEventListener('click', function() {
                if (!currentAdjustmentId) return;
                
                const confirmBtn = this;
                const originalText = confirmBtn.innerHTML;
                confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Memproses...';
                confirmBtn.disabled = true;
                
                fetch('/impact/plate-delivered', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id: currentAdjustmentId })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Close modal
                        const modal = bootstrap.Modal.getInstance(document.getElementById('plateDeliveredModal'));
                        modal.hide();
                        
                        loadData();
                        showToast('Plate berhasil sampai di mesin', 'success');
                    } else {
                        showToast('Gagal konfirmasi plate sampai', 'error');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showToast('Terjadi kesalahan saat konfirmasi plate sampai', 'error');
                })
                .finally(() => {
                    // Reset button
                    confirmBtn.innerHTML = originalText;
                    confirmBtn.disabled = false;
                });
            });
        });

        // Initialize page
        document.addEventListener('DOMContentLoaded', async function() {
            // Request notification permission when page loads
            await requestNotificationPermission();
            loadData();
            
            // Add event listeners for filters
            document.getElementById('statusFilter').addEventListener('change', filterData);
            document.getElementById('mesinFilter').addEventListener('change', filterData);
            document.getElementById('remarksFilter').addEventListener('change', filterData);
            document.getElementById('searchInput').addEventListener('input', filterData);
            
            // Refresh button
            document.getElementById('refreshData').addEventListener('click', loadData);
            
            // Export button
            document.getElementById('exportData').addEventListener('click', function() {
                console.log('Export button clicked - CTP Adjustment');
                new bootstrap.Modal(document.getElementById('exportModal')).show();
            });
            
            // Confirm export
            document.getElementById('confirmExport').addEventListener('click', function() {
                // Get filter values
                const statusFilter = document.getElementById('exportStatusFilter').value;
                const remarksFilter = document.getElementById('exportRemarksFilter').value;
                const dateFrom = document.getElementById('exportDateFrom').value;
                const dateTo = document.getElementById('exportDateTo').value;
                
                // Build query parameters
                let queryParams = [];
                if (statusFilter) queryParams.push(`status=${encodeURIComponent(statusFilter)}`);
                if (remarksFilter) queryParams.push(`remarks=${encodeURIComponent(remarksFilter)}`);
                if (dateFrom) queryParams.push(`date_from=${encodeURIComponent(dateFrom)}`);
                if (dateTo) queryParams.push(`date_to=${encodeURIComponent(dateTo)}`);
                
                const queryString = queryParams.length > 0 ? '?' + queryParams.join('&') : '';
                
                // Redirect to CSV export endpoint with filters
                window.open(`/impact/export-ctp-adjustment${queryString}`, '_blank');
                bootstrap.Modal.getInstance(document.getElementById('exportModal')).hide();
                
                showToast('Export Data berhasil dimulai, file akan segera didownload', 'success');
            });
            
            // Auto refresh toggle
            document.getElementById('autoRefresh').addEventListener('change', function() {
                autoRefreshEnabled = this.checked;
                if (autoRefreshEnabled) {
                    startAutoRefresh();
                    showToast('Auto refresh diaktifkan', 'success', 2000);
                } else {
                    stopAutoRefresh();
                    showToast('Auto refresh dinonaktifkan', 'info', 2000);
                }
            });
            
            // Start auto refresh by default
            startAutoRefresh();
            
            // Confirm start CTP
            document.getElementById('confirmStartCtp').addEventListener('click', async function() {
                const ctpBy = document.getElementById('ctpBy').value.trim();
                const ctpGroup = document.getElementById('ctpGrup').value.trim();
                
                if (!ctpBy || !ctpGroup) {
                    showToast('Harap isi nama PIC CTP dan Grup CTP', 'error');
                    return;
                }
                
                try {
                    const response = await fetch('/impact/start-ctp', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            id: currentAdjustmentId,
                            ctp_by: ctpBy,
                            ctp_group: ctpGroup
                        })
                    });
                    
                    if (response.ok) {
                        bootstrap.Modal.getInstance(document.getElementById('startCtpModal')).hide();
                        showToast('Proses plate berhasil dimulai', 'success');
                        loadData();
                    } else {
                        showToast('Gagal memulai proses plate', 'error');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    showToast('Terjadi kesalahan saat memulai proses plate', 'error');
                }
            });
            
            // Confirm finish CTP
            document.getElementById('confirmFinishCtp').addEventListener('click', async function() {
                try {
                    const response = await fetch('/impact/finish-ctp', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            id: currentAdjustmentId
                        })
                    });
                    
                    if (response.ok) {
                        bootstrap.Modal.getInstance(document.getElementById('finishCtpModal')).hide();
                        showToast('Proses plate berhasil diselesaikan', 'success');
                        loadData();
                    } else {
                        showToast('Gagal menyelesaikan proses plate', 'error');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    showToast('Terjadi kesalahan saat menyelesaikan proses plate', 'error');
                }
            });
        });
        
        // CTP ENHANCEMENTS - Professional Features
        
        // Auto-refresh functionality
        let autoRefreshInterval;
        let autoRefreshEnabled = true;
        
        function startAutoRefresh() {
            if (autoRefreshInterval) clearInterval(autoRefreshInterval);
            if (autoRefreshEnabled) {
                autoRefreshInterval = setInterval(() => {
                    loadData(); // Silent refresh without notification
                }, 30000); // 30 seconds
            }
        }
        
        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
            }
        }
        
        // Add audio element for notification sound
        const notificationSound = new Audio('/impact/static/sounds/adjustment.mp3');

        // Browser Notification System
        async function requestNotificationPermission() {
            if (!('Notification' in window)) {
                console.log('Browser tidak mendukung notifikasi');
                return false;
            }

            if (Notification.permission === 'granted') {
                return true;
            }

            if (Notification.permission !== 'denied') {
                const permission = await Notification.requestPermission();
                return permission === 'granted';
            }

            return false;
        }

        // Function to show browser notification
        function showBrowserNotification(title, options = {}) {
            if (Notification.permission === 'granted') {
                const defaultOptions = {
                    icon: '/impact/static/img/impact360.png',
                    badge: '/impact/static/img/impact360.png',
                    vibrate: [200, 100, 200],
                    silent: false,
                    requireInteraction: false,
                    sound: '/impact/static/sounds/adjustment.mp3'
                };

                // Create and show notification
                const notification = new Notification(title, { ...defaultOptions, ...options });

                // Play sound if not silent
                if (!options.silent) {
                    notificationSound.play().catch(e => console.log('Error playing sound:', e));
                }

                // Add click event listener
                notification.onclick = function(event) {
                    event.preventDefault();
                    window.focus();
                    notification.close();
                };
            }
        }

        // Toast notification system
        function showToast(message, type = 'info', duration = 5000) {
            const toastContainer = document.getElementById('toastContainer');
            const toastId = 'toast-' + Date.now();
            
            const toastHTML = `
                <div class="toast toast-${type}" id="${toastId}" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="toast-body d-flex align-items-center">
                        <i class="fas ${getToastIcon(type)} me-2"></i>
                        <span class="flex-grow-1">${message}</span>
                        <button type="button" class="btn-close btn-close-white ms-2" data-bs-dismiss="toast"></button>
                    </div>
                </div>
            `;
            
            toastContainer.insertAdjacentHTML('beforeend', toastHTML);
            
            const toastElement = document.getElementById(toastId);
            const toast = new bootstrap.Toast(toastElement, { delay: duration });
            toast.show();
            
            // Auto remove after hiding
            toastElement.addEventListener('hidden.bs.toast', function() {
                toastElement.remove();
            });
        }
        
        function getToastIcon(type) {
            const icons = {
                'success': 'fa-check-circle',
                'error': 'fa-exclamation-circle',
                'info': 'fa-info-circle',
                'warning': 'fa-exclamation-triangle'
            };
            return icons[type] || icons['info'];
        }
        
        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Ctrl+R: Refresh
            if (e.ctrlKey && e.key === 'r') {
                e.preventDefault();
                loadData(); // Silent refresh
            }
            
            // Ctrl+E: Export
            if (e.ctrlKey && e.key === 'e') {
                e.preventDefault();
                exportCtpData(); // Export function already has its own notifications
            }
            
            // Escape: Close modals
            if (e.key === 'Escape') {
                const modals = document.querySelectorAll('.modal.show');
                modals.forEach(modal => {
                    bootstrap.Modal.getInstance(modal)?.hide();
                });
            }
        });
        
        // Initialize auto-refresh on page load
        startAutoRefresh();
    </script>
</body>
</html>
