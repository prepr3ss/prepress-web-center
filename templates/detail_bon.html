<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Impact 360</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <style>
        /* Clean and Professional Styling - Detail Adjustment */
        .page-header {
            background: linear-gradient(135deg, #8b5cf6 0%, #a855f7 100%);
            color: white;
            padding: 2rem 0;
            margin: -1rem -15px 2rem -15px;
            border-radius: 0 0 20px 20px;
        }
        
        .card {
            border: none;
            border-radius: 15px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            background: white;
            margin-top: 0;
        }
        
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        
        .card-header {
            border: none;
            border-radius: 15px 15px 0 0 !important;
            padding: 1.25rem;
            font-size: 1rem;
        }
        
        .card-body {
            padding: 1.5rem;
        }
        
        .row.mb-2 > div {
            padding-bottom: 0.5rem;
        }
        
        /* Button styling */
        .btn-clean {
            border: none;
            border-radius: 25px;
            padding: 0.5rem 1.5rem;
            font-weight: 600;
            font-size: 0.8rem;
            transition: all 0.3s ease;
            letter-spacing: 0.5px;
        }
        
        .btn-outline-secondary {
            border: 2px solid #8b5cf6;
            color: #8b5cf6;
            background: transparent;
            border-radius: 25px;
            padding: 0.5rem 1.5rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        .btn-outline-secondary:hover {
            background: #8b5cf6;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(139, 92, 246, 0.3);
        }
        
        /* Card headers with gradients */
        .card-header.bg-primary {
            background: linear-gradient(135deg, #8b5cf6 0%, #a855f7 100%) !important;
        }
        
        .card-header.bg-success {
            background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%) !important;
        }
        
        .card-header.bg-warning {
            background: linear-gradient(135deg, #ff9500 0%, #ff6b00 100%) !important;
            color: white !important;
        }
        
        /* Info labels and values */
        .text-muted {
            font-size: 0.75rem;
            font-weight: 600;
            color: #6c757d !important;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.25rem;
        }
        
        .fw-bold {
            font-weight: 600 !important;
            color: #2d3436;
        }
        
        .border-bottom {
            border-color: #e9ecef !important;
        }
        
        /* Timeline Styling */
        .timeline {
            position: relative;
            padding-left: 25px;
        }
        
        /* Remove old timeline lines */
        .timeline::before,
        .timeline::after {
            display: none;
        }
        
        /* Individual timeline segments */
        .timeline-segment {
            position: absolute;
            left: 8px;
            width: 3px;
            background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%);
            z-index: 1;
            transition: all 0.5s ease;
            border-radius: 2px;
        }
        
        .timeline-segment.completed {
            background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%);
            box-shadow: 0 0 10px rgba(86, 171, 47, 0.3);
        }
        
        .timeline-item {
            position: relative;
            padding-bottom: 1.2rem;
            min-height: 50px;
        }
        .timeline-item:last-child {
            padding-bottom: 0.5rem;
        }
        
        .timeline-marker {
            position: absolute;
            left: -21px;
            top: 8px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            z-index: 10;
            transition: all 0.3s ease;
        }
        
        /* Interactive Timeline Enhancements */
        .timeline-marker.active {
            animation: pulse 2s infinite;
            transform: scale(1.3);
            box-shadow: 0 0 0 4px rgba(139, 92, 246, 0.3);
        }
        
        .timeline-marker.completed {
            background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%) !important;
            transform: scale(1.2);
            box-shadow: 0 2px 12px rgba(86, 171, 47, 0.4);
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(139, 92, 246, 0.7); }
            70% { box-shadow: 0 0 0 12px rgba(139, 92, 246, 0); }
            100% { box-shadow: 0 0 0 0 rgba(139, 92, 246, 0); }
        }
        
        .timeline-tooltip {
            position: absolute;
            background: linear-gradient(135deg, rgba(0,0,0,0.9) 0%, rgba(0,0,0,0.8) 100%);
            color: white;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            font-size: 0.8rem;
            white-space: nowrap;
            z-index: 1000;
            display: none;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        .update-indicator {
            position: absolute;
            top: 15px;
            right: 20px;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%);
            animation: blink 1.5s infinite;
            box-shadow: 0 0 8px rgba(86, 171, 47, 0.5);
        }
        
        @keyframes blink {
            0%, 50% { opacity: 1; transform: scale(1); }
            51%, 100% { opacity: 0.3; transform: scale(0.8); }
        }
        
        .timeline-content {
            padding-left: 8px;
        }
        
        /* Timeline marker colors with gradients */
        .timeline-marker.bg-danger {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
        }
        
        .timeline-marker.bg-info {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .timeline-marker.bg-primary {
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
        }
        
        .timeline-marker.bg-success {
            background: linear-gradient(135deg, #059669 0%, #10b981 100%);
        }
        
        .timeline-marker.bg-secondary {
            background: linear-gradient(135deg, #64748b 0%, #475569 100%);
        }
        
        /* Page title styling */
        h2 {
            color: #2d3436;
            font-weight: 700;
            margin-bottom: 2rem;
        }
        
        /* Shadow improvements */
        .shadow-sm {
            box-shadow: 0 2px 10px rgba(0,0,0,0.08) !important;
        }
        
        /* Prevent flash of unstyled content */
        body {
            visibility: hidden;
        }
        
        body.loaded {
            visibility: visible;
            opacity: 1;
            transition: opacity 0.3s ease-in-out;
        }

        /* Timeline styling adjustments for positioning the info box */
        .timeline {
            /* Mengubah padding-right agar ada ruang untuk cancelled-info pada layar lebar */
            padding-right: 300px;
        }

        /* Individual timeline segments (The line between markers) */
        /* RED line for cancelled/cancelled segments */
        .timeline-segment.cancelled {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
            box-shadow: 0 0 10px rgba(238, 90, 82, 0.3);
        }

        /* RED marker/dot for cancelled/cancelled step */
        .timeline-marker.cancelled {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%) !important;
            transform: scale(1.2);
            box-shadow: 0 2px 12px rgba(238, 90, 82, 0.4);
        }

        /* Box for cancellation/decline details */
        .cancelled-info {
            position: absolute;
            right: -290px; /* Jarak ke kanan dari timeline */
            top: 120%;
            transform: translateY(-50%);
            padding: 12px;
            border-radius: 8px;
            background: linear-gradient(135deg, rgba(255,107,107,0.1) 0%, rgba(238,90,82,0.1) 100%);
            border-left: 4px solid #ee5a52;
            font-size: 0.9rem;
            width: 350px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            z-index: 100;
        }

        .cancelled-info .cancelled-header {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            color: #dc3545; /* Merah terang */
            font-weight: 600;
        }

        .cancelled-info .cancelled-header i {
            margin-right: 8px;
        }

        .cancelled-info .cancelled-details {
            color: #6c757d;
            margin-left: 24px;
        }

        .cancelled-info .cancelled-details span {
            display: block;
            margin-bottom: 4px;
        }

        .cancelled-info .cancelled-reason {
            margin-top: 8px;
            padding: 8px;
            background: rgba(255,255,255,0.7);
            border-radius: 4px;
            color: #495057;
        }

        /* Class penanda pada item yang memiliki kotak info penolakan */
        .timeline-item.has-cancelled-info {
            position: relative; /* Penting untuk penempatan absolute cancelled-info */
        }

        /* Responsive styling for cancelled info */
        @media (max-width: 1200px) {
            .timeline {
                padding-right: 0;
            }
            
            .cancelled-info {
                position: relative;
                right: auto;
                top: auto;
                transform: none;
                margin: 10px 0 10px 25px;
                width: calc(100% - 25px);
            }
            
            .timeline-item.has-cancelled-info {
                padding-bottom: 0;
            }
        }        
    </style>
</head>
<body>
    {% include '_top_header.html' %}
    <div class="d-flex" id="content-wrapper">
        {% include '_sidebar.html' %}
        <div id="page-content-wrapper">
            <div class="container-fluid pt-3">
                <!-- Page Header -->
                <div class="page-header">
                    <div class="container-fluid">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h2 class="mb-1 text-white">Detail Plate Bon</h2>
                                <p class="mb-0 opacity-75">Informasi lengkap proses bon dan timeline</p>
                            </div>
                            <div class="text-end">
                                <div class="small opacity-75">Sistem Monitoring Prepress</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="d-flex justify-content-end mb-3">
                    <button onclick="goBack()" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-2"></i>Kembali
                    </button>
                </div>
                
                <!-- Detail Card -->
                <div class="row">
                    <!-- Status Card -->
                    <div class="col-12 mb-4">
                        <div class="card">
                            <div class="card-header bg-primary text-white">
                                <h6 class="mb-0"><i class="fas fa-info-circle me-2"></i>Status Bon</h6>
                            </div>
                            <div class="card-body">
                                <div class="row align-items-center">
                                    <div class="col-md-3 mb-3">
                                        <div class="text-front">
                                            <span class="badge status-badge fs-6" data-status="{{ data.status }}">
                                                {{ data.status|replace('_', ' ')|title }}
                                            </span>
                                        </div>
                                    </div>
                                    <div class="col-md-9">
                                        <div class="row g-3">
                                            <div class="col-md-3">
                                                <div class="text-muted">Tanggal</div>
                                                <div class="fw-bold" data-tanggal="{{ data.tanggal }}">{{ data.tanggal }}</div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="text-muted">Mesin Cetak</div>
                                                <div class="fw-bold">{{ data.mesin_cetak }}</div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="text-muted">PIC</div>
                                                <div class="fw-bold">{{ data.pic }}</div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="text-muted">Remarks</div>
                                                <div class="fw-bold">{{ data.remarks }}</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Informasi Item -->
                    <div class="col-md-6 mb-3">
                        <div class="card h-100">
                            <div class="card-header bg-success text-white">
                                <h6 class="mb-0"><i class="fas fa-box me-2"></i>Informasi Item</h6>
                            </div>
                            <div class="card-body">
                                <div class="row g-3">
                                    <div class="col-12">
                                        <div class="text-muted">Nama Item</div>
                                        <div class="fw-bold">{{ data.item_name }}</div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="text-muted">WO Number</div>
                                        <div class="fw-bold">{{ data.wo_number }}</div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="text-muted">MC Number</div>
                                        <div class="fw-bold">{{ data.mc_number }}</div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="text-muted">Jumlah Plate</div>
                                        <div class="fw-bold">
                                            <i class="fas fa-layer-group me-1 text-primary"></i>
                                            {{ data.jumlah_plate }} plate
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="text-muted">Run Length</div>
                                        <div class="fw-bold">
                                            <i class="fas fa-boxes me-1 text-success"></i>
                                            {{ data.run_length }}
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="text-muted">Jenis Kertas</div>
                                        <div class="fw-bold">{{ data.paper_type }}</div>
                                    </div>                                    
                                    {% if data.note %}
                                    <div class="col-6">
                                        <div class="text-muted">Catatan</div>
                                        <div class="alert alert-light border border-warning" style="background: linear-gradient(135deg, #fff8e1 0%, #fffde7 100%); border-radius: 8px; margin-bottom: 0;">
                                            <i class="fas fa-sticky-note me-1 text-warning"></i>
                                            {{ data.note }}
                                        </div>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Detail Waktu -->
                    <div class="col-md-6 mb-3">
                        <div class="card h-100">
                            <div class="card-header bg-warning text-white position-relative">
                                <h6 class="mb-0"><i class="fas fa-clock me-2"></i>Timeline Proses</h6>
                                <div class="update-indicator" id="updateIndicator" style="display: none;"></div>
                            </div>
                            <div class="card-body">
                                <div class="timeline" id="timelineContainer">
                                    <div class="timeline-tooltip" id="timelineTooltip"></div>
                                    
                                    <!-- Timeline segments dengan panjang yang tepat -->
                                    <!-- Garis 1: Mesin Off atau Mesin Tidak Off ke Mulai Plate -->
                                    <div class="timeline-segment" id="segment-0" style="top: 20px; height: 60px;"></div>
                                    <!-- Garis 2: Mulai Plate ke Selesai Plate -->
                                    <div class="timeline-segment" id="segment-1" style="top: 90px; height: 65px;"></div>
                                    <!-- Garis 3: Selesai Plate ke Plate Sampai -->
                                    <div class="timeline-segment" id="segment-2" style="top: 160px; height: 65px;"></div>
                                
                                    <div class="timeline-item" data-step="machine_off">
                                        <div class="timeline-marker bg-danger" data-tooltip="Mesin berhenti beroperasi"></div>
                                        <div class="timeline-content">
                                            <div class="fw-bold mb-1">Request Bon</div>
                                            <div class="text-dark" data-datetime="{{ data.machine_off_at }}" data-pic="{{ data.pic }}">
                                                {{ data.machine_off_at }} 
                                                {% if data.pic %}<span class="text-muted">[{{ data.pic }}]</span>{% endif %}
                                            </div>
                                        </div>
                                    </div>

                                    <div class="timeline-item" data-step="plate_start">
                                        <div class="timeline-marker bg-{% if data.plate_start_at %}primary{% else %}secondary{% endif %}" data-tooltip="Mulai proses pembuatan plate"></div>
                                        <div class="timeline-content">
                                            <div class="fw-bold mb-1">Mulai Plate</div>
                                            <div class="text-dark">
                                                {% if data.plate_start_at %}
                                                    <span data-datetime="{{ data.plate_start_at }}" data-pic="{{ data.ctp_by }}">
                                                        {{ data.plate_start_at }}
                                                        {% if data.ctp_by %}<span class="text-muted">[{{ data.ctp_by }}]</span>{% endif %}
                                                    </span>
                                                {% else %}
                                                    <span class="text-muted">Belum dimulai</span>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                    <div class="timeline-item" data-step="plate_finish">
                                        <div class="timeline-marker bg-{% if data.plate_finish_at %}primary{% else %}secondary{% endif %}" data-tooltip="Selesai proses pembuatan plate"></div>
                                        <div class="timeline-content">
                                            <div class="fw-bold mb-1">Selesai Plate</div>
                                            <div class="text-dark">
                                                {% if data.plate_finish_at %}
                                                    <span data-datetime="{{ data.plate_finish_at }}" data-pic="{{ data.ctp_by }}">
                                                        {{ data.plate_finish_at }}
                                                        {% if data.ctp_by %}<span class="text-muted">[{{ data.ctp_by }}]</span>{% endif %}
                                                    </span>
                                                {% else %}
                                                    <span class="text-muted">Belum selesai</span>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                    <div class="timeline-item" data-step="plate_delivered">
                                        <div class="timeline-marker bg-{% if data.plate_delivered_at %}success{% else %}secondary{% endif %}" data-tooltip="Plate sampai di mesin cetak"></div>
                                        <div class="timeline-content">
                                            <div class="fw-bold mb-1">Plate Sampai</div>
                                            <div class="text-dark">
                                                {% if data.plate_delivered_at %}
                                                    <span data-datetime="{{ data.plate_delivered_at }}" data-pic="{{ data.ctp_by }}">
                                                        {{ data.plate_delivered_at }}
                                                        {% if data.ctp_by %}<span class="text-muted">[{{ data.ctp_by }}]</span>{% endif %}
                                                    </span>
                                                {% else %}
                                                    <span class="text-muted">Belum sampai</span>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/js/all.min.js"></script>
    <script src="{{ url_for('static', filename='js/sidebar_handler.js') }}"></script>
    <script src="{{ url_for('static', filename='js/badge_system.js') }}"></script>
    <script src="{{ url_for('static', filename='js/auto_refresh_handler.js') }}"></script>
    <script>
        // Konversi tanggal ke format Indonesia
        function formatTanggalIndonesia(dateString) {
            if (!dateString || dateString === '-') return dateString;
            
            const bulanIndonesia = [
                'Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni',
                'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'
            ];
            
            // Coba parse berbagai format tanggal
            let date;
            if (dateString.includes('-')) {
                // Format YYYY-MM-DD atau DD-MM-YYYY
                const parts = dateString.split('-');
                if (parts[0].length === 4) {
                    // YYYY-MM-DD
                    date = new Date(parts[0], parts[1] - 1, parts[2]);
                } else {
                    // DD-MM-YYYY
                    date = new Date(parts[2], parts[1] - 1, parts[0]);
                }
            } else if (dateString.includes('/')) {
                // Format DD/MM/YYYY atau MM/DD/YYYY
                const parts = dateString.split('/');
                date = new Date(parts[2], parts[1] - 1, parts[0]);
            } else {
                date = new Date(dateString);
            }
            
            if (isNaN(date.getTime())) return dateString;
            
            const day = date.getDate();
            const month = bulanIndonesia[date.getMonth()];
            const year = date.getFullYear();
            
            return `${day} ${month} ${year}`;
        }
        
        // Konversi datetime ke format Indonesia (untuk timeline)
        function formatDateTimeIndonesia(datetimeString) {
            if (!datetimeString || datetimeString === '-') return datetimeString;
            
            const bulanIndonesia = [
                'Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni',
                'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'
            ];
            
            let date;
            
            // Parse format ISO: YYYY-MM-DDTHH:MM:SS
            if (datetimeString.includes('T')) {
                const [datePart, timePart] = datetimeString.split('T');
                const [year, month, day] = datePart.split('-');
                const [hour, minute] = timePart.split(':');
                
                date = new Date(year, month - 1, day, hour, minute);
                
                if (!isNaN(date.getTime())) {
                    const dayNum = date.getDate();
                    const monthName = bulanIndonesia[date.getMonth()];
                    const yearNum = date.getFullYear();
                    const hourFormatted = hour.padStart(2, '0');
                    const minuteFormatted = minute.padStart(2, '0');
                    
                    return `${dayNum} ${monthName} ${yearNum} - ${hourFormatted}:${minuteFormatted}`;
                }
            }
            // Parse format database: YYYY-MM-DD HH:MM:SS
            else if (datetimeString.includes(' ')) {
                const [datePart, timePart] = datetimeString.split(' ');
                const [year, month, day] = datePart.split('-');
                const [hour, minute] = timePart.split(':');
                
                date = new Date(year, month - 1, day, hour, minute);
                
                if (!isNaN(date.getTime())) {
                    const dayNum = date.getDate();
                    const monthName = bulanIndonesia[date.getMonth()];
                    const yearNum = date.getFullYear();
                    const hourFormatted = hour.padStart(2, '0');
                    const minuteFormatted = minute.padStart(2, '0');
                    
                    return `${dayNum} ${monthName} ${yearNum} - ${hourFormatted}:${minuteFormatted}`;
                }
            }
            
            // Fallback untuk format tanggal saja
            return formatTanggalIndonesia(datetimeString);
        }
        
        // Konversi semua tanggal sebelum halaman tampil (menghindari blink)
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize Badge System
            initializeStatusBadge();
            
            // Konversi tanggal di status card
            const tanggalElements = document.querySelectorAll('[data-tanggal]');
            tanggalElements.forEach(function(el) {
                const tanggal = el.getAttribute('data-tanggal');
                el.textContent = formatTanggalIndonesia(tanggal);
            });
            
            // Konversi tanggal-waktu di timeline
            const timelineElements = document.querySelectorAll('[data-datetime]');
            timelineElements.forEach(function(el) {
                const datetime = el.getAttribute('data-datetime');
                const pic = el.getAttribute('data-pic');
                
                if (datetime && datetime !== '-') {
                    const formattedDateTime = formatDateTimeIndonesia(datetime);
                    el.innerHTML = `${formattedDateTime} ${pic ? '<span class="text-muted">[' + pic + ']</span>' : ''}`;
                }
            });
            
            // Initialize Interactive Timeline
            initializeInteractiveTimeline();
            
            // Show content smoothly after conversion
            document.body.classList.add('loaded');
            document.body.style.visibility = 'visible';
        });
        
        // Initialize Status Badge dengan division-aware logic
        function initializeStatusBadge() {
            const statusBadge = document.querySelector('[data-status]');
            if (statusBadge && window.BadgeSystem) {
                const status = statusBadge.getAttribute('data-status');
                
                // Tentukan division berdasarkan status
                let division = 'default';
                if (status === 'menunggu_adjustment' || status === 'proses_adjustment') {
                    division = 'mounting';
                } else if (status === 'proses_ctp' || status === 'proses_plate' || status === 'antar_plate' || status === 'selesai') {
                    division = 'ctp';
                }
                
                // Get status info berdasarkan division
                const statusInfo = window.BadgeSystem.getStatusInfo(status, division);
                if (statusInfo) {
                    // Clear existing classes
                    statusBadge.className = 'badge status-badge fs-6';
                    
                    // Add division-aware badge class
                    statusBadge.classList.add(statusInfo.class);
                    statusBadge.textContent = statusInfo.label;
                    
                    // Set data-status untuk compatibility
                    statusBadge.setAttribute('data-status', status);
                }
            }
        }
        
        // Interactive Timeline Functions
        let timelineData = {
            machine_off_at: '{{ data.machine_off_at }}',
            plate_start_at: '{{ data.plate_start_at }}',
            plate_finish_at: '{{ data.plate_finish_at }}',
            plate_delivered_at: '{{ data.plate_delivered_at }}'
        };
        
        function initializeInteractiveTimeline() {
            // Setup tooltips
            setupTooltips();
            
            // Determine current active step
            updateActiveStep();
            
            // Setup progress bar
            updateProgressBar();
            
            // Setup auto-refresh
            setupAutoRefresh();
        }

        // Inject current user name for JS logic
        window.currentUserName = "{{ current_user.name | default('Unknown User') }}"; 
        
        function setupTooltips() {
            const markers = document.querySelectorAll('.timeline-marker[data-tooltip]');
            const tooltip = document.getElementById('timelineTooltip');
            
            markers.forEach(marker => {
                marker.addEventListener('mouseenter', function(e) {
                    const tooltipText = this.getAttribute('data-tooltip');
                    tooltip.textContent = tooltipText;
                    tooltip.style.display = 'block';
                    tooltip.style.left = (e.pageX + 10) + 'px';
                    tooltip.style.top = (e.pageY - 30) + 'px';
                });
                
                marker.addEventListener('mouseleave', function() {
                    tooltip.style.display = 'none';
                });
            });
        }
        
        function updateActiveStep() {
            const bonStatus = '{{ data.status }}';
            // If bon is cancelled or declined, don't show any active steps
            if (bonStatus === 'bondibatalkan' || bonStatus === 'ditolakctp') {
                return;
            }

            const steps = ['machine_off',  'plate_start', 'plate_finish', 'plate_delivered'];
            let activeStep = null;
            let lastCompletedStepIndex = -1;
            
            // Find the last completed step and determine active step
            for (let i = 0; i < steps.length; i++) {
                const stepData = timelineData[steps[i] + '_at'];
                if (stepData && stepData !== '' && stepData !== '-' && stepData !== 'None') {
                    lastCompletedStepIndex = i;
                } else {
                    // This is the first incomplete step, so it's active
                    activeStep = steps[i];
                    break;
                }
            }
            
            // Update UI for active step
            if (activeStep) {
                const activeItem = document.querySelector(`[data-step="${activeStep}"]`);
                const activeMarker = activeItem?.querySelector('.timeline-marker');
                
                if (activeItem && activeMarker) {
                    activeItem.classList.add('active');
                    activeMarker.classList.add('active');
                }
            }
            
            // Mark completed steps
            steps.forEach((step, index) => {
                const stepData = timelineData[step + '_at'];
                if (stepData && stepData !== '' && stepData !== '-' && stepData !== 'None') {
                    const item = document.querySelector(`[data-step="${step}"]`);
                    const marker = item?.querySelector('.timeline-marker');
                    if (marker) marker.classList.add('completed');
                }
            });
        }
        
        function updateProgressBar() {
            const bonStatus = '{{ data.status }}'; 
            const isCancelled = bonStatus === 'bondibatalkan';
            const isDeclined = bonStatus === 'ditolakctp';
            
            // Urutan steps bon default
            const steps = ['machine_off', 'plate_start', 'plate_finish', 'plate_delivered'];
            
            if (isCancelled || isDeclined) {
                // Mark all segments and markers as cancelled
                const segments = document.querySelectorAll('.timeline-segment');
                segments.forEach(segment => {
                    segment.classList.add('cancelled');
                    segment.classList.remove('completed');
                });

                const markers = document.querySelectorAll('.timeline-marker');
                markers.forEach(marker => {
                    marker.classList.add('cancelled');
                    marker.classList.remove('completed');
                });
                
                const firstItem = document.querySelector('[data-step="machine_off"]');
                if (firstItem) {
                    // Remove any existing info
                    const existingInfo = firstItem.querySelector('.cancelled-info');
                    if (existingInfo) {
                        existingInfo.remove();
                    }
                    
                    // Add new info box
                    const infoBox = document.createElement('div');
                    infoBox.className = 'cancelled-info';
                    
                    if (isCancelled) {
                        const cancelledAt = '{{ data.cancelled_at }}'; 
                        const formattedDateTime = formatDateTimeIndonesia(cancelledAt);
                        
                        infoBox.innerHTML = `
                            <div class="cancelled-header">
                                <span><i class="fas fa-ban me-2"></i>Bon Dibatalkan</span>
                            </div>
                            <div class="cancelled-details">
                                <span><i class="fas fa-user me-2"></i>Dibatalkan oleh: {{ data.cancelled_by }}</span>
                                <span><i class="fas fa-clock me-2"></i>Waktu: ${formattedDateTime}</span>
                                <div class="cancelled-reason">
                                    <i class="fas fa-info-circle me-2"></i>Alasan:
                                    <p class="mb-0 mt-1">{{ data.cancellation_reason }}</p>
                                </div>
                            </div>
                        `;
                    } else {
                        // For declined status
                        const declinedAt = '{{ data.declined_at }}'; 
                        const formattedDateTime = formatDateTimeIndonesia(declinedAt);
                        
                        infoBox.innerHTML = `
                            <div class="cancelled-header">
                                <span><i class="fas fa-ban me-2"></i>Bon Ditolak</span>
                            </div>
                            <div class="cancelled-details">
                                <span><i class="fas fa-user me-2"></i>Ditolak oleh: {{ data.declined_by }}</span>
                                <span><i class="fas fa-clock me-2"></i>Waktu: ${formattedDateTime}</span>
                                <div class="cancelled-reason">
                                    <i class="fas fa-info-circle me-2"></i>Alasan:
                                    <p class="mb-0 mt-1">{{ data.decline_reason }}</p>
                                </div>
                            </div>
                        `;
                    }
                    
                    firstItem.classList.add('has-cancelled-info');
                    firstItem.appendChild(infoBox);
                }
                
                return; 
            }
            
            // --- LOGIKA DEFAULT (JIKA TIDAK DIBATALKAN) ---
            
            // Update each segment based on completion status
            for (let i = 0; i < steps.length - 1; i++) { // Loop steps.length-1 segments (4 segments for 5 steps)
                const currentStep = steps[i]; // Step yang memulai segmen ini
                const segment = document.getElementById(`segment-${i}`);
                
                if (segment) {
                    // Check if current step (yang memulai segmen) is completed
                    const currentStepData = timelineData[currentStep + '_at'];
                    const isCurrentCompleted = currentStepData && currentStepData !== '' && currentStepData !== '-' && currentStepData !== 'None';
                    
                    if (isCurrentCompleted) {
                        segment.classList.add('completed');
                    } else {
                        segment.classList.remove('completed');
                    }
                    
                    // Hapus class 'cancelled' jika sebelumnya ada (penting saat data di-reload)
                    segment.classList.remove('cancelled'); 
                }
            }
        }
        
        // Global auto-refresh handler instance using singleton pattern
        let autoRefreshHandler = null;

        function setupAutoRefresh() {
            // Extract bon ID from URL path
            const pathParts = window.location.pathname.split('/');
            const bonId = pathParts[pathParts.length - 1];
            
            // Validate that bonId is a number
            if (!bonId || isNaN(parseInt(bonId))) {
                console.error('Valid bon ID not found in URL, auto-refresh disabled');
                return;
            }
            
            // Use singleton pattern to prevent multiple instances
            autoRefreshHandler = AutoRefreshHandler.getInstance({
                refreshInterval: 15000,        // 15 seconds
                inactivityDelay: 3000,         // 3 seconds of inactivity before pause
                errorRetryInterval: 60000,     // 1 minute on error
                maxRetries: 3,                 // Maximum retry attempts
                loadingIndicatorSelector: '#updateIndicator',
                enableLogging: true,           // Enable console logging for debugging
                apiEndpoint: `/impact/api/check-detail-bon/${bonId}`,  // Use new API endpoint
                dataType: 'bon'                // Specify data type
            });
        }

        // Function to update timeline data (called by auto-refresh handler)
        window.updateTimelineData = function() {
            // Update timeline data object with fresh values from the page
            // This function is now safe to call multiple times
            if (typeof timelineData !== 'undefined') {
                timelineData.machine_off_at = document.querySelector('[data-step="machine_off"] [data-datetime]')?.getAttribute('data-datetime') || '';
                timelineData.plate_start_at = document.querySelector('[data-step="plate_start"] [data-datetime]')?.getAttribute('data-datetime') || '';
                timelineData.plate_finish_at = document.querySelector('[data-step="plate_finish"] [data-datetime]')?.getAttribute('data-datetime') || '';
                timelineData.plate_delivered_at = document.querySelector('[data-step="plate_delivered"] [data-datetime]')?.getAttribute('data-datetime') || '';
            }
        };

        // Function to update timeline visual state without re-initializing
        window.updateTimelineVisualState = function(data) {
            console.log('Updating timeline visual state with data:', data);
            
            // Update timeline data object first
            if (typeof timelineData !== 'undefined') {
                timelineData.machine_off_at = data.machine_off_at || '';
                timelineData.plate_start_at = data.plate_start_at || '';
                timelineData.plate_finish_at = data.plate_finish_at || '';
                timelineData.plate_delivered_at = data.plate_delivered_at || '';
            }
            
            // Update timeline markers and segments based on new data
            const steps = ['machine_off', 'plate_start', 'plate_finish', 'plate_delivered'];
            
            steps.forEach((step, index) => {
                const stepData = data[step + '_at'];
                const item = document.querySelector(`[data-step="${step}"]`);
                const marker = item?.querySelector('.timeline-marker');
                const segment = document.getElementById(`segment-${index}`);
                
                if (item && marker) {
                    // Remove existing states
                    marker.classList.remove('active', 'completed', 'pulse');
                    item.classList.remove('active');
                    
                    // Find the text content element
                    const textElement = item.querySelector('.text-dark');
                    
                    if (stepData && stepData !== '' && stepData !== '-' && stepData !== 'None') {
                        // Mark as completed
                        marker.classList.add('completed');
                        
                        // Update segment
                        if (segment) {
                            segment.classList.add('completed');
                            segment.classList.remove('cancelled');
                        }
                        
                        // Update timeline text content with actual data
                        if (textElement) {
                            const picField = {
                                'machine_off': 'pic',
                                'plate_start': 'ctp_by',
                                'plate_finish': 'ctp_by',
                                'plate_delivered': 'ctp_by'
                            };
                            
                            const pic = data[picField[step]] || '';
                            if (pic) {
                                textElement.innerHTML = `${stepData} <span class="text-muted">[${pic}]</span>`;
                            } else {
                                textElement.textContent = stepData;
                            }
                        }
                    } else {
                        // Check if this is the first incomplete step (active)
                        const isPreviousStepCompleted = index === 0 ||
                            (data[steps[index-1] + '_at'] && data[steps[index-1] + '_at'] !== '' && data[steps[index-1] + '_at'] !== '-' && data[steps[index-1] + '_at'] !== 'None');
                        
                        if (isPreviousStepCompleted) {
                            marker.classList.add('active', 'pulse');
                            item.classList.add('active');
                        }
                        
                        // Update segment
                        if (segment) {
                            segment.classList.remove('completed', 'cancelled');
                        }
                        
                        // Set default text for incomplete steps
                        if (textElement) {
                            const defaultTexts = {
                                'plate_start': 'Belum dimulai',
                                'plate_finish': 'Belum selesai',
                                'plate_delivered': 'Belum sampai'
                            };
                            
                            if (step === 'machine_off') {
                                // For machine_off, show the actual data if available
                                if (data.machine_off_at) {
                                    const pic = data.pic || '';
                                    if (pic) {
                                        textElement.innerHTML = `${data.machine_off_at} <span class="text-muted">[${pic}]</span>`;
                                    } else {
                                        textElement.textContent = data.machine_off_at;
                                    }
                                }
                            } else {
                                // For other steps, keep the default text
                                textElement.innerHTML = `<span class="text-muted">${defaultTexts[step]}</span>`;
                            }
                        }
                    }
                }
            });
            
            // Handle special statuses (cancelled/declined)
            if (data.status === 'bondibatalkan' || data.status === 'ditolakctp') {
                // Mark all segments and markers as cancelled/declined
                document.querySelectorAll('.timeline-segment').forEach(seg => {
                    seg.classList.add('cancelled');
                    seg.classList.remove('completed');
                });
                
                document.querySelectorAll('.timeline-marker').forEach(mark => {
                    mark.classList.add('cancelled');
                    mark.classList.remove('completed', 'active', 'pulse');
                });
            }
            
            console.log('Timeline visual state updated');
        };

        // Cleanup function to destroy auto-refresh handler when page unloads
        window.addEventListener('beforeunload', function() {
            AutoRefreshHandler.destroyInstance();
        });

        // No need for visibility change handling anymore
        // Auto-refresh continues regardless of page visibility
        
        function capitalizeFirst(str) {
            return str.charAt(0).toUpperCase() + str.slice(1);
        }
        
        // Function untuk kembali ke halaman sebelumnya
        function goBack() {
            // Cek apakah ada history sebelumnya
            if (window.history.length > 1) {
                window.history.back();
            } else {
                // Fallback ke data-adjustment jika tidak ada history
                window.location.href = '/impact/data-bon';
            }
        }
    </script>    
</body>
</html>
