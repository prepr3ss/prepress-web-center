<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prepress Impact</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        /* Clean and Professional Styling */
        .page-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem 0;
            margin: -1rem -15px 2rem -15px;
            border-radius: 0 0 20px 20px;
        }
        
        .summary-card {
            border: none;
            border-radius: 15px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            background: white;
        }
        
        .summary-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        
        .summary-card .card-body {
            padding: 1.5rem;
        }
        
        .summary-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1rem auto;
            font-size: 1.5rem;
        }
        
        .icon-warning { background: linear-gradient(135deg, #ff9a56 0%, #ff6b35 100%); }
        .icon-success { background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%); }
        .icon-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .icon-info { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
        .icon-secondary { background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); }
        .icon-dark { background: linear-gradient(135deg, #8360c3 0%, #2ebf91 100%); }
        
        .data-card {
            border: none;
            border-radius: 15px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            background: white;
            overflow: hidden;
        }
        
        .data-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        
        .card-header-clean {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: none;
            padding: 1.25rem;
            border-radius: 15px 15px 0 0;
        }
        
        .status-badge-clean {
            padding: 0.4rem 1rem;
            border-radius: 50px;
            font-size: 0.75rem;
            font-weight: 600;
            letter-spacing: 0.4px;
        }
        
        .badge-waiting { 
            background: linear-gradient(135deg, #ff9a56 0%, #ff6b35 50%, #ff416c 100%);
            color: white;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
            box-shadow: 0 2px 8px rgba(255, 107, 53, 0.3);
        }
        .badge-process { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #8b5cf6 100%);
            color: white;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }
        .badge-ctp {
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 50%, #0ea5e9 100%);
            color: white;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
            box-shadow: 0 2px 8px rgba(37, 99, 235, 0.3);
        }
        .badge-selesai {
            background: linear-gradient(135deg, #059669 0%, #10b981 50%, #34d399 100%);
            color: white;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
            box-shadow: 0 2px 8px rgba(5, 150, 105, 0.3);
        }
        
        .badge-danger {
            background: linear-gradient(135deg, #dc3545 0%, #ff4b2b 100%);
            color: white;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
            box-shadow: 0 2px 8px rgba(220, 53, 69, 0.3);
        }
        
        /* Styling untuk kartu yang ditolak */
        .data-card.declined {
            border: 2px solid rgba(220, 53, 69, 0.1);
        }
        
        .data-card.declined .card-header-clean {
            background: linear-gradient(135deg, #fff5f5 0%, #ffe5e5 100%);
        }
        
        .alert-danger {
            background: linear-gradient(135deg, #fff5f5 0%, #ffe5e5 100%);
            border: none;
            border-left: 4px solid #dc3545;
        }
        
        /* Remarks badges */
        .remarks-badge-clean {
            padding: 0.3rem 0.8rem;
            border-radius: 50px;
            font-size: 0.65rem;
            font-weight: 600;
            letter-spacing: 0.3px;
            margin-top: 0.5rem;
            display: inline-block;
        }
        
        .badge-fa-proof {
            background: linear-gradient(135deg, #8b5cf6 0%, #a855f7 50%, #c084fc 100%);
            color: white;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
            box-shadow: 0 2px 6px rgba(139, 92, 246, 0.3);
        }
        
        .badge-fa-produksi {
            background: linear-gradient(135deg, #f59e0b 0%, #f97316 50%, #fb923c 100%);
            color: white;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
            box-shadow: 0 2px 6px rgba(245, 158, 11, 0.3);
        }
        
        .badge-curve-proof {
            background: linear-gradient(135deg, #06b6d4 0%, #0891b2 50%, #0e7490 100%);
            color: white;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
            box-shadow: 0 2px 6px rgba(6, 182, 212, 0.3);
        }
        
        .badge-curve-produksi {
            background: linear-gradient(135deg, #84cc16 0%, #65a30d 50%, #4d7c0f 100%);
            color: white;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
            box-shadow: 0 2px 6px rgba(132, 204, 22, 0.3);
        }
        
        .badge-remarks-default {
            background: linear-gradient(135deg, #64748b 0%, #475569 50%, #334155 100%);
            color: white;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
            box-shadow: 0 2px 6px rgba(100, 116, 139, 0.3);
        }
        
        .info-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #667eea;
        }
        
        /* Info section untuk modal finish dengan border hijau */
        #finishAdjustmentModal .info-section {
            border-left: 4px solid #56ab2f;
        }
        
        .info-label {
            font-size: 0.75rem;
            font-weight: 600;
            color: #6c757d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.25rem;
        }
        
        .info-value {
            font-weight: 600;
            color: #2d3436;
        }
        
        .btn-clean {
            border: none;
            border-radius: 25px;
            padding: 0.5rem 1.5rem;
            font-weight: 600;
            font-size: 0.8rem;
            transition: all 0.3s ease;
            letter-spacing: 0.5px;
        }
        
        .btn-primary-clean {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .btn-primary-clean:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
            color: white;
        }
        
        .btn-success-clean {
            background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%);
            color: white;
        }
        .btn-success-clean:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(86, 171, 47, 0.4);
            color: white;
        }
        
        .btn-outline-clean {
            border: 2px solid #667eea;
            color: #667eea;
            background: transparent;
        }
        .btn-outline-clean:hover {
            background: #667eea;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }
        
        .filter-section {
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            margin-bottom: 2rem;
        }
        
        .form-control-clean {
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 0.75rem 1rem;
            transition: all 0.3s ease;
        }
        .form-control-clean:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }
        
        .no-data-clean {
            background: white;
            border-radius: 15px;
            padding: 3rem;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }
        
        .loading-clean {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }
        
        /* Toast notifications */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
        }
        
        .toast {
            min-width: 300px;
            border: none;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .toast-success {
            background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%);
            color: white;
        }
        
        .toast-error {
            background: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%);
            color: white;
        }
        
        .toast-info {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
    </style>
</head>
<body>
    <div class="d-flex" id="wrapper">
        {% include '_sidebar.html' %}
        <div id="page-content-wrapper">
            <div class="container-fluid">
                <!-- Page Header -->
                <div class="page-header">
                    <div class="container-fluid">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h2 class="mb-1 text-white">Design EPSON - Adjustment Press</h2>
                                <p class="mb-0 opacity-75">Kelola seluruh proses request adjustment EPSON dari Press</p>
                            </div>
                            <div class="text-end">
                                <div class="small opacity-75">Sistem Monitoring Prepress</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Filter Section -->
                <div class="filter-section">
                    <div class="row align-items-end">
                        <div class="col-md-2">
                            <label class="form-label info-label">Filter Status</label>
                            <select class="form-control form-control-clean" id="statusFilter">
                                <option value="">Semua Status</option>
                                <option value="menunggu_adjustment_design">Menunggu Design</option>
                                <option value="proses_adjustment_design">Proses Design</option>
                                <option value="ditolakmounting">Ditolak Mounting</option>
                                <option value="selesai">Selesai Design</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label info-label">Filter Mesin</label>
                            <select class="form-control form-control-clean" id="mesinFilter">
                                <option value="">Semua Mesin</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label info-label">Filter Remarks</label>
                            <select class="form-control form-control-clean" id="remarksFilter">
                                <option value="">Semua Remarks</option>
                                <option value="ADJUSTMENT FA PROOF">FA Proof</option>
                                <option value="ADJUSTMENT FA PRODUKSI">FA Produksi</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label info-label">Pencarian</label>
                            <input type="text" class="form-control form-control-clean" id="searchInput" 
                                   placeholder="Cari WO, Item, Mesin...">
                        </div>
                        <div class="col-md-4 text-end">
                            <div class="d-flex gap-2 justify-content-end align-items-end">
                                <!-- Auto-refresh toggle -->
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="autoRefresh" checked>
                                    <label class="form-check-label small text-muted" for="autoRefresh">
                                        <i class="fas fa-sync-alt me-1"></i>Auto (30s)
                                    </label>
                                </div>
                                <!-- Export button -->
                                <button class="btn btn-success-clean btn-clean" id="exportData">
                                    <i class="fas fa-download me-2"></i>Export Data
                                </button>
                                <!-- Refresh button -->
                                <button class="btn btn-outline-clean btn-clean" id="refreshData">
                                    <i class="fas fa-refresh me-2"></i>Refresh
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Summary Cards -->
                <div class="row g-4 mb-4">
                    <div class="col-lg-3 col-md-6 col-sm-6">
                        <div class="card summary-card">
                            <div class="card-body text-center">
                                <div class="summary-icon icon-warning">
                                    <i class="fas fa-clock text-white"></i>
                                </div>
                                <h3 class="mb-1" id="waitingCount">-</h3>
                                <div class="info-label">Menunggu Adjustment</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6 col-sm-6">
                        <div class="card summary-card">
                            <div class="card-body text-center">
                                <div class="summary-icon icon-success">
                                    <i class="fas fa-check-circle text-white"></i>
                                </div>
                                <h3 class="mb-1" id="completedTodayCount">-</h3>
                                <div class="info-label">Selesai Hari Ini</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6 col-sm-6">
                        <div class="card summary-card">
                            <div class="card-body text-center">
                                <div class="summary-icon icon-primary">
                                    <i class="fas fa-bezier-curve text-white"></i>
                                </div>
                                <h3 class="mb-1" id="totalFaCount">-</h3>
                                <div class="info-label">Total Adjustment FA</div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Data Cards -->
                <div class="row" id="adjustmentCards">
                    <!-- Cards will be loaded here -->
                </div>

                <!-- Loading indicator -->
                <div class="loading-clean" id="loadingIndicator">
                    <div class="spinner-border text-primary mb-3" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <h5 class="text-muted">Memuat data adjustment...</h5>
                    <p class="text-muted mb-0">Mohon tunggu sebentar</p>
                </div>

                <!-- No data message -->
                <div class="no-data-clean d-none" id="noDataMessage">
                    <i class="fas fa-inbox text-muted mb-3" style="font-size: 4rem; opacity: 0.5;"></i>
                    <h4 class="text-muted mb-2">Tidak ada data adjustment</h4>
                    <p class="text-muted mb-0">Belum ada request adjustment yang perlu ditangani saat ini</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Modal Start Adjustment -->
    <div class="modal fade" id="startAdjustmentModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content" style="border: none; border-radius: 15px; overflow: hidden;">
                <div class="modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none;">
                    <h5 class="modal-title"><i class="fas fa-play me-2"></i>Mulai Proses Adjustment</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <div class="alert" style="background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%); border: none; border-radius: 10px;">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-info-circle me-2 text-primary"></i>
                            <div>
                                <strong>Konfirmasi Mulai Adjustment</strong>
                                <div class="small text-muted">Pastikan semua persiapan sudah siap sebelum memulai proses adjustment</div>
                            </div>
                        </div>
                    </div>
                    <div id="startAdjustmentInfo" class="info-section mb-3"></div>
                    <div class="mb-3">
                        <label for="adjustmentBy" class="form-label info-label">PIC Adjustment</label>
                        <input type="text" name="design_by" id="adjustmentBy" class="form-control form-control-clean text-muted" value="{{ current_user.name }}" readonly tabindex="-1" style="background-color: #f8f9fa; opacity: 1; cursor: not-allowed; margin-bottom: 1rem;">
                        <div class="form-text">
                            <i class="fas fa-user me-1 text-muted"></i>
                            Nama ini akan tercatat sebagai PIC yang bertanggung jawab
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-0 p-4">
                    <button type="button" class="btn btn-outline-clean btn-clean" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>Batal
                    </button>
                    <button type="button" class="btn btn-primary-clean btn-clean" id="confirmStartAdjustment">
                        <i class="fas fa-play me-1"></i>Mulai Adjustment
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Finish Adjustment -->
    <div class="modal fade" id="finishAdjustmentModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content" style="border: none; border-radius: 15px; overflow: hidden;">
                <div class="modal-header" style="background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%); color: white; border: none;">
                    <h5 class="modal-title"><i class="fas fa-check me-2"></i>Selesai Proses Adjustment</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <div class="alert" style="background: linear-gradient(135deg, #e8f5e8 0%, #f0f8f0 100%); border: none; border-radius: 10px;">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-check-circle me-2 text-success"></i>
                            <div>
                                <strong>Konfirmasi Selesai Adjustment</strong>
                                <div class="small text-muted">Pastikan semua proses adjustment sudah selesai dengan baik</div>
                            </div>
                        </div>
                    </div>
                    <div id="finishAdjustmentInfo" class="info-section"></div>
                </div>
                <div class="modal-footer border-0 p-4">
                    <button type="button" class="btn btn-outline-clean btn-clean" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>Batal
                    </button>
                    <button type="button" class="btn btn-success-clean btn-clean" id="confirmFinishAdjustment">
                        <i class="fas fa-check me-1"></i>Selesai Adjustment
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Export Data -->
    <div class="modal fade" id="exportModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content" style="border: none; border-radius: 15px; overflow: hidden;">
                <div class="modal-header" style="background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%); color: white; border: none;">
                    <h5 class="modal-title"><i class="fas fa-download me-2"></i>Export Data CSV</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <div class="alert" style="background: linear-gradient(135deg, #e8f5e8 0%, #f0f8f0 100%); border: none; border-radius: 10px;">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-info-circle me-2 text-success"></i>
                            <div>
                                <strong>Export Data CSV</strong>
                                <div class="small text-muted">File CSV yang dapat dibuka langsung di Excel dengan kolom terpisah</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label info-label">Filter Status</label>
                            <select class="form-control form-control-clean" id="exportStatusFilter">
                                <option value="">Semua Status</option>
                                <option value="menunggu_adjustment_design">Menunggu Adjustment</option>
                                <option value="proses_adjustment_design">Proses Adjustment</option>
                                <option value="selesai">Selesai</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label info-label">Filter Remarks</label>
                            <select class="form-control form-control-clean" id="exportRemarksFilter">
                                <option value="">Semua Remarks</option>
                                <option value="ADJUSTMENT FA PROOF">FA Proof</option>
                                <option value="ADJUSTMENT FA PRODUKSI">FA Produksi</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label info-label">Tanggal Dari</label>
                            <input type="date" class="form-control form-control-clean" id="exportDateFrom">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label info-label">Tanggal Sampai</label>
                            <input type="date" class="form-control form-control-clean" id="exportDateTo">
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <div class="small text-muted">
                            <i class="fas fa-lightbulb me-1"></i>
                            <strong>Info Export:</strong>
                            <ul class="mb-0 mt-1">
                                <li>File CSV dengan semicolon delimiter untuk Excel Indonesia</li>
                                <li>19 kolom sesuai database (A, B, C, D, dll)</li>
                                <li>Compatible dengan Excel Indonesia (semicolon separator)</li>
                                <li>Format tanggal: YYYY-MM-DD HH:MM:SS</li>
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-0 p-4">
                    <button type="button" class="btn btn-outline-clean btn-clean" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>Batal
                    </button>
                    <button type="button" class="btn btn-success-clean btn-clean" id="confirmExport">
                        <i class="fas fa-download me-1"></i>Download CSV
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/js/all.min.js"></script>
    <script src="{{ url_for('static', filename='js/sidebar_handler.js') }}"></script>
    <script src="{{ url_for('static', filename='js/badge_system.js') }}"></script>
    <script>
        let adjustmentData = [];
        let currentAdjustmentId = null;
        
        // Format tanggal Indonesia
        function formatTanggalIndonesia(dateString) {
            if (!dateString || dateString === '-') return dateString;
            
            const bulanIndonesia = [
                'Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni',
                'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'
            ];
            
            let date;
            if (dateString.includes('-')) {
                const parts = dateString.split('-');
                if (parts[0].length === 4) {
                    date = new Date(parts[0], parts[1] - 1, parts[2]);
                } else {
                    date = new Date(parts[2], parts[1] - 1, parts[0]);
                }
            } else {
                date = new Date(dateString);
            }
            
            if (isNaN(date.getTime())) return dateString;
            
            const day = date.getDate();
            const month = bulanIndonesia[date.getMonth()];
            const year = date.getFullYear();
            
            return `${day} ${month} ${year}`;
        }

        // Format datetime Indonesia
        function formatDateTimeIndonesia(datetimeString) {
            if (!datetimeString || datetimeString === '-') return '-';
            
            const bulanIndonesia = [
                'Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni',
                'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'
            ];
            
            let date;
            
            if (datetimeString.includes('T')) {
                const [datePart, timePart] = datetimeString.split('T');
                const [year, month, day] = datePart.split('-');
                const [hour, minute] = timePart.split(':');
                
                date = new Date(year, month - 1, day, hour, minute);
                
                if (!isNaN(date.getTime())) {
                    const dayNum = date.getDate();
                    const monthName = bulanIndonesia[date.getMonth()];
                    const yearNum = date.getFullYear();
                    const hourFormatted = hour.padStart(2, '0');
                    const minuteFormatted = minute.padStart(2, '0');
                    
                    return `${dayNum} ${monthName} ${yearNum} - ${hourFormatted}:${minuteFormatted}`;
                }
            }
            else if (datetimeString.includes(' ')) {
                const [datePart, timePart] = datetimeString.split(' ');
                const [year, month, day] = datePart.split('-');
                const [hour, minute] = timePart.split(':');
                
                date = new Date(year, month - 1, day, hour, minute);
                
                if (!isNaN(date.getTime())) {
                    const dayNum = date.getDate();
                    const monthName = bulanIndonesia[date.getMonth()];
                    const yearNum = date.getFullYear();
                    const hourFormatted = hour.padStart(2, '0');
                    const minuteFormatted = minute.padStart(2, '0');
                    
                    return `${dayNum} ${monthName} ${yearNum} - ${hourFormatted}:${minuteFormatted}`;
                }
            }
            
            return datetimeString;
        }

        // Load data
        async function loadData() {
            try {
                document.getElementById('loadingIndicator').style.display = 'block';
                document.getElementById('noDataMessage').classList.add('d-none');
                
                // URL fetch untuk data Design
                const response = await fetch('/get-design-adjustment-data'); 
                if (!response.ok) throw new Error('Failed to fetch data');
                
                const result = await response.json();
                const allData = result.all_data || [];
                
                // --- LANGKAH PENTING: FILTER DATA HANYA UNTUK DESIGN (EPSON) ---
                // Kita hanya ingin memproses item EPSON di laman Design (is_epson === true atau is_epson === 1)
                // Item non-EPSON (is_epson === false/0) akan diabaikan.
                const designRelevantData = allData.filter(item => item.is_epson);
                
                // Set adjustmentData untuk pengolahan selanjutnya
                adjustmentData = designRelevantData; 
                
                // Check untuk adjustment baru yang menunggu (Hanya EPSON)
                const waitingAdjustments = adjustmentData.filter(item => item.status === 'menunggu_adjustment_design');
                if (waitingAdjustments.length > 0) {
                    showBrowserNotification('Adjustment Menunggu', {
                        body: `Terdapat ${waitingAdjustments.length} adjustment yang menunggu untuk diproses`,
                        requireInteraction: false
                    });
                }

                // Check untuk adjustment baru yang ditolak (Hanya EPSON)
                const declinedmountingAdjustments = adjustmentData.filter(item => item.status === 'ditolakmounting');
                if (declinedmountingAdjustments.length > 0) {
                    showBrowserNotification('Adjustment Ditolak Mounting', {
                        body: `Terdapat ${declinedmountingAdjustments.length} adjustment yang ditolak mounting`,
                        requireInteraction: false
                    });
                }        
                
                // Sort data dengan prioritas baru:
                adjustmentData.sort((a, b) => {
                    // Priority 1: ditolakmounting (Paling atas untuk item yang perlu direvisi Design)
                    if (a.status === 'ditolakmounting' && b.status !== 'ditolakmounting') return -1;
                    if (b.status === 'ditolakmounting' && a.status !== 'ditolakmounting') return 1;

                    // Priority 2: proses_adjustment_design first
                    if (a.status === 'proses_adjustment_design' && b.status !== 'proses_adjustment_design') return -1;
                    if (b.status === 'proses_adjustment_design' && a.status !== 'proses_adjustment_design') return 1;
                    
                    // Priority 3: menunggu_adjustment_design second
                    if (a.status === 'menunggu_adjustment_design' && b.status !== 'menunggu_adjustment_design') return -1;
                    if (b.status === 'menunggu_adjustment_design' && a.status !== 'menunggu_adjustment_design') return 1;
                    
                    // Special handling for completed items: sort by machine off time in reverse order
                    if (a.status === 'selesai' && b.status === 'selesai') {
                        const dateA = new Date(a.machine_off_at || 0);
                        const dateB = new Date(b.machine_off_at || 0);
                        return dateB - dateA; // Newest first
                    }

                    // Priority 4: Within same status, sort by created_at (oldest first for FIFO)
                    const dateA = new Date(a.created_at || a.machine_off_at || 0);
                    const dateB = new Date(b.created_at || b.machine_off_at || 0);
                    return dateA - dateB;
                });
                
                // Tampilkan data yang menunggu, dalam proses, dan yang ditolak
                const initialData = adjustmentData.filter(item => 
                    item.status === 'menunggu_adjustment_design' || 
                    item.status === 'proses_adjustment_design' ||
                    item.status === 'ditolakmounting'
                );

                displayData(initialData);
                updateSummary(allData);
                populateMesinFilter(allData);
                
                showToast('Data berhasil dimuat', 'success', 2000);
                
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('loadingIndicator').style.display = 'none';
                document.getElementById('noDataMessage').classList.remove('d-none');
                showToast('Gagal memuat data', 'error');
            }
        }

// Update juga bagian filter status untuk menampilkan opsi 'Ditolakmounting'
// Tambahkan di HTML filter section:

        // Populate mesin filter
        function populateMesinFilter(data) {
            const mesinSet = new Set();
            data.forEach(item => {
                if (item.mesin_cetak) {
                    mesinSet.add(item.mesin_cetak);
                }
            });
            
            const mesinFilter = document.getElementById('mesinFilter');
            mesinFilter.innerHTML = '<option value="">Semua Mesin</option>';
            
            Array.from(mesinSet).sort().forEach(mesin => {
                mesinFilter.innerHTML += `<option value="${mesin}">${mesin}</option>`;
            });
        }

        // Display data cards
        function displayData(data) {
            document.getElementById('loadingIndicator').style.display = 'none';
            const container = document.getElementById('adjustmentCards');
            
            if (!data || data.length === 0) {
                document.getElementById('noDataMessage').classList.remove('d-none');
                container.innerHTML = '';
                return;
            }
            
            document.getElementById('noDataMessage').classList.add('d-none');
            
            const html = data.map(item => {
                const statusBadge = getStatusBadge(item.status);
                const remarksBadge = getRemarksBadge(item.remarks);
                const actionButtons = getActionButtons(item);
                
                // Info penolakan jika status ditolak
                const declineInfo = item.status === 'ditolakmounting' ? `
                    <div class="alert alert-danger mt-3">
                        <div class="d-flex">
                            <i class="fas fa-times-circle me-2 mt-1"></i>
                            <div>
                                <strong>Alasan:</strong>
                                <p class="mb-0 fw-bold">${item.decline_reason || 'Tidak ada alasan yang diberikan'}</p>
                                <div class="mt-2 small">
                                    <div class="text-danger">Ditolak oleh: <span class="fw-bold">${item.declined_by || '-'}</span></div>
                                    <div class="text-muted">Pada: ${formatDateTimeIndonesia(item.declined_at) || '-'}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                ` : '';
                
                return `
                <div class="col-lg-6 col-xl-4 mb-4">
                    <div class="card data-card h-100">
                        <div class="card-header card-header-clean">
                            <div class="row align-items-center">
                                <div class="col-8">
                                    <h6 class="mb-1 fw-bold text-dark">
                                        <i class="fas fa-box me-2 text-primary"></i>${item.item_name}
                                    </h6>
                                    <small class="text-muted">
                                        <i class="fas fa-industry me-1"></i>${item.mesin_cetak}
                                    </small>
                                </div>
                                <div class="col-4 text-end">
                                    <div class="d-flex flex-column align-items-end">
                                        ${statusBadge}
                                        ${remarksBadge}
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="card-body p-0">
                            <!-- Main Info Section -->
                            <div class="p-3">
                                <div class="row g-3">
                                    <div class="col-6">
                                        <div class="info-label">WO Number</div>
                                        <div class="info-value">${item.wo_number}</div>
                                    </div>
                                    <div class="col-6">
                                        <div class="info-label">MC Number</div>
                                        <div class="info-value">${item.mc_number}</div>
                                    </div>
                                    <div class="col-6">
                                        <div class="info-label">Jumlah Plate</div>
                                        <div class="info-value">
                                            <i class="fas fa-layer-group me-1 text-primary"></i>
                                            ${item.jumlah_plate} plate
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="info-label">Run Length</div>
                                        <div class="info-value">
                                            <i class="fas fa-boxes me-1 text-success"></i>
                                            ${item.run_length}
                                        </div>
                                    </div>
                                </div>
                                
                                ${item.note ? `
                                <div class="mt-3">
                                    <div class="info-label">Catatan</div>
                                    <div class="small text-muted bg-light p-2 rounded">
                                        <i class="fas fa-sticky-note me-1"></i>
                                        ${item.note}
                                    </div>
                                </div>
                                ` : ''}
                                ${declineInfo}
                            </div>
                            
                            <!-- Timeline Section -->
                            <div class="info-section mx-3">
                                <div class="info-label mb-2">
                                    <i class="fas fa-clock me-1"></i>Timeline Proses
                                </div>
                                <div class="row g-2">
                                    ${item.machine_off_at ? `
                                    <div class="col-12">
                                        <div class="d-flex align-items-center">
                                            <div class="bg-danger rounded-circle me-2" style="width: 8px; height: 8px;"></div>
                                            <small class="text-muted">Mesin Off:</small>
                                            <small class="ms-auto fw-bold">${formatDateTimeIndonesia(item.machine_off_at)}</small>
                                        </div>
                                    </div>
                                    ` : ''}
                                    ${item.design_start_at ? `
                                    <div class="col-12">
                                        <div class="d-flex align-items-center">
                                            <div class="bg-info rounded-circle me-2" style="width: 8px; height: 8px;"></div>
                                            <small class="text-muted">Mulai Adjustment:</small>
                                            <small class="ms-auto fw-bold">${formatDateTimeIndonesia(item.design_start_at)}</small>
                                        </div>
                                    </div>
                                    ` : ''}
                                    ${item.design_finish_at ? `
                                    <div class="col-12">
                                        <div class="d-flex align-items-center">
                                            <div class="bg-success rounded-circle me-2" style="width: 8px; height: 8px;"></div>
                                            <small class="text-muted">Selesai Adjustment:</small>
                                            <small class="ms-auto fw-bold">${formatDateTimeIndonesia(item.design_finish_at)}</small>
                                        </div>
                                    </div>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                        <div class="card-footer bg-light border-0 p-3">
                            <div class="d-flex gap-2 justify-content-between">
                                <div class="flex-grow-1">
                                    ${actionButtons}
                                </div>
                                <a href="/detail-adjustment/${item.id}" class="btn btn-outline-clean btn-clean">
                                    <i class="fas fa-eye me-1"></i>Detail
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
                `;
            }).join('');
            
            container.innerHTML = html;
        }
        
        // Inject current user name for JS logic
        window.currentUserName = "{{ current_user.name }}";
        
        // Get status badge - Using design Division Badge System
        function getStatusBadge(status) {
            if (window.BadgeSystem) {
                const statusInfo = window.BadgeSystem.getStatusInfo(status, 'design');
                if (statusInfo) {
                    return `<span class="badge status-badge ${statusInfo.class}" data-status="${status}">${statusInfo.label}</span>`;
                }
            }
            
            // Fallback untuk design division
            const designBadges = {
                'menunggu_adjustment_design': '<span class="badge status-badge badge-menunggu" data-status="menunggu_adjustment_design">Menunggu Adjustment</span>',
                'proses_adjustment_design': '<span class="badge status-badge badge-proses" data-status="proses_adjustment_design">Proses Adjustment</span>',
                'menunggu_adjustment': '<span class="badge status-badge badge-selesai" data-status="selesai">Selesai</span>',
                'proses_adjustment': '<span class="badge status-badge badge-selesai" data-status="selesai">Selesai</span>',
                'proses_ctp': '<span class="badge status-badge badge-selesai" data-status="selesai">Selesai</span>',
                'proses_plate': '<span class="badge status-badge badge-selesai" data-status="selesai">Selesai</span>',
                'antar_plate': '<span class="badge status-badge badge-selesai" data-status="selesai">Selesai</span>',                                                                
                'selesai': '<span class="badge status-badge badge-selesai" data-status="selesai">Selesai</span>',
                'ditolakmounting': '<span class="badge status-badge badge-danger" data-status="ditolakmounting">Ditolak Mounting</span>'
            };
            return designBadges[status] || '<span class="badge status-badge badge-menunggu">Unknown</span>';
        }

        // Get remarks badge
        function getRemarksBadge(remarks) {
            if (!remarks) return '';
            
            const remarksLower = remarks.toLowerCase();
            
            if (remarksLower.includes('adjustment fa proof')) {
                return '<span class="badge remarks-badge-clean badge-fa-proof">FA Proof</span>';
            } else if (remarksLower.includes('adjustment fa produksi')) {
                return '<span class="badge remarks-badge-clean badge-fa-produksi">FA Produksi</span>';
            } else {
                // For other remarks, show truncated version
                const shortRemarks = remarks.length > 15 ? remarks.substring(0, 15) + '...' : remarks;
                return `<span class="badge remarks-badge-clean badge-remarks-default">${shortRemarks}</span>`;
            }
        }

        // Get action buttons
        function getActionButtons(item) {
            if (item.status === 'menunggu_adjustment_design' || item.status === 'ditolakmounting') {
                return `<button class="btn btn-primary-clean btn-clean flex-grow-1" onclick="startAdjustment(${item.id})">
                    <i class="fas fa-play me-1"></i>${item.status === 'ditolakmounting' ? 'Proses Ulang' : 'Mulai Adjustment'}
                </button>`;
            } else if (item.status === 'proses_adjustment_design') {
                if (window.currentUserName && item.design_by && window.currentUserName === item.design_by) {
                    return `<button class="btn btn-success-clean btn-clean flex-grow-1" onclick="finishAdjustment(${item.id})">
                        <i class="fas fa-check me-1"></i>Selesai Adjustment
                    </button>`;
                } else {
                    return `<button class="btn btn-success-clean btn-clean flex-grow-1" hidden title="Hanya operator yang memulai yang bisa menyelesaikan">
                        <i class="fas fa-check me-1"></i>Selesai Adjustment
                    </button>`;
                }
            }
            return ''; // Empty string instead of "Tidak ada aksi tersedia"
        }

        // Update summary
        function updateSummary(data) {
            const today = new Date().toISOString().split('T')[0];
            
            const summary = {
                waiting: data.filter(item => item.status === 'menunggu_adjustment_design').length,
                
                completedToday: data.filter(item => 
                    (item.status === 'menunggu_adjustment' || item.status === 'selesai') && 
                    item.design_finish_at && item.design_finish_at.startsWith(today)
                ).length,
                
                // Gabungkan FA Proof dan FA Produksi DAN hanya hitung jika is_epson adalah true
                totalFa: data.filter(item => 
                    // 1. Cek apakah ini item EPSON (is_epson == true)
                    item.is_epson === true && 
                    
                    // 2. Cek apakah remarks adalah FA
                    item.remarks && (
                        item.remarks.toLowerCase().includes('adjustment fa proof') ||
                        item.remarks.toLowerCase().includes('adjustment fa produksi')
                    )
                ).length
            };

            document.getElementById('waitingCount').textContent = summary.waiting;
            document.getElementById('completedTodayCount').textContent = summary.completedToday;
            document.getElementById('totalFaCount').textContent = summary.totalFa;
        }

        // Start adjustment
        function startAdjustment(id) {
            const item = adjustmentData.find(item => item.id === id);
            if (!item) return;
            
            currentAdjustmentId = id;
            
            document.getElementById('startAdjustmentInfo').innerHTML = `
                <div class="row g-3">
                    <div class="col-12">
                        <div class="info-label">Item Name</div>
                        <div class="info-value">
                            <i class="fas fa-box me-1 text-success"></i>
                            ${item.item_name}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="info-label">WO Number</div>
                        <div class="info-value">
                            <i class="fas fa-file-alt me-1 text-info"></i>
                            ${item.wo_number}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="info-label">MC Number</div>
                        <div class="info-value">
                            <i class="fas fa-barcode me-1 text-warning"></i>
                            ${item.mc_number}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="info-label">Mesin Cetak</div>
                        <div class="info-value">
                            <i class="fas fa-industry me-1 text-primary"></i>
                            ${item.mesin_cetak}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="info-label">Jumlah Plate</div>
                        <div class="info-value">
                            <i class="fas fa-layer-group me-1 text-secondary"></i>
                            ${item.jumlah_plate} plate
                        </div>
                    </div>
                    ${item.remarks ? `
                    <div class="col-12">
                        <div class="info-label">Remarks</div>
                        <div class="info-value">
                            <i class="fas fa-comment-alt me-1 text-primary"></i>
                            ${item.remarks}
                        </div>
                    </div>
                    ` : ''}
                    ${item.note ? `
                    <div class="col-12 mt-3">
                        <div class="info-label">Catatan Request</div>
                        <div class="alert alert-light border border-warning" style="background: linear-gradient(135deg, #fff8e1 0%, #fffde7 100%); border-radius: 8px;">
                            <div class="d-flex align-items-start">
                                <i class="fas fa-sticky-note me-2 text-warning mt-1"></i>
                                <div class="info-value text-dark">${item.note}</div>
                            </div>
                        </div>
                    </div>
                    ` : ''}
                </div>
            `;
            
            new bootstrap.Modal(document.getElementById('startAdjustmentModal')).show();
        }

        // Finish adjustment
        function finishAdjustment(id) {
            const item = adjustmentData.find(item => item.id === id);
            if (!item) return;
            
            currentAdjustmentId = id;
            
            document.getElementById('finishAdjustmentInfo').innerHTML = `
                <div class="row g-3">
                    <div class="col-12">
                        <div class="info-label">Item Name</div>
                        <div class="info-value">
                            <i class="fas fa-box me-1 text-success"></i>
                            ${item.item_name}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="info-label">WO Number</div>
                        <div class="info-value">
                            <i class="fas fa-file-alt me-1 text-info"></i>
                            ${item.wo_number}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="info-label">MC Number</div>
                        <div class="info-value">
                            <i class="fas fa-barcode me-1 text-warning"></i>
                            ${item.mc_number}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="info-label">Mesin Cetak</div>
                        <div class="info-value">
                            <i class="fas fa-industry me-1 text-primary"></i>
                            ${item.mesin_cetak}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="info-label">Jumlah Plate</div>
                        <div class="info-value">
                            <i class="fas fa-layer-group me-1 text-secondary"></i>
                            ${item.jumlah_plate} plate
                        </div>
                    </div>
                    ${item.remarks ? `
                    <div class="col-12">
                        <div class="info-label">Remarks</div>
                        <div class="info-value">
                            <i class="fas fa-comment-alt me-1 text-primary"></i>
                            ${item.remarks}
                        </div>
                    </div>
                    ` : ''}
                    ${item.note ? `
                    <div class="col-12 mt-3">
                        <div class="info-label">Catatan Request</div>
                        <div class="alert alert-light border border-warning" style="background: linear-gradient(135deg, #fff8e1 0%, #fffde7 100%); border-radius: 8px;">
                            <div class="d-flex align-items-start">
                                <i class="fas fa-sticky-note me-2 text-warning mt-1"></i>
                                <div class="info-value text-dark">${item.note}</div>
                            </div>
                        </div>
                    </div>
                    ` : ''}
                    <div class="col-12 mt-3">
                        <div class="info-label">Waktu Dimulai Adjustment</div>
                        <div class="info-value">
                            <i class="fas fa-clock me-1 text-info"></i>
                            ${formatDateTimeIndonesia(item.design_start_at)}
                            ${item.design_by ? '<span class="text-muted ms-2">[PIC: ' + item.design_by + ']</span>' : ''}
                        </div>
                    </div>
                </div>
            `;
            
            new bootstrap.Modal(document.getElementById('finishAdjustmentModal')).show();
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', async function() {
            // Request notification permission when page loads
            await requestNotificationPermission();
            
            loadData();
            
            // Filter functions
            function applyFilters() {
                const statusFilter = document.getElementById('statusFilter').value;
                const mesinFilter = document.getElementById('mesinFilter').value;
                const remarksFilter = document.getElementById('remarksFilter').value;
                const searchInput = document.getElementById('searchInput').value.toLowerCase().trim();
                
                let filteredData = [...adjustmentData]; // Create a copy to avoid modifying original array
                
                // If viewing completed items, sort by completion date (newest first)
                if (statusFilter === 'selesai') {
                    filteredData.sort((a, b) => {
                        const dateA = new Date(a.machine_off_at || 0);
                        const dateB = new Date(b.machine_off_at || 0);
                        return dateB - dateA;
                    });
                }
                
                // If no filters are applied, show waiting and in-progress adjustments
                const hasActiveFilters = statusFilter || mesinFilter || remarksFilter || searchInput;
                if (!hasActiveFilters) {
                    filteredData = adjustmentData.filter(item => 
                        item.status === 'menunggu_adjustment_design' || item.status === 'proses_adjustment_design'
                    );
                } else {
                    // Apply filters when user actively uses them
                    if (statusFilter) {
                        // Handle special cases for design division status filtering
                        if (statusFilter === 'selesai') {
                            // Show only items that have completed the design process (have both timestamps)
                            filteredData = filteredData.filter(item => 
                                item.design_start_at && item.design_finish_at
                            );
                        } else {
                            filteredData = filteredData.filter(item => item.status === statusFilter);
                        }
                    }
                    
                    if (mesinFilter) {
                        filteredData = filteredData.filter(item => item.mesin_cetak === mesinFilter);
                    }
                    
                    if (remarksFilter) {
                        filteredData = filteredData.filter(item => 
                            item.remarks && item.remarks.toUpperCase().includes(remarksFilter)
                        );
                    }
                    
                    if (searchInput) {
                        filteredData = filteredData.filter(item => {
                            const searchFields = [
                                item.wo_number || '',
                                item.mc_number || '',
                                item.item_name || '',
                                item.mesin_cetak || '',
                                item.remarks || ''
                            ];
                            return searchFields.some(field => 
                                field.toLowerCase().includes(searchInput)
                            );
                        });
                    }
                }
                
                displayData(filteredData);
                
                // No need for toast notifications on filter/search actions
                // Users can see the results directly in the interface
            }
            
            // Status filter
            document.getElementById('statusFilter').addEventListener('change', function() {
                applyFilters();
            });
            
            // Mesin filter
            document.getElementById('mesinFilter').addEventListener('change', applyFilters);
            
            // Remarks filter
            document.getElementById('remarksFilter').addEventListener('change', applyFilters);
            
            // Search input
            document.getElementById('searchInput').addEventListener('input', applyFilters);
            
            // Refresh button
            document.getElementById('refreshData').addEventListener('click', loadData);
            
            // Confirm start adjustment
            document.getElementById('confirmStartAdjustment').addEventListener('click', async function() {
                const adjustmentBy = document.getElementById('adjustmentBy').value.trim();
                
                if (!adjustmentBy) {
                    showToast('Harap isi nama PIC adjustment', 'error');
                    return;
                }
                
                // Get the current item to check if it's a reprocess
                const currentItem = adjustmentData.find(item => item.id === currentAdjustmentId);
                const isReprocess = currentItem?.status === 'ditolakmounting';
                
                try {
                    const response = await fetch('/start-adjustment-design', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            id: currentAdjustmentId,
                            design_by: adjustmentBy,
                            is_reprocess: isReprocess // Add flag for reprocess
                        })
                    });
                    
                    if (response.ok) {
                        bootstrap.Modal.getInstance(document.getElementById('startAdjustmentModal')).hide();
                        showToast('Proses adjustment berhasil dimulai', 'success');
                        loadData();
                    } else {
                        showToast('Gagal memulai adjustment', 'error');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    showToast('Terjadi kesalahan saat memulai adjustment', 'error');
                }
            });
            
            // Confirm finish adjustment
            document.getElementById('confirmFinishAdjustment').addEventListener('click', async function() {
                try {
                    const response = await fetch('/finish-adjustment-design', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            id: currentAdjustmentId
                        })
                    });
                    
                    if (response.ok) {
                        bootstrap.Modal.getInstance(document.getElementById('finishAdjustmentModal')).hide();
                        loadData();
                    } else {
                        showToast('Gagal menyelesaikan adjustment', 'error');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('Terjadi kesalahan');
                }
            });
            
            // Confirm export
            document.getElementById('confirmExport').addEventListener('click', function() {
                exportDesignData();
            });
        });
        
        // DESIGN ENHANCEMENTS - Professional Features
        
        // Auto-refresh functionality
        let autoRefreshInterval;
        let autoRefreshEnabled = true;
        
        function startAutoRefresh() {
            if (autoRefreshInterval) clearInterval(autoRefreshInterval);
            if (autoRefreshEnabled) {
                autoRefreshInterval = setInterval(() => {
                    loadData(); // Silent refresh without notification
                }, 30000); // 30 seconds
            }
        }
        
        // Auto-refresh toggle
        document.getElementById('autoRefresh').addEventListener('change', function() {
            autoRefreshEnabled = this.checked;
            if (autoRefreshEnabled) {
                showToast('Auto-refresh diaktifkan (setiap 30 detik)', 'success');
                startAutoRefresh();
            } else {
                clearInterval(autoRefreshInterval);
                showToast('Auto-refresh dinonaktifkan', 'info');
            }
        });
        
        // Export functionality
        document.getElementById('exportData').addEventListener('click', function() {
            showExportModal();
        });
        
        function showExportModal() {
            // Set current filter values to export modal (excluding mesin and search)
            document.getElementById('exportStatusFilter').value = document.getElementById('statusFilter').value;
            document.getElementById('exportRemarksFilter').value = document.getElementById('remarksFilter').value;
            
            new bootstrap.Modal(document.getElementById('exportModal')).show();
        }
        
        function exportDesignData() {
            try {
                showToast('Mempersiapkan export data...', 'info');
                
                // Get export filter values (no mesin and search field)
                const statusFilter = document.getElementById('exportStatusFilter').value;
                const remarksFilter = document.getElementById('exportRemarksFilter').value;
                const dateFrom = document.getElementById('exportDateFrom').value;
                const dateTo = document.getElementById('exportDateTo').value;
                
                // Build export URL with parameters (no mesin and search parameter)
                const params = new URLSearchParams();
                if (statusFilter) params.append('status', statusFilter);
                if (remarksFilter) params.append('remarks', remarksFilter);
                if (dateFrom) params.append('date_from', dateFrom);
                if (dateTo) params.append('date_to', dateTo);
                
                const exportUrl = '/export-design-adjustment?' + params.toString();
                
                // Create temporary link and trigger download
                const link = document.createElement('a');
                link.href = exportUrl;
                link.style.display = 'none';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // Close modal and show success message
                bootstrap.Modal.getInstance(document.getElementById('exportModal')).hide();
                showToast('Export Data berhasil dimulai, file akan segera didownload', 'success');
                
            } catch (error) {
                console.error('Export error:', error);
                showToast('Gagal export data', 'error');
            }
        }
        
        function extractCardData(card) {
            // This function is no longer used - kept for compatibility
            return null;
        }
        
        function createCSV(data) {
            // This function is no longer used - kept for compatibility
            return '';
        }
        
        // Browser Notification System
        async function requestNotificationPermission() {
            if (!('Notification' in window)) {
                console.log('Browser tidak mendukung notifikasi');
                return false;
            }

            if (Notification.permission === 'granted') {
                return true;
            }

            if (Notification.permission !== 'denied') {
                const permission = await Notification.requestPermission();
                return permission === 'granted';
            }

            return false;
        }

        // Add audio element for notification sound
        const notificationSound = new Audio('/static/sounds/adjustment.mp3');

        // Function to show browser notification
        function showBrowserNotification(title, options = {}) {
            if (Notification.permission === 'granted') {
                const defaultOptions = {
                    icon: '/static/img/prepress_impact_logo.png',
                    badge: '/static/img/prepress_impact_logo.png',
                    vibrate: [200, 100, 200],
                    silent: false,
                    requireInteraction: false,
                    sound: '/static/sounds/adjustment.mp3'  // Add sound URL
                };

                // Create and show notification
                const notification = new Notification(title, { ...defaultOptions, ...options });

                // Play sound if not silent
                if (!options.silent) {
                    notificationSound.play().catch(e => console.log('Error playing sound:', e));
                }

                // Add click event listener
                notification.onclick = function(event) {
                    event.preventDefault();
                    window.focus();
                    notification.close();
                };
            }
        }

        // Toast notification system
        function showToast(message, type = 'info', duration = 5000) {
            const toastContainer = document.getElementById('toastContainer');
            const toastId = 'toast-' + Date.now();
            
            const toastHTML = `
                <div class="toast toast-${type}" id="${toastId}" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="toast-body d-flex align-items-center">
                        <i class="fas ${getToastIcon(type)} me-2"></i>
                        <span class="flex-grow-1">${message}</span>
                        <button type="button" class="btn-close btn-close-white ms-2" data-bs-dismiss="toast"></button>
                    </div>
                </div>
            `;
            
            toastContainer.insertAdjacentHTML('beforeend', toastHTML);
            
            const toastElement = document.getElementById(toastId);
            const toast = new bootstrap.Toast(toastElement, { delay: duration });
            toast.show();
            
            // Auto remove after hiding
            toastElement.addEventListener('hidden.bs.toast', function() {
                toastElement.remove();
            });
        }
        
        function getToastIcon(type) {
            const icons = {
                'success': 'fa-check-circle',
                'error': 'fa-exclamation-circle',
                'info': 'fa-info-circle',
                'warning': 'fa-exclamation-triangle'
            };
            return icons[type] || icons['info'];
        }
        
        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Ctrl+R: Refresh
            if (e.ctrlKey && e.key === 'r') {
                e.preventDefault();
                loadData(); // Silent refresh
            }
            
            // Ctrl+E: Export
            if (e.ctrlKey && e.key === 'e') {
                e.preventDefault();
                exportDesignData(); // Export function already has its own notifications
            }
            
            // Escape: Close modals
            if (e.key === 'Escape') {
                const modals = document.querySelectorAll('.modal.show');
                modals.forEach(modal => {
                    bootstrap.Modal.getInstance(modal)?.hide();
                });
            }
        });
        
        // Initialize auto-refresh on page load
        startAutoRefresh();
        
    </script>
</body>
</html>
