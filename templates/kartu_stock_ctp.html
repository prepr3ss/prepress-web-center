<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Impact 360</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <style>
        /* Page Header dengan gradient orange seperti template CTP lainnya */
        .page-header {
            background: linear-gradient(135deg, #ff9500 0%, #ff6b00 100%);
            color: white;
            padding: 2rem 0;
            margin: -1rem -15px 2rem -15px;
            border-radius: 0 0 20px 20px;
            box-shadow: 0 4px 20px rgba(255, 149, 0, 0.2);
        }

        /* Scrollbar styling dengan tema orange */
        .table-responsive-kartu-stock::-webkit-scrollbar {
            height: 8px;
        }
        
        .table-responsive-kartu-stock::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        
        .table-responsive-kartu-stock::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #ff9500 0%, #ff6b00 100%);
            border-radius: 4px;
        }
        
        .table-responsive-kartu-stock-kartu-stock::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #ff6b00 0%, #ff4500 100%);
        }

        /* Input group styling */
        .input-group .form-control {
            border-right: none;
        }
        
        .input-group .btn-outline-secondary {
            border-left: none;
            border-color: #e9ecef;
            background: #f8f9fa;
        }
        
        .input-group .btn-outline-secondary:hover {
            background: #e9ecef;
            border-color: #dee2e6;
        }
                
        .form-label {
            font-size: 0.75rem;
            font-weight: 600;
            color: #6c757d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.25rem;
        }
        
        /* Filter section styling */
        .filter-section {
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            margin-bottom: 2rem;
        }
        
        /* Table styling */
        .table-responsive-kartu-stock {
            width: 100%;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            overflow: hidden;
            background: white;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        /* Ensure first column has enough space for item name + warning icon */
        .stock-table td:first-child {
            min-width: 180px;
            padding-right: 8px; 
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            
            /* PENTING: Gunakan Flexbox untuk centering dan tata letak */
            display: flex;
            align-items: center; /* Konten center secara vertikal (sudah benar) */
            justify-content: center; /* GANTI KE 'center' untuk center secara horizontal */
        }
        
        /* Atur Ikon Peringatan */
        .stock-table td:first-child .fa-exclamation-triangle {
            margin-left: 4px; /* Jarak antara teks dan ikon */
            color: #ffc107;
            font-size: 1.1em;
        }

        /* CSS KUSTOM UNTUK MEMBESARKAN BADGE DI ALERT */
        .alert .badge-lg {
            font-size: 0.95em; /* Sedikit lebih besar dari default badge */
            padding: 0.4em 0.8em; /* Padding yang lebih tebal */
            transform: scale(1.05); /* Sedikit efek pop-out */
        }

        /* Kustomisasi Judul Alert agar lebih menonjol */
        #stockAlertInfo .alert-title {
            font-size: 1.25em; /* Judul lebih besar */
            font-weight: 700;
        }        
        
        .stock-table {
            margin-bottom: 0;
            border-collapse: separate;
            border-spacing: 0;
        }
        
        .stock-table thead th {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: none;
            font-weight: 600;
            color: #495057;
            padding: 1rem 0.75rem;
            text-align: center;
            vertical-align: middle;
        }

        .stock-table tbody td {
            vertical-align: middle;
            padding: 0.75rem;
            border: 1px solid #dee2e6;
            font-size: 0.9rem;
            text-align: center;
        }

        .stock-table tbody tr:hover {
            background-color: rgba(255, 149, 0, 0.05);
        }

        .stock-table tbody td:first-child {
            text-align: left;
            font-weight: 500;
        }

        .brand-logo-container {
            padding: 20px;
            padding-bottom: 19px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid #dee2e6;
        }

        .brand-logo-container-saphira {
            padding: 19.1px 20px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid #dee2e6;
        }

        .brand-logo {
            display: flex;
            align-items: center;
        }

        .stock-confirmation-status {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-left: 20px;
        }

        /* Confirmation styles removed */

        .date-display {
            font-size: 1rem;
            color: #374151;
            font-weight: 500;
            margin-bottom: 1rem;
            text-align: right;
        }

        .shift-display {
            font-size: 1rem;
            color: #374151;
            font-weight: 500;
            margin-bottom: 1rem;
            text-align: right;
        }        

        .mb-5 {
            margin-bottom: 2rem !important;
        }

        /* Form controls styling */
        .form-select, .form-control {
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 0.75rem 1rem;
            transition: all 0.3s ease;
        }
        
        .form-select:focus, .form-control:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }
        
        .btn-export-csv {
            background: linear-gradient(135deg, #06b406 0%, #008000 100%);
            color: white;
        }

        /* Toast styling */
        .toast {
            border: none;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        
        .toast-body {
            border-radius: 12px;
            padding: 1rem;
        }

        /* Loading Spinner */
        .spinner-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .spinner-content {
            background: white;
            padding: 2rem;
            border-radius: 0.5rem;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        }

        /* Pagination styling dengan tema CTP orange */
        .pagination .page-link {
            border: 2px solid #e9ecef;
            color: #6c757d;
            border-radius: 8px;
            margin: 0 2px;
            padding: 0.5rem 0.75rem;
            transition: all 0.3s ease;
        }
        
        .pagination .page-link:hover {
            border-color: #ff9500;
            color: #ff9500;
            background-color: rgba(255, 149, 0, 0.1);
        }
        
        .pagination .page-item.active .page-link {
            background: linear-gradient(135deg, #ff9500 0%, #ff6b00 100%);
            border-color: #ff9500;
            color: white;
        }

        /* Low Stock Alert Styling */
        .low-stock {
            background-color: #fff3cd !important;
            animation: lowStockPulse 2s infinite;
        }

        #stockAlertInfo li {
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }

        @keyframes lowStockPulse {
            0% { background-color: #fff3cd !important; }
            50% { background-color: #ffe5d0 !important; }
            100% { background-color: #fff3cd !important; }
        }
    </style>
</head>
<body>
    <div id="wrapper">
        {% include '_top_header.html' %}
        <div class="d-flex" id="content-wrapper">
            {% include '_sidebar.html' %}
            <div class="container-fluid pt-3">
                <!-- Page Header -->
                <div class="page-header">
                    <div class="container-fluid">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h2 class="mb-1 text-white">Kartu Stock CTP</h2>
                                <p class="mb-0 opacity-75">Data Kartu Stock CTP</p>
                            </div>
                            <div class="text-end">
                                {% if current_user.role == 'admin' %}
                                <button onclick="showInitialStockModal()" class="btn btn-primary me-2">
                                    <i class="fas fa-clipboard-check me-1"></i> Input Stok Awal
                                </button>
                                {% endif %}
                                <button onclick="showInputIncomingModal()" class="btn btn-light">
                                    <i class="fas fa-plus-circle me-1"></i> Input Incoming Stock
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Filter Controls -->
                <div class="filter-section">
                    <div class="row align-items-end g-3">
                        <div class="col-md-2">
                            <label for="stockDate" class="form-label">Filter Tanggal/Bulan/Tahun</label>
                            <input type="date" class="form-control form-control-clean" id="stockDate" onchange="updateData()" required>
                        </div>
                        <div class="col-md-2">
                            <label for="shiftFilter" class="form-label">Filter Shift</label>
                            <select class="form-select" id="shiftFilter" onchange="updateData()">
                                <option value="1">Shift 1</option>
                                <option value="2">Shift 2</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Stock Alert Info -->
                <div class="alert alert-success mb-4" id="stockAlertInfo">
                    <div class="d-flex align-items-center mb-2">
                        <i class="fas fa-check-circle me-2"></i> 
                        <strong class="alert-title">Status Stock Aman</strong>
                    </div>
                    
                    <div class="row" id="lowStockItems" style="display: none;"> 
                        <div class="col-md-6">
                            <strong class="d-block mb-2">FUJI:</strong>
                            <ul class="list-unstyled mb-0 small" id="fujiLowStockList">
                                </ul>
                        </div>
                        <div class="col-md-6">
                            <strong class="d-block mb-2">SAPHIRA:</strong>
                            <ul class="list-unstyled mb-0 small" id="saphiraLowStockList">
                                </ul>
                        </div>
                    </div>
                    
                    <div id="noLowStockMessage"> 
                        <p class="mb-0 text-success">
                            <i class="fas fa-check-circle me-1"></i>
                            Semua item stok dalam batas aman
                        </p>
                    </div>
                </div>

                <!-- Tables Container -->
                <div class="d-flex flex-column">
                    <div class="table-responsive-kartu-stock">
                        <div class="brand-logo-container">
                            <div class="brand-logo">
                                <img src="{{ url_for('static', filename='img/Fujifilm_logo.svg') }}" alt="Fuji" style="height: 28px;">
                            </div>
                            <div class="date-shift-container">
                                <div class="date-display" id="fujiDateDisplay"></div>
                                <div class="shift-display" id="fujiShiftDisplay"></div>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-bordered table-hover align-middle stock-table mb-5" id="kartuStockPlateFujiTable">
                                <thead>
                                    <tr>
                                        <th rowspan="2">Item Name</th>
                                        <th colspan="2">Stock Awal</th>
                                        <th colspan="1">Pemakaian</th>
                                        <th colspan="1">Incoming</th>
                                        <th colspan="3">Stock Akhir</th>
                                    </tr>
                                    <tr>
                                        <th>BOX</th>
                                        <th>PCS</th>
                                        <th>PCS</th>
                                        <th>BOX</th>
                                        <th>BOX</th>
                                        <th>PCS</th>
                                        <th>TOTAL PCS</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr data-item-code="02-049-000-0000008">
                                        <td>FUJI 1030</td>
                                        <td data-field="jumlah_stock_awal_box">0</td>
                                        <td data-field="jumlah_stock_awal_pcs">0</td>
                                        <td data-field="jumlah_pemakaian">0</td>
                                        <td data-field="jumlah_incoming">0</td>
                                        <td data-field="jumlah_stock_akhir_box">0</td>
                                        <td data-field="jumlah_stock_akhir_pcs">0</td>
                                        <td data-field="jumlah_stock_akhir">0</td>
                                    </tr>
                                    <tr data-item-code="02-049-000-0000010">
                                        <td>FUJI 1055</td>
                                        <td data-field="jumlah_stock_awal_box">0</td>
                                        <td data-field="jumlah_stock_awal_pcs">0</td>
                                        <td data-field="jumlah_pemakaian">0</td>
                                        <td data-field="jumlah_incoming">0</td>
                                        <td data-field="jumlah_stock_akhir_box">0</td>
                                        <td data-field="jumlah_stock_akhir_pcs">0</td>
                                        <td data-field="jumlah_stock_akhir">0</td>
                                    </tr>
                                    <tr data-item-code="02-049-000-0000009">
                                        <td>FUJI 1630</td>
                                        <td data-field="jumlah_stock_awal_box">0</td>
                                        <td data-field="jumlah_stock_awal_pcs">0</td>
                                        <td data-field="jumlah_pemakaian">0</td>
                                        <td data-field="jumlah_incoming">0</td>
                                        <td data-field="jumlah_stock_akhir_box">0</td>
                                        <td data-field="jumlah_stock_akhir_pcs">0</td>
                                        <td data-field="jumlah_stock_akhir">0</td>
                                    </tr>
                                    <tr data-item-code="02-023-000-0000007">
                                        <td>FUJI 1030 UV</td>
                                        <td data-field="jumlah_stock_awal_box">0</td>
                                        <td data-field="jumlah_stock_awal_pcs">0</td>
                                        <td data-field="jumlah_pemakaian">0</td>
                                        <td data-field="jumlah_incoming">0</td>
                                        <td data-field="jumlah_stock_akhir_box">0</td>
                                        <td data-field="jumlah_stock_akhir_pcs">0</td>
                                        <td data-field="jumlah_stock_akhir">0</td>
                                    </tr>
                                    <tr data-item-code="02-049-000-0000012">
                                        <td>FUJI 1030 LHPJA</td>
                                        <td data-field="jumlah_stock_awal_box">0</td>
                                        <td data-field="jumlah_stock_awal_pcs">0</td>
                                        <td data-field="jumlah_pemakaian">0</td>
                                        <td data-field="jumlah_incoming">0</td>
                                        <td data-field="jumlah_stock_akhir_box">0</td>
                                        <td data-field="jumlah_stock_akhir_pcs">0</td>
                                        <td data-field="jumlah_stock_akhir">0</td>
                                    </tr>
                                    <tr data-item-code="02-023-000-0000012">
                                        <td>FUJI 1055 UV</td>
                                        <td data-field="jumlah_stock_awal_box">0</td>
                                        <td data-field="jumlah_stock_awal_pcs">0</td>
                                        <td data-field="jumlah_pemakaian">0</td>
                                        <td data-field="jumlah_incoming">0</td>
                                        <td data-field="jumlah_stock_akhir_box">0</td>
                                        <td data-field="jumlah_stock_akhir_pcs">0</td>
                                        <td data-field="jumlah_stock_akhir">0</td>
                                    </tr>
                                    <tr data-item-code="02-049-000-0000013">
                                        <td>FUJI 1055 LHPL</td>
                                        <td data-field="jumlah_stock_awal_box">0</td>
                                        <td data-field="jumlah_stock_awal_pcs">0</td>
                                        <td data-field="jumlah_pemakaian">0</td>
                                        <td data-field="jumlah_incoming">0</td>
                                        <td data-field="jumlah_stock_akhir_box">0</td>
                                        <td data-field="jumlah_stock_akhir_pcs">0</td>
                                        <td data-field="jumlah_stock_akhir">0</td>
                                    </tr>
                                </tbody>
                            </table>
                            
                            <table class="table table-bordered table-hover align-middle stock-table" id="kartuStockChemicalFujiTable">
                                <thead>
                                    <tr>
                                        <th>Item Name</th>
                                        <th>Stock Awal GLN</th>
                                        <th>Pemakaian GLN</th>
                                        <th>Incoming GLN</th>
                                        <th>Stock Akhir GLN</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr data-item-code="02-005-000-0000153">
                                        <td>FUJI DEVELOPER</td>
                                        <td data-field="jumlah_stock_awal">0</td>
                                        <td data-field="jumlah_pemakaian">0</td>
                                        <td data-field="jumlah_incoming">0</td>
                                        <td data-field="jumlah_stock_akhir">0</td>
                                    </tr>
                                    <tr data-item-code="02-005-000-0000154">
                                        <td>FUJI REPLENISHER</td>
                                        <td data-field="jumlah_stock_awal">0</td>
                                        <td data-field="jumlah_pemakaian">0</td>
                                        <td data-field="jumlah_incoming">0</td>
                                        <td data-field="jumlah_stock_akhir">0</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="table-responsive-kartu-stock">
                        <div class="brand-logo-container-saphira">
                            <div class="brand-logo">
                                <img src="{{ url_for('static', filename='img/Heidelberger-Druckmaschinen-New.svg') }}" alt="Saphira" style="height: 48px;">
                            </div>
                            <div class="date-shift-container">
                                <div class="date-display" id="saphiraDateDisplay"></div>
                                <div class="shift-display" id="saphiraShiftDisplay"></div>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-bordered table-hover align-middle stock-table mb-5" id="kartuStockPlateSaphiraTable">
                                <thead>
                                    <tr>
                                        <th rowspan="2">Item Name</th>
                                        <th colspan="2">Stock Awal</th>
                                        <th colspan="1">Pemakaian</th>
                                        <th colspan="1">Incoming</th>
                                        <th colspan="3">Stock Akhir</th>
                                    </tr>
                                    <tr>
                                        <th>BOX</th>
                                        <th>PCS</th>
                                        <th>PCS</th>
                                        <th>BOX</th>
                                        <th>BOX</th>
                                        <th>PCS</th>
                                        <th>TOTAL PCS</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr data-item-code="02-049-000-0000002">
                                        <td>SAPHIRA 1030</td>
                                        <td data-field="jumlah_stock_awal_box">0</td>
                                        <td data-field="jumlah_stock_awal_pcs">0</td>
                                        <td data-field="jumlah_pemakaian">0</td>
                                        <td data-field="jumlah_incoming">0</td>
                                        <td data-field="jumlah_stock_akhir_box">0</td>
                                        <td data-field="jumlah_stock_akhir_pcs">0</td>
                                        <td data-field="jumlah_stock_akhir">0</td>
                                    </tr>
                                    <tr data-item-code="02-049-000-0000003">
                                        <td>SAPHIRA 1055</td>
                                        <td data-field="jumlah_stock_awal_box">0</td>
                                        <td data-field="jumlah_stock_awal_pcs">0</td>
                                        <td data-field="jumlah_pemakaian">0</td>
                                        <td data-field="jumlah_incoming">0</td>
                                        <td data-field="jumlah_stock_akhir_box">0</td>
                                        <td data-field="jumlah_stock_akhir_pcs">0</td>
                                        <td data-field="jumlah_stock_akhir">0</td>
                                    </tr>
                                    <tr data-item-code="02-049-000-0000011">
                                        <td>SAPHIRA 1055 PN</td>
                                        <td data-field="jumlah_stock_awal_box">0</td>
                                        <td data-field="jumlah_stock_awal_pcs">0</td>
                                        <td data-field="jumlah_pemakaian">0</td>
                                        <td data-field="jumlah_incoming">0</td>
                                        <td data-field="jumlah_stock_akhir_box">0</td>
                                        <td data-field="jumlah_stock_akhir_pcs">0</td>
                                        <td data-field="jumlah_stock_akhir">0</td>
                                    </tr>
                                    <tr data-item-code="02-049-000-0000001">
                                        <td>SAPHIRA 1630</td>
                                        <td data-field="jumlah_stock_awal_box">0</td>
                                        <td data-field="jumlah_stock_awal_pcs">0</td>
                                        <td data-field="jumlah_pemakaian">0</td>
                                        <td data-field="jumlah_incoming">0</td>
                                        <td data-field="jumlah_stock_akhir_box">0</td>
                                        <td data-field="jumlah_stock_akhir_pcs">0</td>
                                        <td data-field="jumlah_stock_akhir">0</td>
                                    </tr>
                                </tbody>
                            </table>
                            
                            <table class="table table-bordered table-hover align-middle stock-table" id="kartuStockChemicalSaphiraTable">
                                <thead>
                                    <tr>
                                        <th>Item Name</th>
                                        <th>Stock Awal GLN</th>
                                        <th>Pemakaian GLN</th>
                                        <th>Incoming GLN</th>
                                        <th>Stock Akhir GLN</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr data-item-code="02-005-000-0000061">
                                        <td>SAPHIRA DEVELOPER</td>
                                        <td data-field="jumlah_stock_awal">0</td>
                                        <td data-field="jumlah_pemakaian">0</td>
                                        <td data-field="jumlah_incoming">0</td>
                                        <td data-field="jumlah_stock_akhir">0</td>
                                    </tr>
                                    <tr data-item-code="02-005-000-0000046">
                                        <td>SAPHIRA REPLENISHER</td>
                                        <td data-field="jumlah_stock_awal">0</td>
                                        <td data-field="jumlah_pemakaian">0</td>
                                        <td data-field="jumlah_incoming">0</td>
                                        <td data-field="jumlah_stock_akhir">0</td>
                                    </tr>
                                    <tr data-item-code="02-005-000-0000158">
                                        <td>SAPHIRA GUM</td>
                                        <td data-field="jumlah_stock_awal">0</td>
                                        <td data-field="jumlah_pemakaian">0</td>
                                        <td data-field="jumlah_incoming">0</td>
                                        <td data-field="jumlah_stock_akhir">0</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Pagination -->
                <nav class="mt-3">
                    <ul class="pagination justify-content-center" id="pagination"></ul>
                </nav>
            </div>
        </div>
    </div>
</div>

<!-- Modal Input Stok Awal -->
<div class="modal fade" id="initialStockModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Input Stok Awal</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="initialStockDate" class="form-label">Tanggal</label>
                    <input type="date" class="form-control" id="initialStockDate" required>
                </div>
                <div class="row">
                    <!-- Fuji Plates -->
                    <div class="col-md-6">
                        <h6>FUJI PLATE</h6>
                        <div class="table-responsive">
                            <table class="table table-bordered" id="fujiPlateTable">
                                <thead>
                                    <tr>
                                        <th>Item Name</th>
                                        <th>Box</th>
                                        <th>PCS</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr data-item-code="02-049-000-0000008" data-pcs-per-box="30">
                                        <td>PLATE FUJI 1030</td>
                                        <td><input type="number" class="form-control form-control-sm plate-box-input" data-brand="fuji"></td>
                                        <td><input type="number" class="form-control form-control-sm plate-pcs-input" data-brand="fuji"></td>
                                    </tr>
                                    <tr data-item-code="02-049-000-0000012" data-pcs-per-box="30">
                                        <td>PLATE FUJI 1030 LH-PJA</td>
                                        <td><input type="number" class="form-control form-control-sm plate-box-input" data-brand="fuji"></td>
                                        <td><input type="number" class="form-control form-control-sm plate-pcs-input" data-brand="fuji"></td>
                                    </tr>
                                    <tr data-item-code="02-023-000-0000007" data-pcs-per-box="30">
                                        <td>PLATE FUJI 1030 UV</td>
                                        <td><input type="number" class="form-control form-control-sm plate-box-input" data-brand="fuji"></td>
                                        <td><input type="number" class="form-control form-control-sm plate-pcs-input" data-brand="fuji"></td>
                                    </tr>
                                    <tr data-item-code="02-049-000-0000010" data-pcs-per-box="30">
                                        <td>PLATE FUJI 1055</td>
                                        <td><input type="number" class="form-control form-control-sm plate-box-input" data-brand="fuji"></td>
                                        <td><input type="number" class="form-control form-control-sm plate-pcs-input" data-brand="fuji"></td>
                                    </tr>
                                    <tr data-item-code="02-023-000-0000012" data-pcs-per-box="30">
                                        <td>PLATE FUJI 1055 UV</td>
                                        <td><input type="number" class="form-control form-control-sm plate-box-input" data-brand="fuji"></td>
                                        <td><input type="number" class="form-control form-control-sm plate-pcs-input" data-brand="fuji"></td>
                                    </tr>
                                    <tr data-item-code="02-049-000-0000013" data-pcs-per-box="30">
                                        <td>PLATE FUJI 1055 LH-PL</td>
                                        <td><input type="number" class="form-control form-control-sm plate-box-input" data-brand="fuji"></td>
                                        <td><input type="number" class="form-control form-control-sm plate-pcs-input" data-brand="fuji"></td>
                                    </tr>
                                    <tr data-item-code="02-049-000-0000009" data-pcs-per-box="15">
                                        <td>PLATE FUJI 1630</td>
                                        <td><input type="number" class="form-control form-control-sm plate-box-input" data-brand="fuji"></td>
                                        <td><input type="number" class="form-control form-control-sm plate-pcs-input" data-brand="fuji"></td>
                                    </tr>
                                    <!-- Add other Fuji plates here -->
                                </tbody>
                            </table>
                        </div>
                        
                        <h6 class="mt-3">FUJI CHEMICAL</h6>
                        <div class="table-responsive">
                            <table class="table table-bordered" id="fujiChemicalTable">
                                <thead>
                                    <tr>
                                        <th>Item Name</th>
                                        <th>Jumlah (GLN)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr data-item-code="02-005-000-0000153">
                                        <td>DEVELOPER FUJI</td>
                                        <td><input type="number" class="form-control form-control-sm chemical-input" data-brand="fuji"></td>
                                    </tr>
                                    <tr data-item-code="02-005-000-0000154">
                                        <td>REPLENISHER FUJI</td>
                                        <td><input type="number" class="form-control form-control-sm chemical-input" data-brand="fuji"></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Saphira Plates -->
                    <div class="col-md-6">
                        <h6>SAPHIRA PLATE</h6>
                        <div class="table-responsive">
                            <table class="table table-bordered" id="saphiraPlateTable">
                                <thead>
                                    <tr>
                                        <th>Item Name</th>
                                        <th>Box</th>
                                        <th>PCS</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr data-item-code="02-049-000-0000002" data-pcs-per-box="50">
                                        <td>SAPHIRA 1030</td>
                                        <td><input type="number" class="form-control form-control-sm plate-box-input" data-brand="saphira"></td>
                                        <td><input type="number" class="form-control form-control-sm plate-pcs-input" data-brand="saphira"></td>
                                    </tr>
                                    <tr data-item-code="02-049-000-0000003" data-pcs-per-box="50">
                                        <td>SAPHIRA 1055</td>
                                        <td><input type="number" class="form-control form-control-sm plate-box-input" data-brand="saphira"></td>
                                        <td><input type="number" class="form-control form-control-sm plate-pcs-input" data-brand="saphira"></td>
                                    </tr>
                                    <tr data-item-code="02-049-000-0000011" data-pcs-per-box="40">
                                        <td>SAPHIRA 1055 PN</td>
                                        <td><input type="number" class="form-control form-control-sm plate-box-input" data-brand="saphira"></td>
                                        <td><input type="number" class="form-control form-control-sm plate-pcs-input" data-brand="saphira"></td>
                                    </tr>
                                    <tr data-item-code="02-049-000-0000001" data-pcs-per-box="30">
                                        <td>SAPHIRA 1630</td>
                                        <td><input type="number" class="form-control form-control-sm plate-box-input" data-brand="saphira"></td>
                                        <td><input type="number" class="form-control form-control-sm plate-pcs-input" data-brand="saphira"></td>
                                    </tr>
                                    <!-- Add other Saphira plates here -->
                                </tbody>
                            </table>
                        </div>

                        <h6 class="mt-3">SAPHRIA CHEMICAL</h6>
                        <div class="table-responsive">
                            <table class="table table-bordered" id="saphiraChemicalTable">
                                <thead>
                                    <tr>
                                        <th>Item Name</th>
                                        <th>Jumlah (GLN)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr data-item-code="02-005-000-0000061">
                                        <td>SAPHIRA DEVELOPER</td>
                                        <td><input type="number" class="form-control form-control-sm chemical-input" data-brand="saphira"></td>
                                    </tr>
                                    <tr data-item-code="02-005-000-0000046">
                                        <td>SAPHIRA REPLENISHER</td>
                                        <td><input type="number" class="form-control form-control-sm chemical-input" data-brand="saphira"></td>
                                    </tr>
                                    <tr data-item-code="02-005-000-0000158">
                                        <td>SAPHIRA GUM</td>
                                        <td><input type="number" class="form-control form-control-sm chemical-input" data-brand="saphira"></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
                <button type="button" class="btn btn-primary" onclick="submitInitialStock()">Simpan</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Input Incoming Stock -->
<div class="modal fade" id="incomingStockModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false" aria-labelledby="incomingStockModalLabel" aria-hidden="true"> 
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="incomingStockModalLabel">Input Incoming Stock</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            
            <div class="modal-body">
                <div class="row g-3 mb-3">
                    <div class="col-md-4">
                        <label for="incomingStockDate" class="form-label">Tanggal</label>
                        <input type="date" class="form-control" id="incomingStockDate" required>
                    </div>
                    <div class="col-md-4">
                        <label for="shiftSelect" class="form-label">Shift</label>
                        <select class="form-select" id="shiftSelect">
                            <option value="1">Shift 1</option>
                            <option value="2">Shift 2</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label for="brandSelect" class="form-label">Brand</label>
                        <select class="form-select" id="brandSelect">
                            <option value="fuji" selected>Fuji</option>
                            <option value="saphira">Saphira</option>
                        </select>
                    </div>
                </div>
                
                <div id="fujiContent" class="brand-content">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Fuji Plates</h6>
                            <div class="table-responsive">
                                <table class="table table-bordered" id="fujiPlateIncomingTable">
                                    <thead>
                                        <tr class="table-primary">
                                            <th>Item Name</th>
                                            <th>Box</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr data-item-code="02-049-000-0000008" data-pcs-per-box="30">
                                            <td>PLATE FUJI 1030</td>
                                            <td><input type="number" class="form-control form-control-sm incoming-box-input" data-brand="fuji"></td>
                                        </tr>
                                        <tr data-item-code="02-049-000-0000012" data-pcs-per-box="30">
                                            <td>PLATE FUJI 1030 LH-PJA</td>
                                            <td><input type="number" class="form-control form-control-sm incoming-box-input" data-brand="fuji"></td>
                                        </tr>
                                        <tr data-item-code="02-023-000-0000007" data-pcs-per-box="30">
                                            <td>PLATE FUJI 1030 UV</td>
                                            <td><input type="number" class="form-control form-control-sm incoming-box-input" data-brand="fuji"></td>
                                        </tr>
                                        <tr data-item-code="02-049-000-0000010" data-pcs-per-box="30">
                                            <td>PLATE FUJI 1055</td>
                                            <td><input type="number" class="form-control form-control-sm incoming-box-input" data-brand="fuji"></td>
                                        </tr>
                                        <tr data-item-code="02-023-000-0000012" data-pcs-per-box="30">
                                            <td>PLATE FUJI 1055 UV</td>
                                            <td><input type="number" class="form-control form-control-sm incoming-box-input" data-brand="fuji"></td>
                                        </tr>
                                        <tr data-item-code="02-049-000-0000013" data-pcs-per-box="30">
                                            <td>PLATE FUJI 1055 LH-PL</td>
                                            <td><input type="number" class="form-control form-control-sm incoming-box-input" data-brand="fuji"></td>
                                        </tr>
                                        <tr data-item-code="02-049-000-0000009" data-pcs-per-box="15">
                                            <td>PLATE FUJI 1630</td>
                                            <td><input type="number" class="form-control form-control-sm incoming-box-input" data-brand="fuji"></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <h6>Fuji Chemicals</h6>
                            <div class="table-responsive">
                                <table class="table table-bordered" id="fujiChemicalIncomingTable">
                                    <thead>
                                        <tr class="table-info">
                                            <th>Item Name</th>
                                            <th>Jumlah (GLN)</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr data-item-code="02-005-000-0000153">
                                            <td>DEVELOPER FUJI</td>
                                            <td><input type="number" class="form-control form-control-sm chemical-incoming-input" data-brand="fuji"></td>
                                        </tr>
                                        <tr data-item-code="02-005-000-0000154">
                                            <td>REPLENISHER FUJI</td>
                                            <td><input type="number" class="form-control form-control-sm chemical-incoming-input" data-brand="fuji"></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="saphiraContent" class="brand-content" style="display: none;">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Saphira Plates</h6>
                            <div class="table-responsive">
                                <table class="table table-bordered" id="saphiraPlateIncomingTable">
                                    <thead>
                                        <tr class="table-primary">
                                            <th>Item Name</th>
                                            <th>Box</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr data-item-code="02-049-000-0000002" data-pcs-per-box="50">
                                            <td>SAPHIRA 1030</td>
                                            <td><input type="number" class="form-control form-control-sm incoming-box-input" data-brand="saphira"></td>
                                        </tr>
                                        <tr data-item-code="02-049-000-0000003" data-pcs-per-box="50">
                                            <td>SAPHIRA 1055</td>
                                            <td><input type="number" class="form-control form-control-sm incoming-box-input" data-brand="saphira"></td>
                                        </tr>
                                        <tr data-item-code="02-049-000-0000011" data-pcs-per-box="40">
                                            <td>SAPHIRA 1055 PN</td>
                                            <td><input type="number" class="form-control form-control-sm incoming-box-input" data-brand="saphira"></td>
                                        </tr>
                                        <tr data-item-code="02-049-000-0000001" data-pcs-per-box="30">
                                            <td>SAPHIRA 1630</td>
                                            <td><input type="number" class="form-control form-control-sm incoming-box-input" data-brand="saphira"></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <h6>Saphira Chemicals</h6>
                            <div class="table-responsive">
                                <table class="table table-bordered" id="saphiraChemicalIncomingTable">
                                    <thead>
                                        <tr class="table-info">
                                            <th>Item Name</th>
                                            <th>Jumlah (GLN)</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr data-item-code="02-005-000-0000061">
                                            <td>SAPHIRA DEVELOPER</td>
                                            <td><input type="number" class="form-control form-control-sm chemical-incoming-input" data-brand="saphira"></td>
                                        </tr>
                                        <tr data-item-code="02-005-000-0000046">
                                            <td>SAPHIRA REPLENISHER</td>
                                            <td><input type="number" class="form-control form-control-sm chemical-incoming-input" data-brand="saphira"></td>
                                        </tr>
                                        <tr data-item-code="02-005-000-0000158">
                                            <td>SAPHIRA GUM</td>
                                            <td><input type="number" class="form-control form-control-sm chemical-incoming-input" data-brand="saphira"></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                
                <div class="modal fade" id="confirmationModal" tabindex="-1" aria-labelledby="confirmationModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered modal-md"> 
                        <div class="modal-content">
                            <div class="modal-header bg-success text-white"> <h5 class="modal-title" id="confirmationModalLabel"><i class="bi bi-patch-check-fill me-2"></i> Konfirmasi Data Masuk</h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <p class="lead text-center">Mohon periksa kembali data di bawah sebelum menyimpan.</p>
                                
                                <ul class="list-group list-group-flush mb-4 shadow-sm">
                                    <li class="list-group-item d-flex justify-content-between align-items-center bg-light">
                                        <strong>Tanggal:</strong> 
                                        <span id="confirmDate" class="fw-bold text-primary"></span>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        <strong>Shift:</strong> 
                                        <span id="confirmShift" class="fw-bold"></span>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between align-items-center bg-light">
                                        <strong>Brand:</strong> 
                                        <span id="confirmBrand" class="fw-bold text-uppercase badge bg-dark"></span>
                                    </li>
                                </ul>

                                <h6 class="text-secondary mb-3"><i class="bi bi-box-seam me-1"></i> Rincian Item yang Akan Disimpan:</h6>
                                
                                <div class="table-responsive">
                                    <table class="table table-sm table-striped table-hover" id="konfirmasiTable">
                                        <thead>
                                            <tr class="table-dark">
                                                <th>Item</th>
                                                <th class="text-end">Jumlah</th>
                                                <th>Unit</th>
                                            </tr>
                                        </thead>
                                        <tbody id="confirmationTableBody">
                                            </tbody>
                                    </table>
                                </div>
                                
                            </div>
                            <div class="modal-footer justify-content-between">
                                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Batal / Revisi</button>
                                <button type="button" class="btn btn-success" id="confirmSaveButton">
                                    <i class="bi bi-check-circle-fill me-1"></i> Ya, Simpan Data
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
                <button type="button" class="btn btn-primary" onclick="submitIncomingStock()">Simpan</button>
            </div>
        </div>
    </div>
</div>

    <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <div id="liveToast" class="toast border-0 shadow-lg" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-body bg-success text-white rounded">
                <span class="message-text"></span>
                <button type="button" class="btn-close btn-close-white float-end" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        </div>
    </div>

<script src="{{ url_for('static', filename='js/sidebar_handler.js') }}"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="{{ url_for('static', filename='js/notification_system.js') }}"></script>
<script>
    // Inisialisasi modal
    let initialStockModal;
    let incomingStockModal;
    
    document.addEventListener('DOMContentLoaded', function() {
        initialStockModal = new bootstrap.Modal(document.getElementById('initialStockModal'));
        incomingStockModal = new bootstrap.Modal(document.getElementById('incomingStockModal'));
    });

    function showInitialStockModal() {
        // Reset form
        document.getElementById('initialStockDate').value = '';
        document.querySelectorAll('.plate-box-input, .plate-pcs-input, .chemical-input').forEach(input => {
            input.value = '';
        });
        initialStockModal.show();
    }

    function showInputIncomingModal() {
        // Reset form
        document.getElementById('incomingStockDate').value = '';
        document.getElementById('shiftSelect').value = '1';
        document.querySelectorAll('.incoming-box-input, .chemical-incoming-input').forEach(input => {
            input.value = '';
        });
        incomingStockModal.show();
    }

    function submitInitialStock() {
        const date = document.getElementById('initialStockDate').value;
        if (!date) {
            showToast('Tanggal harus diisi', 'error');
            return;
        }

        const stockData = {
            date: date,
            fuji: {
                plates: [],
                chemicals: []
            },
            saphira: {
                plates: [],
                chemicals: []
            }
        };

        // Collect data from Fuji Plate table
        document.querySelectorAll('#fujiPlateTable tr[data-item-code]').forEach(row => {
            const itemCode = row.dataset.itemCode;
            const pcsPerBox = parseInt(row.dataset.pcsPerBox) || 0;
            const boxInput = row.querySelector('.plate-box-input');
            const pcsInput = row.querySelector('.plate-pcs-input');
            
            if (boxInput && pcsInput) {
                const boxValue = parseInt(boxInput.value) || 0;
                const pcsValue = parseInt(pcsInput.value) || 0;
                const totalPcs = (boxValue * pcsPerBox) + pcsValue;
                
                if (totalPcs > 0) {
                    stockData.fuji.plates.push({
                        item_code: itemCode,
                        item_name: row.querySelector('td:first-child').textContent.trim(),
                        jumlah_stock_awal: totalPcs,
                        jumlah_per_box: pcsPerBox
                    });
                }
            }
        });

        // Collect data from Fuji Chemical table
        document.querySelectorAll('#fujiChemicalTable tr[data-item-code]').forEach(row => {
            const itemCode = row.dataset.itemCode;
            const input = row.querySelector('.chemical-input');
            
            if (input) {
                const value = parseInt(input.value) || 0;
                if (value > 0) {
                    stockData.fuji.chemicals.push({
                        item_code: itemCode,
                        item_name: row.querySelector('td:first-child').textContent.trim(),
                        jumlah_stock_awal: value
                    });
                }
            }
        });

        // Collect data from Saphira Plate table
        document.querySelectorAll('#saphiraPlateTable tr[data-item-code]').forEach(row => {
            const itemCode = row.dataset.itemCode;
            const pcsPerBox = parseInt(row.dataset.pcsPerBox) || 0;
            const boxInput = row.querySelector('.plate-box-input');
            const pcsInput = row.querySelector('.plate-pcs-input');
            
            if (boxInput && pcsInput) {
                const boxValue = parseInt(boxInput.value) || 0;
                const pcsValue = parseInt(pcsInput.value) || 0;
                const totalPcs = (boxValue * pcsPerBox) + pcsValue;
                
                if (totalPcs > 0) {
                    stockData.saphira.plates.push({
                        item_code: itemCode,
                        item_name: row.querySelector('td:first-child').textContent.trim(),
                        jumlah_stock_awal: totalPcs,
                        jumlah_per_box: pcsPerBox
                    });
                }
            }
        });

        // Collect data from Saphira Chemical table
        document.querySelectorAll('#saphiraChemicalTable tr[data-item-code]').forEach(row => {
            const itemCode = row.dataset.itemCode;
            const input = row.querySelector('.chemical-input');
            
            if (input) {
                const value = parseInt(input.value) || 0;
                if (value > 0) {
                    stockData.saphira.chemicals.push({
                        item_code: itemCode,
                        item_name: row.querySelector('td:first-child').textContent.trim(),
                        jumlah_stock_awal: value
                    });
                }
            }
        });

        // Send to server
        fetch('/impact/api/input-initial-stock', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(stockData)
        })
        .then(response => {
            if (response.ok) {
                showToast('Stok awal berhasil disimpan', 'success');
                initialStockModal.hide();
                updateData(); // Refresh the main table
            } else {
                throw new Error('Failed to save initial stock', 'danger');
            }
        })
        .catch(error => {
            console.error('Error saving initial stock:', error);
            showToast('Gagal menyimpan stok awal', 'error');
        });
    }

    document.addEventListener('DOMContentLoaded', function() {
        const brandSelect = document.getElementById('brandSelect');
        const fujiContent = document.getElementById('fujiContent');
        const saphiraContent = document.getElementById('saphiraContent');

        let currentStockData = {};

        // Event Listener untuk Brand Dropdown (show/hide)
        brandSelect.addEventListener('change', function() {
            if (this.value === 'fuji') {
                fujiContent.style.display = 'block';
                saphiraContent.style.display = 'none';
            } else if (this.value === 'saphira') {
                fujiContent.style.display = 'none';
                saphiraContent.style.display = 'block';
            }
        });


        // =======================================================
        // FUNGSI 1: MENGIRIM DATA KE SERVER (Dipanggil setelah konfirmasi)
        // =======================================================
        window.processSave = function() {
            const stockData = currentStockData;
            
            // Ambil instance modal konfirmasi
            const confirmationModalInstance = bootstrap.Modal.getInstance(document.getElementById('confirmationModal'));
            // Ambil instance modal input utama
            const inputModalInstance = bootstrap.Modal.getInstance(document.getElementById('incomingStockModal'));

            // Kirim ke server
            fetch('/impact/api/input-incoming-stock', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(stockData)
            })
            .then(response => {
                if (response.ok) {
                    showToast('Stock incoming berhasil disimpan', 'success');
                    
                    // Tutup kedua modal
                    if (confirmationModalInstance) confirmationModalInstance.hide();
                    if (inputModalInstance) inputModalInstance.hide();
                    
                    updateData(); // Refresh main table
                } else {
                    throw new Error('Failed to save incoming stock', 'danger');
                }
            })
            .catch(error => {
                console.error('Error saving incoming stock:', error);
                showToast('Gagal menyimpan stock incoming', 'error');
                // Tutup hanya modal konfirmasi jika gagal, biarkan modal input tetap terbuka untuk perbaikan
                if (confirmationModalInstance) confirmationModalInstance.hide(); 
            });
        }

        // Pasang listener pada tombol 'Ya, Simpan Data' di Modal Konfirmasi
        document.getElementById('confirmSaveButton').addEventListener('click', processSave);


        // =======================================================
        // FUNGSI 2: MEMPROSES INPUT & MENAMPILKAN MODAL KONFIRMASI
        // =======================================================
        window.submitIncomingStock = function() {
            const date = document.getElementById('incomingStockDate').value;
            const shift = document.getElementById('shiftSelect').value;
            const brand = document.getElementById('brandSelect').value;
            
            if (!date) {
                showToast('Tanggal harus diisi', 'error');
                return;
            }

            const stockData = {
                date: date,
                shift: shift,
                fuji: { plates: [], chemicals: [] },
                saphira: { plates: [], chemicals: [] }
            };

            let hasData = false;
            const confirmationItems = []; 

            // --- 1. PROSES PLATES ---
            const platesTableId = (brand === 'fuji') ? '#fujiPlateIncomingTable' : '#saphiraPlateIncomingTable';
            document.querySelectorAll(`${platesTableId} tr[data-item-code]`).forEach(row => {
                const itemCode = row.dataset.itemCode;
                const pcsPerBox = parseInt(row.dataset.pcsPerBox) || 0;
                const boxInput = row.querySelector('.incoming-box-input');
                
                if (boxInput) {
                    const boxValue = parseInt(boxInput.value) || 0;
                    if (boxValue > 0) {
                        hasData = true;
                        const itemName = row.querySelector('td:first-child').textContent.trim();
                        const dataObj = {
                            item_code: itemCode,
                            item_name: itemName,
                            jumlah_incoming: boxValue * pcsPerBox,
                            jumlah_per_box: pcsPerBox
                        };
                        
                        if (brand === 'fuji') {
                            stockData.fuji.plates.push(dataObj);
                        } else {
                            stockData.saphira.plates.push(dataObj);
                        }
                        
                        confirmationItems.push({ name: itemName, amount: boxValue, unit: 'Box' });
                    }
                }
            });

            // --- 2. PROSES CHEMICALS ---
            const chemicalsTableId = (brand === 'fuji') ? '#fujiChemicalIncomingTable' : '#saphiraChemicalIncomingTable';
            document.querySelectorAll(`${chemicalsTableId} tr[data-item-code]`).forEach(row => {
                const itemCode = row.dataset.itemCode;
                const input = row.querySelector('.chemical-incoming-input');
                
                if (input) {
                    const value = parseInt(input.value) || 0;
                    if (value > 0) {
                        hasData = true;
                        const itemName = row.querySelector('td:first-child').textContent.trim();
                        const dataObj = {
                            item_code: itemCode,
                            item_name: itemName,
                            jumlah_incoming: value
                        };
                        
                        if (brand === 'fuji') {
                            stockData.fuji.chemicals.push(dataObj);
                        } else {
                            stockData.saphira.chemicals.push(dataObj);
                        }
                        
                        confirmationItems.push({ name: itemName, amount: value, unit: 'GLN' });
                    }
                }
            });

            if (!hasData) {
                showToast("Tidak ada data yang diinput. Mohon isi minimal satu kolom.", 'error');
                return;
            }

            // Simpan data ke variabel global
            currentStockData = stockData;
            
            // --- 3. TAMPILKAN MODAL KONFIRMASI (SEKARANG BERADA DI DALAM MODAL UTAMA) ---
            
            // Isi detail header
            document.getElementById('confirmDate').textContent = date;
            document.getElementById('confirmShift').textContent = shift;
            document.getElementById('confirmBrand').textContent = brand.toUpperCase();

            // Isi detail tabel
            const tableBody = document.getElementById('confirmationTableBody');
            tableBody.innerHTML = ''; 
            
            confirmationItems.forEach(item => {
                const row = tableBody.insertRow();
                row.insertCell().textContent = item.name;
                row.insertCell().textContent = item.amount;
                row.insertCell().textContent = item.unit;
            });

            // Tampilkan modal
            // Karena modal konfirmasi berada di dalam modal input, ia akan muncul di atas modal input.
            const confirmationModal = new bootstrap.Modal(document.getElementById('confirmationModal'));
            confirmationModal.show();
        }
    });

    // Format tanggal dalam bahasa Indonesia
    const namaHari = ['Minggu', 'Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'];
    const namaBulan = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];

    function formatTanggal(date) {
        const hari = namaHari[date.getDay()];
        const tanggal = date.getDate();
        const bulan = namaBulan[date.getMonth()];
        const tahun = date.getFullYear();
        return `${hari}, ${tanggal} ${bulan} ${tahun}`;
    }

    // Set tanggal hari ini sebagai default
    window.onload = function() {
        const today = new Date();
        document.getElementById('stockDate').value = today.toISOString().split('T')[0];
        updateData();
    }

    // Show loading spinner function
    function showLoading() {
        const spinner = document.createElement('div');
        spinner.classList.add('spinner-overlay');
        spinner.innerHTML = `
            <div class="spinner-content">
                <div class="spinner-border text-primary mb-2" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <div>Loading data...</div>
            </div>
        `;
        document.body.appendChild(spinner);
    }

    // Hide loading spinner function
    function hideLoading() {
        const spinner = document.querySelector('.spinner-overlay');
        if (spinner) {
            spinner.remove();
        }
    }

    // Add this helper function
    function formatShift(shift) {
        return `Shift ${shift}`;
    }

    // Update the updateData function
    function updateData() {
        const selectedDate = new Date(document.getElementById('stockDate').value);
        const selectedShift = document.getElementById('shiftFilter').value;
        const formattedDate = formatTanggal(selectedDate);
        const formattedShift = formatShift(selectedShift);

        // Update tanggal dan shift display
        document.getElementById('fujiDateDisplay').textContent = formattedDate;
        document.getElementById('saphiraDateDisplay').textContent = formattedDate;
        document.getElementById('fujiShiftDisplay').textContent = formattedShift;
        document.getElementById('saphiraShiftDisplay').textContent = formattedShift;

        // Show loading spinner
        showLoading();

        // Ambil data dari server
        fetchStockData(selectedDate, selectedShift);
}

    // Fungsi untuk mengambil data stok dari server
    async function fetchStockData(date, shift) {
        try {
            const response = await fetch(`/impact/api/kartu-stock?date=${date.toISOString().split('T')[0]}&shift=${shift}`);
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            const data = await response.json();
            
            if (data.error) {
                throw new Error(data.error);
            }
            
            updateTables(data);
        } catch (error) {
            console.error('Error fetching stock data:', error);
            if (error instanceof TypeError) {
                // Handle specific type errors more gracefully
                showToast('Struktur data stok tidak sesuai. Mohon hubungi administrator.', 'error');
            } else {
                showToast('Gagal mengambil data stok: ' + (error.message || 'Unknown error', 'error'));
            }
            
            // Set default empty state for tables
            const emptyData = {
                fuji: {
                    plate: { data: [] },
                    chemical: { data: [] }
                },
                saphira: {
                    plate: { data: [] },
                    chemical: { data: [] }
                }
            };
            updateTables(emptyData);
        } finally {
            // Hide loading spinner
            hideLoading();
        }
    }

    // Confirmation functions removed

    // Update tabel dengan data dari server
    function updateTables(data) {
        // Update all tables
        updateTableData('kartuStockPlateFujiTable', data.fuji.plate.data);
        updateTableData('kartuStockChemicalFujiTable', data.fuji.chemical.data);
        updateTableData('kartuStockPlateSaphiraTable', data.saphira.plate.data);
        updateTableData('kartuStockChemicalSaphiraTable', data.saphira.chemical.data);
        
        // Update stock alert info
        updateStockAlertInfo();
    }

    // Function to update the stock alert info section
    function updateStockAlertInfo() {
        const fujiLowStockList = document.getElementById('fujiLowStockList');
        const saphiraLowStockList = document.getElementById('saphiraLowStockList');
        const noLowStockMessage = document.getElementById('noLowStockMessage');
        const alertDiv = document.getElementById('stockAlertInfo');
        
        // PENTING: Mengosongkan UL list
        fujiLowStockList.innerHTML = '';
        saphiraLowStockList.innerHTML = '';
        let hasLowStock = false;

        // Fungsi helper untuk membuat Badge
        const createLowStockBadge = (itemName, listElement) => {
            hasLowStock = true;
            const badge = document.createElement('span'); 
            
            // GANTI: me-2 mb-1 p-2 fw-bold 
            // DENGAN: me-2 mb-1 p-2 fw-bolder badge-lg 
            // (Tambahkan p-2 untuk padding yang lebih tebal dan fw-bolder)
            badge.className = 'badge text-bg-danger me-2 mb-1 p-2 fw-bolder badge-lg'; 
            badge.textContent = itemName;

            listElement.appendChild(badge);
            listElement.appendChild(document.createTextNode(' ')); 
        };

        // Check FUJI plates
        document.querySelectorAll('#kartuStockPlateFujiTable tbody tr').forEach(row => {
            const itemName = row.querySelector('td').textContent.trim();
            const stockBox = parseInt(row.querySelector('[data-field="jumlah_stock_akhir_box"]').textContent);
            if (minimumStock[itemName] && stockBox <= minimumStock[itemName].box) {
                createLowStockBadge(itemName, fujiLowStockList);
            }
        });

        // Check FUJI chemicals
        document.querySelectorAll('#kartuStockChemicalFujiTable tbody tr').forEach(row => {
            const itemName = row.querySelector('td').textContent.trim();
            const stockGln = parseInt(row.querySelector('[data-field="jumlah_stock_akhir"]').textContent);
            if (minimumStock[itemName] && stockGln <= minimumStock[itemName].amount) {
                createLowStockBadge(itemName, fujiLowStockList);
            }
        });

        // Check SAPHIRA plates
        document.querySelectorAll('#kartuStockPlateSaphiraTable tbody tr').forEach(row => {
            const itemName = row.querySelector('td').textContent.trim();
            const stockBox = parseInt(row.querySelector('[data-field="jumlah_stock_akhir_box"]').textContent);
            if (minimumStock[itemName] && stockBox <= minimumStock[itemName].box) {
                createLowStockBadge(itemName, saphiraLowStockList);
            }
        });

        // Check SAPHIRA chemicals
        document.querySelectorAll('#kartuStockChemicalSaphiraTable tbody tr').forEach(row => {
            const itemName = row.querySelector('td').textContent.trim();
            const stockGln = parseInt(row.querySelector('[data-field="jumlah_stock_akhir"]').textContent);
            if (minimumStock[itemName] && stockGln <= minimumStock[itemName].amount) {
                createLowStockBadge(itemName, saphiraLowStockList);
            }
        });

        // Show/hide elements based on stock status
        if (hasLowStock) {
            // KONDISI KRITIS (LOW STOCK)
            alertDiv.classList.remove('alert-success', 'alert-warning'); // Pastikan menghapus semua yang 'aman'
            alertDiv.classList.add('alert-danger'); 
            document.getElementById('lowStockItems').style.display = 'flex';
            noLowStockMessage.style.display = 'none';
            
            // ... (kode yang sudah ada untuk title dan icon)
            const alertTitle = document.querySelector('#stockAlertInfo .alert-title');
            const alertIcon = document.querySelector('#stockAlertInfo i'); 
            
            if (alertTitle) {
                alertTitle.textContent = 'PERHATIAN! Stok Item Kritis';
            }
            if (alertIcon) {
                alertIcon.className = 'fas fa-exclamation-circle me-2'; // Menggunakan lingkaran untuk Danger
            }
            
        } else {
            // KONDISI AMAN (TIDAK ADA LOW STOCK)
            alertDiv.classList.remove('alert-danger', 'alert-warning'); // Hapus kedua kelas kritis
            alertDiv.classList.add('alert-success'); // Terapkan Success
            
            document.getElementById('lowStockItems').style.display = 'none';
            noLowStockMessage.style.display = 'block';

            const alertTitle = document.querySelector('#stockAlertInfo .alert-title');
            const alertIcon = document.querySelector('#stockAlertInfo i');

            if (alertTitle) {
                alertTitle.textContent = 'Status Stock Aman';
            }
            if (alertIcon) {
                alertIcon.className = 'fas fa-check-circle me-2'; // Tanda centang untuk Aman
            }
        }
    }

    // Define minimum stock levels and their exact table names
    const minimumStock = {
        'FUJI 1030': { box: 9, type: 'plate' },
        'FUJI 1030 LHPJA': { box: 2, type: 'plate' },        
        'FUJI 1030 UV': { box: 2, type: 'plate' },
        'FUJI 1055': { box: 9, type: 'plate' },
        'FUJI 1055 UV': { box: 2, type: 'plate' },
        'FUJI 1055 LHPL': { box: 2, type: 'plate' },
        'FUJI 1630': { box: 12, type: 'plate' },
        'FUJI DEVELOPER': { amount: 8, type: 'chemical' },
        'FUJI REPLENISHER': { amount: 8, type: 'chemical' },
        'SAPHIRA 1030': { box: 7, type: 'plate' },
        'SAPHIRA 1055': { box: 7, type: 'plate' },
        'SAPHIRA 1055 PN': { box: 4, type: 'plate' },
        'SAPHIRA 1630': { box: 6, type: 'plate' },
        'SAPHIRA DEVELOPER': { amount: 8, type: 'chemical' },
        'SAPHIRA REPLENISHER': { amount: 8, type: 'chemical' },
        'SAPHIRA GUM': { amount: 10, type: 'chemical' }
    };

    function updateTableData(tableId, data) {
        const table = document.getElementById(tableId);
        const rows = table.getElementsByTagName('tbody')[0].getElementsByTagName('tr');

        for (let row of rows) {
            const itemCode = row.getAttribute('data-item-code');
            const itemData = data.find(item => item.item_code === itemCode);
            
            if (itemData) {
                const firstCell = row.querySelector('td');
                const itemName = firstCell.textContent.trim();
                
                // 1. Bersihkan ikon peringatan yang sudah ada (untuk mencegah duplikasi)
                const existingIcon = firstCell.querySelector('.fa-exclamation-triangle');
                if (existingIcon) {
                    existingIcon.remove();
                }

                // Hapus kelas low-stock yang sudah ada
                row.classList.remove('low-stock');

                // =======================================================
                // 2. KONSISTENSI PENGECUALIAN STOCK DAN PENAMBAHAN IKON
                // =======================================================
                let isLowStock = false;
                
                if (minimumStock[itemName]) {
                    if (minimumStock[itemName].type === 'plate') {
                        const stockBox = parseInt(itemData.jumlah_stock_akhir_box) || 0;
                        if (stockBox <= minimumStock[itemName].box) {
                            isLowStock = true;
                        }
                    } else if (minimumStock[itemName].type === 'chemical') {
                        const stockGln = parseInt(itemData.jumlah_stock_akhir) || 0;
                        if (stockGln <= minimumStock[itemName].amount) {
                            isLowStock = true;
                        }
                    }
                }
                
                // =======================================================
                // 3. RESTRUKTURISASI firstCell UNTUK PENEMPATAN IKON YANG LEBIH BAIK
                // =======================================================
                // Kosongkan firstCell dan tambahkan teks itemname kembali
                firstCell.innerHTML = itemName; 
                
                if (isLowStock) {
                    const warningIcon = document.createElement('i');
                    warningIcon.className = 'fas fa-exclamation-triangle text-warning'; // Tetap tanpa ms-2
                    warningIcon.title = 'Stock di bawah level minimum!';
                    
                    // Tambahkan ikon langsung setelah teks dalam firstCell
                    firstCell.appendChild(warningIcon);
                    row.classList.add('low-stock');
                }
                // =======================================================
                // 4. UPDATE DATA TABEL (sisanya sama)
                // =======================================================

                // Handle plate tables
                if (tableId === 'kartuStockPlateFujiTable' || tableId === 'kartuStockPlateSaphiraTable') {
                    row.querySelector('[data-field="jumlah_stock_awal_box"]').textContent = itemData.jumlah_stock_awal_box || '0';
                    row.querySelector('[data-field="jumlah_stock_awal_pcs"]').textContent = itemData.jumlah_stock_awal_pcs || '0';
                    row.querySelector('[data-field="jumlah_pemakaian"]').textContent = parseInt(itemData.jumlah_pemakaian) || '0';
                    row.querySelector('[data-field="jumlah_incoming"]').textContent = parseInt(itemData.jumlah_incoming) || '0';
                    row.querySelector('[data-field="jumlah_stock_akhir_box"]').textContent = itemData.jumlah_stock_akhir_box || '0';
                    row.querySelector('[data-field="jumlah_stock_akhir_pcs"]').textContent = itemData.jumlah_stock_akhir_pcs || '0';
                    row.querySelector('[data-field="jumlah_stock_akhir"]').textContent = itemData.jumlah_stock_akhir || '0';
                }
                else if (tableId === 'kartuStockChemicalFujiTable' || tableId === 'kartuStockChemicalSaphiraTable') {
                    for (let cell of row.getElementsByTagName('td')) {
                        const field = cell.getAttribute('data-field');
                        if (field && itemData[field] !== undefined) {
                            cell.textContent = parseInt(itemData[field]) || 0;
                        }
                    }
                }
            }
        }
    }

    // Toast notification function
        function showToast(message, type = 'info') {
            const toast = document.getElementById('liveToast');
            const messageText = toast.querySelector('.message-text');
            const toastBody = toast.querySelector('.toast-body');
            
            messageText.textContent = message;
            
    // Reset classes
            toastBody.className = 'toast-body rounded';
            
    // Apply type-specific styling
            switch(type) {
                case 'success':
                    toastBody.classList.add('bg-success', 'text-white');
                    break;
                case 'warning':
                    toastBody.classList.add('bg-warning', 'text-dark');
                    break;
                case 'error':
                    toastBody.classList.add('bg-danger', 'text-white');
                    break;
                default:
                    toastBody.classList.add('bg-info', 'text-white');
            }
            
            const bsToast = new bootstrap.Toast(toast);
            bsToast.show();
        }   

    // Fungsi untuk menampilkan modal export
    function showExportModal() {
        // Implementasi modal export
        // Akan diimplementasikan sesuai kebutuhan
    }
</script>
</body>
</html>